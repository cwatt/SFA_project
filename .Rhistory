theme_test() +
labs(y="16S copy number (ln)", x="") +
theme(axis.text = element_text(size = 10),
axis.title = element_text(size = 12))
# Below baked into definition, so not super informative but good to know
# Length
growth_grp %>%
mutate(length=end_day-start_day) %>%
ggplot(aes(x=group, y=length)) +
geom_boxplot() +
geom_jitter(size=2, alpha=0.5) +
theme_test() +
labs(y="length of growth", x="") +
theme(axis.text = element_text(size = 10),
axis.title = element_text(size = 12))
# k
k_lmer <- lmer(k ~ group + (1 + Inoculant | Inoculant), growth_grp)
hist(resid(k_lmer))
plot(predict(k_lmer), resid(k_lmer))
anova(k_lmer)
# change abund
chg_lmer <- lmer(log(change_abund_corr) ~ group + (1 + Inoculant | Inoculant), growth_grp)
hist(resid(chg_lmer))
plot(predict(chg_lmer), resid(chg_lmer))
anova(chg_lmer)
# 16S
n16s_lmer <- lmer(log(n16S) ~ group + (1 + Inoculant | Inoculant), growth_grp)
hist(resid(n16s_lmer))
plot(predict(n16s_lmer), resid(n16s_lmer)) # heteroskedastic
# Welch t-test
t.test(log(n16S) ~ group, data=growth_grp)
# length
growth_grp <- mutate(growth_grp, length = end_day-start_day)
length_lmer <- lmer(log(length) ~ group + (1 + Inoculant | Inoculant), growth_grp)
hist(resid(length_lmer))
plot(predict(length_lmer), resid(length_lmer))
anova(length_lmer)
# Average ASVs across inoculant (independence issue)
growth_grp_avg <- growth_grp %>%
group_by(ASV, group) %>%
summarize(k = mean(k),
length = mean(length),
change_abund_corr = mean(change_abund_corr)) %>%
ungroup()
growth_grp_avg %>%
ggplot(aes(x=length, y=log(change_abund_corr))) + #, color=group
geom_point() +
geom_smooth(method="lm") + #, aes(group=group)
theme_test()
growth_grp_avg %>%
ggplot(aes(x=length, y=log(change_abund_corr), color=group)) +
geom_point() +
geom_smooth(method="lm", aes(group=group)) +
theme_test()
# All
cor.test(growth_grp_avg$length, log(growth_grp_avg$change_abund_corr), method="pearson")
# Group 2 only
cor.test(growth_grp_avg[growth_grp_avg$group=="grp2",]$length, log(growth_grp_avg[growth_grp_avg$group=="grp2",]$change_abund_corr), method="pearson")
growth_grp_avg %>%
ggplot(aes(x=k, y=log(change_abund_corr))) + #, color=group
geom_point() +
geom_smooth(method="lm") + #, aes(group=group)
theme_test()
growth_grp_avg %>%
ggplot(aes(x=k, y=log(change_abund_corr), color=group)) +
geom_point() +
geom_smooth(method="lm", aes(group=group)) +
theme_test()
# All
cor.test(growth_grp_avg$k, log(growth_grp_avg$change_abund_corr), method="pearson")
# Group 2 only
cor.test(growth_grp_avg[growth_grp_avg$group=="grp2",]$k, log(growth_grp_avg[growth_grp_avg$group=="grp2",]$change_abund_corr), method="pearson")
# k
death_grp %>%
ggplot(aes(x=group, y=k)) +
geom_boxplot() +
geom_jitter(size=2, alpha=0.5) +
theme_test() +
labs(y="Death rate (day-1)", x="") +
theme(axis.text = element_text(size = 10),
axis.title = element_text(size = 12))
# change in abundance
death_grp %>%
ggplot(aes(x=group, y=log(abs(change_abund_corr)))) +
geom_boxplot() +
geom_jitter(size=2, alpha=0.5) +
theme_test() +
theme(axis.text = element_text(size = 12),
axis.title = element_text(size = 15)) +
labs(y="Normalized abundance change (ln abs. value)", x="")
# n16S
death_grp %>%
ggplot(aes(x=group, y=n16S)) +
geom_boxplot() +
geom_jitter(size=2, alpha=0.5) +
theme_test() +
theme(axis.text = element_text(size = 12),
axis.title = element_text(size = 15)) +
labs(y="16S copy numbers", x="")
# k
kdeath_lmer <- lmer(log(abs(k)) ~ group + (1 + Inoculant | Inoculant), death_grp)
hist(resid(kdeath_lmer))
plot(predict(kdeath_lmer), resid(kdeath_lmer))
anova(kdeath_lmer)
# change abund
chgdeath_lmer <- lmer(log(abs(change_abund_corr)) ~ group + (1 + Inoculant | Inoculant), death_grp)
hist(resid(chgdeath_lmer))
plot(predict(chgdeath_lmer), resid(chgdeath_lmer))
anova(chgdeath_lmer)
# n16S
n16S_lmer <- lmer(n16S ~ group + (1 + Inoculant | Inoculant), death_grp)
hist(resid(chgdeath_lmer))
plot(predict(chgdeath_lmer), resid(chgdeath_lmer))
anova(chgdeath_lmer)
# Prepare data
growth_slim <- growth %>%
select(Inoculant, ASV, slope, yint, k, g, start_day, end_day, n16S)
death_slim <- death %>%
select(Inoculant, ASV, slope, yint, k, h, start_day, end_day, n16S)
# Impute values for start and end of growth/death based on linear estimate
# Growth
imputed_deltaNg <- growth_slim %>%
mutate(group = if_else(start_day < 9 & end_day <= 9, "group 1", "group 2"), # label group
impute_expstart = if_else(group=="group 1", slope*start_day+yint, # impute ln abund
if_else(group=="group 2" & start_day < 9,
slope*start_day+yint, NULL)),
impute_expend = if_else(group=="group 1", slope*end_day+yint,
if_else(group=="group 2" & start_day < 9 & end_day >= 9,
slope*9+yint, NULL)),
impute_statstart = if_else(group=="group 2" & start_day <= 9, slope*9+yint,
if_else(group=="group 2" & start_day > 9,
slope*start_day+yint, NULL)),
impute_statend = if_else(group=="group 2", slope*end_day+yint, NULL),
# Un-ln and correct for n16S
expstart_corr = exp(impute_expstart)/n16S,
expend_corr = exp(impute_expend)/n16S,
statstart_corr = exp(impute_statstart)/n16S,
statend_corr = exp(impute_statend)/n16S,
exp_deltaN = expend_corr - expstart_corr,
stat_deltaN = statend_corr - statstart_corr) %>%
select(Inoculant:group, exp_deltaN, stat_deltaN) %>%
group_by(Inoculant) %>%
summarize(exp = sum(exp_deltaN, na.rm = TRUE),
stat = sum(stat_deltaN, na.rm=TRUE)) %>%
pivot_longer(-Inoculant, names_to = "phase", values_to = "deltaN") %>%
add_column(type="growth")
# Death
imputed_deltaNd <- death_slim %>%
mutate(group = if_else(start_day < 9 & end_day <= 9, "group 1", "group 2"), # label group
impute_expstart = if_else(group=="group 1", slope*start_day+yint, # impute ln abund
if_else(group=="group 2" & start_day < 9,
slope*start_day+yint, NULL)),
impute_expend = if_else(group=="group 1", slope*end_day+yint,
if_else(group=="group 2" & start_day < 9 & end_day >= 9,
slope*9+yint, NULL)),
impute_statstart = if_else(group=="group 2" & start_day <= 9, slope*9+yint,
if_else(group=="group 2" & start_day > 9,
slope*start_day+yint, NULL)),
impute_statend = if_else(group=="group 2", slope*end_day+yint, NULL),
# Un-ln and correct for n16S
expstart_corr = exp(impute_expstart)/n16S,
expend_corr = exp(impute_expend)/n16S,
statstart_corr = exp(impute_statstart)/n16S,
statend_corr = exp(impute_statend)/n16S,
exp_deltaN = expend_corr - expstart_corr,
stat_deltaN = statend_corr - statstart_corr) %>%
select(Inoculant:group, exp_deltaN, stat_deltaN) %>%
group_by(Inoculant) %>%
summarize(exp = abs(sum(exp_deltaN, na.rm = TRUE)),
stat = abs(sum(stat_deltaN, na.rm=TRUE))) %>%
pivot_longer(-Inoculant, names_to = "phase", values_to = "deltaN") %>%
add_column(type="death")
# Combine growth and death
imputed_deltaN <- bind_rows(imputed_deltaNg, imputed_deltaNd)
imputed_deltaN %>%
group_by(phase, type) %>%
summarize(deltaN = mean(deltaN))
imputed_deltaN %>%
ggplot(aes(x=phase, y=log(deltaN), color=type)) +
#geom_point() +
geom_boxplot() +
theme_test()
# Prepare data
dan_df <- norm %>% # norm. abundance data
filter(Type=="Growth" & norm_abund!=0) %>% # filter samples and remove non-present taxa
select(Inoculant, Day, Replicate, ASV, norm_abund) %>%
group_by(Inoculant, Day, ASV) %>% # average replicates
summarize(norm_abund_avg = mean(norm_abund)) %>%
inner_join(growth_slim) %>% # add growth estimates
mutate(norm_abund_corr = norm_abund_avg/n16S) %>%  # correct normalized abundance
select(Inoculant, Day, ASV, start_day, end_day, g, norm_abund_corr) %>%
ungroup() %>%
mutate(group = if_else(start_day < 9 & end_day <= 9, "group 1", "group 2")) %>% # group
mutate(phase = if_else(Day <= 9, "exponential", "stationary"), # label phase
length = end_day - start_day, # calculate length of growth
label = paste0(Inoculant, phase, "_", ASV)) %>% # unique label
group_by(label, Inoculant, ASV, phase, g, start_day, length) %>%
summarize(norm_abund_corr = mean(norm_abund_corr)) %>% # average ASV abundance per phase
ungroup()
# Calculate relative abundances
inoc_totals <- dan_df %>%
group_by(Inoculant, phase) %>%
summarize(norm_abund_total = sum(norm_abund_corr)) %>%
ungroup()
dan_df2 <- data.frame()
for (l in unique(dan_df$label)) {
data_sub <- filter(dan_df, label==l)
relabund <- data_sub$norm_abund_corr/filter(inoc_totals, Inoculant==data_sub$Inoculant & phase==data_sub$phase)$norm_abund_total
this_row <- bind_cols(Inoculant=data_sub$Inoculant, ASV=data_sub$ASV,
phase=data_sub$phase, g=data_sub$g, lag=data_sub$start_day,
length=data_sub$length,
mean_abund=data_sub$norm_abund_corr, relabund=relabund)
dan_df2 <- bind_rows(dan_df2, this_row)
}
# Add taxonomy
tax <- read_rds("../data_intermediate/SFA2_taxonomy.rds")
dan_df2 <- left_join(dan_df2, tax)
plot1 <- norm_growth_total %>%
add_row(norm_growth_avg) %>%
mutate(fade = if_else(Inoculant!="avg", "avg", "inoc")) %>%
ggplot(aes(x=Day, y=log(total), group=Inoculant, alpha=fade)) +
geom_point() +
geom_line() +
geom_vline(xintercept=9, linetype=2) +
coord_cartesian(xlim = c(0, 30)) +
theme_test() +
theme(axis.text = element_text(size=10),
axis.title = element_blank())
plot1
plot2 <- norm_grps_ex %>%
ggplot(aes(x=Day, y=log(norm_abund_avg))) +
geom_point(aes(shape=group), size=2) +
geom_line(aes(group=group)) +
geom_vline(xintercept=9, linetype=2) +
geom_smooth(method="lm", data=norm_grp1_ex[growth_grp1_ex$start_pt:growth_grp1_ex$end_pt,], linetype=2, color="#444444", alpha=0.3) +
geom_smooth(method="lm", data=norm_grp2_ex[growth_grp2_ex$start_pt:growth_grp2_ex$end_pt,], linetype=2, color="#444444", alpha=0.3) +
coord_cartesian(xlim = c(0, 30)) +
theme_test() +
theme(axis.text = element_text(size=10),
axis.title = element_blank())
plot2
plot_comb12 <- plot_grid(plot1, plot2, nrow=2)
plot_comb12
# growth k
plot3 <- growth_grp %>%
ggplot(aes(x=group, y=k)) +
geom_boxplot() +
geom_jitter(alpha=0.5) +
#labs(title="plot3") +
theme_test() +
theme(axis.text.x = element_blank(),
axis.text.y = element_text(size=10),
axis.title = element_blank())
plot3
# growth change in abundance
plot4 <- growth_grp %>%
ggplot(aes(x=group, y=log(change_abund_corr))) +
geom_boxplot() +
geom_jitter(alpha=0.5) +
#labs(title="plot4") +
theme_test() +
theme(axis.text.x = element_blank(),
axis.text.y = element_text(size=10),
axis.title = element_blank())
plot4
# death k
plot5 <- death_grp %>%
ggplot(aes(x=group, y=k)) +
geom_boxplot() +
geom_jitter(alpha=0.5) +
#labs(title="plot5") +
theme_test() +
theme(axis.text.x = element_blank(),
axis.text.y = element_text(size=10),
axis.title = element_blank())
plot5
# change in abundance
plot6 <- death_grp %>%
ggplot(aes(x=group, y=log(abs(change_abund_corr)))) +
geom_boxplot() +
geom_jitter(alpha=0.5) +
#labs(title="plot6") +
theme_test() +
theme(axis.text = element_text(size = 10)) +
theme(axis.text.x = element_blank(),
axis.text.y = element_text(size=10),
axis.title = element_blank())
plot6
plot_comb36 <- plot_grid(plot3, plot5, plot4, plot6, nrow=2)
plot_comb36
# Comgroupe whole and growing only data averages
norm_whole_avg <- add_column(type="whole", norm_whole_avg)
norm_growth_avg <- add_column(type="growth", norm_growth_avg)
norm_avg <- bind_rows(norm_whole_avg, norm_growth_avg)
# Total averaged abundances by phase, compraing whole to growing
norm_avg %>%
mutate(phase = if_else(Day <= 9, "exp", "stat")) %>%
group_by(phase, type) %>%
summarize(total = mean(total))
supp1 <- norm_avg %>%
mutate(type = as_factor(type),
type = fct_relevel(type, c("whole", "growth"))) %>%
ggplot(aes(x=Day, y=log(total), shape=type)) +
geom_point(size=3) +
geom_line(aes(group=type, linetype=type)) +
labs(y="Total relational abundnace (ln avg)") +
theme_test()
supp1
count <-  0
for (l in as.character(growth_grp3$label)) {
# Subset time series
count <- count+1
growth_label <- filter(growth_grp3, label==l)
norm_label <- filter(norm_grp3_prep, label==l) %>%
arrange(Day)
# Title information
asv <- growth_label$ASV
tax_info <- filter(tax_grp3, ASV == asv)
title <- paste0(tax_info$Phylum, ", ", tax_info$Genus)
# Graph with estimate
graph <- ggplot(norm_label, aes(x=Day, y=norm_abund_ln)) +
geom_point(shape=1, size=3, color="#6F7378") +
geom_line(color="#6F7378") +
geom_smooth(method="lm", data=norm_label[growth_label$start_pt:growth_label$end_pt,], linetype=2, color="black") +
scale_x_continuous(limits=c(0,30)) +
theme_test() +
theme(title = element_text(size=12),
axis.title = element_blank(),
axis.text = element_text(size=10))
print(graph)
assign(paste0("plot", count, "_grp3"), graph)
}
supp_grp3 <- plot_grid(plot1_grp3, plot2_grp3, plot3_grp3, plot4_grp3, plot5_grp3, plot6_grp3, nrow=2)
supp_grp3
plot_lt <- growth_grp %>%
mutate(length=end_day-start_day) %>%
ggplot(aes(x=group, y=length)) +
geom_boxplot() +
geom_jitter(size=2, alpha=0.5) +
theme_test() +
theme(title = element_text(size=12),
axis.title = element_blank(),
axis.text = element_text(size=10),
legend.position = "none")
plot_lt
grp_colors <- c(grp1="#5b5b5b", grp2="black")
plot_length1 <- growth_grp_avg %>%
ggplot(aes(x=length, y=log(change_abund_corr))) +
geom_point(aes(color=group, shape=group)) +
geom_smooth(method="lm", linetype=2, color="black", alpha=0.5) +
scale_color_manual(values=grp_colors) +
theme_test() +
theme(title = element_text(size=12),
axis.title = element_blank(),
axis.text = element_text(size=10),
legend.position = "none")
plot_length1
plot_length2 <- growth_grp_avg %>%
ggplot(aes(x=length, y=log(change_abund_corr), color=group, shape=group)) +
geom_point() +
geom_smooth(method="lm", linetype=2, alpha=0.5, aes(group=group)) +
scale_color_manual(values=grp_colors) +
theme_test() +
theme(title = element_text(size=12),
axis.title = element_blank(),
axis.text = element_text(size=10),
legend.position = "none")
plot_length2
plot_k1 <- growth_grp %>%
ggplot(aes(x=k, y=log(change_abund_corr))) +
geom_point(aes(color=group, shape=group)) +
geom_smooth(method="lm", linetype=2, alpha=0.5, color="black") +
scale_color_manual(values=grp_colors) +
theme_test() +
theme(title = element_text(size=12),
axis.title = element_blank(),
axis.text = element_text(size=10),
legend.position = "none")
plot_k1
plot_k2 <- growth_grp %>%
ggplot(aes(x=k, y=log(change_abund_corr), color=group, shape=group)) +
geom_point() +
geom_smooth(method="lm", linetype=2, alpha=0.5, aes(group=group)) +
scale_color_manual(values=grp_colors) +
theme_test() +
theme(title = element_text(size=12),
axis.title = element_blank(),
axis.text = element_text(size=10),
legend.position = "none")
plot_k2
# Combine
plot_lengthk <- plot_grid(plot_length1,  plot_k1, plot_length2, plot_k2, nrow=2)
plot_lengthk
plotx <- imputed_deltaN %>%
mutate(phase2 = if_else(phase=="exp", "Exponential", "Stationary"),
type2 = if_else(type=="death", "Death", "Growth")) %>%
ggplot(aes(x=phase2, y=log(deltaN))) +
geom_boxplot() +
theme_test() +
facet_wrap(~type2) +
theme_test() +
theme(title = element_text(size=12),
axis.title = element_blank(),
axis.text = element_text(size=10))
plotx
ggsave("../figures/fig_deltaexpstat.svg", plotx, height=120, width=210, units="mm", device="svg")
head(growth_grp)
head(pap_all)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
# Clear working directory, load in packages, generate package info
rm(list=ls())
library("phyloseq")
library("vegan")
library("tidyverse")
library("lmerTest")
library("cowplot")
sessionInfo()
# I can't type "head" apparently so I'm going to make an alias
h <- function(x) {head(x)}
# Metadata
meta <- readRDS("../data_intermediate/SFA2_metadata.rds")
# Growth estimates
growth <- readRDS("../data_intermediate/SFA2_growth_estimates_pap2.rds")
# Death estimates
death <- readRDS("../data_intermediate/SFA2_death_estimates_pap2.rds")
# All paprica estimates
pap_all <- readRDS("../data_intermediate/SFA2_paprica_all.rds")
head(growth)
head9death
head(death)
growth_death <- growth %>%
select(Inoculant, ASV, gr_k=k, deltaNg=change_abund_corr) %>%
inner_join(death) %>%
select(Inocualnt, ASV, gr_k, de_k=k, deltaNg, deltaNd=change_abund_corr)
growth_death <- growth %>%
select(Inoculant, ASV, gr_k=k, deltaNg=change_abund_corr) %>%
inner_join(death) %>%
select(Inoculant, ASV, gr_k, de_k=k, deltaNg, deltaNd=change_abund_corr)
head(growth_death)
nrow(growth_death)
growth_death <- growth %>%
select(Inoculant, ASV, gr_k=k, deltaNg=change_abund_corr) %>%
inner_join(death) %>%
select(Inoculant, ASV, gr_k, de_k=k, deltaNg, deltaNd=change_abund_corr) %>%
group_by(ASV) %>% # average ASVs across inoculant (for independence)
summarize(gr_k = mean(gr_k),
de_k = mean(de_k),
deltaNg = mean(deltaNg),
deltaNd = mean(deltaNd))
head(growth_death)
nrow(growth_death)
growth_death %>%
ggplot(aes(x=gr_k, y=de_k)) +
geom_point() +
theme_test()
# deltaN
growth_death %>%
ggplot(aes(x=deltaNg, y=deltaNd)) +
geom_point() +
theme_test()
# deltaN
growth_death %>%
ggplot(aes(x=log(deltaNg), y=log(deltaNd))) +
geom_point() +
theme_test()
# deltaN
growth_death %>%
ggplot(aes(x=log(deltaNg), y=log(abs(deltaNd)))) +
geom_point() +
theme_test()
# deltaN
growth_death %>%
ggplot(aes(x=log(deltaNg), y=log(abs(deltaNd)))) +
geom_point() +
geom_smooth(method="lm", linetype=2) +
theme_test()
# deltaN
growth_death %>%
ggplot(aes(x=log(deltaNg), y=log(abs(deltaNd)))) +
geom_point() +
geom_smooth(method="lm", linetype=2) +
theme_test() +
theme(axis.text = element_text(size=10),
axis.title = element_blank())
# deltaN
growth_death %>%
ggplot(aes(x=log(deltaNg), y=log(abs(deltaNd)))) +
geom_point() +
geom_smooth(method="lm", linetype=2, color="black") +
theme_test() +
theme(axis.text = element_text(size=10),
axis.title = element_blank())
# deltaN
growth_death %>%
ggplot(aes(x=log(deltaNg), y=log(abs(deltaNd)))) +
geom_point() +
geom_smooth(method="lm", linetype=2, color="gray") +
theme_test() +
theme(axis.text = element_text(size=10),
axis.title = element_blank())
# deltaN
growth_death %>%
ggplot(aes(x=log(deltaNg), y=log(abs(deltaNd)))) +
geom_point() +
geom_smooth(method="lm", linetype=2, color="darkgray") +
theme_test() +
theme(axis.text = element_text(size=10),
axis.title = element_blank())
cor.test(log(growth_death$deltaNg), log(growth_death$deltaNd), data=growth_death)
cor.test(log(growth_death$deltaNg), log(abs(growth_death$deltaNd)), data=growth_death)
