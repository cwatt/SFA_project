---
title: "SFA2 - CO2 data analysis"
author: "Cassandra Wattenburger"
date: "10/7/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

```{r}
library(tidyverse)
library(cowplot)

sessionInfo()

rm(list=ls())
```

# Import and prep data

* respiration data
* growth estimates
* normalized abundances

```{r}
meta <- readRDS("../data_intermediate/SFA2_metadata.rds")

# Respiration data, remove non-samples
resp <- readRDS("../data_intermediate/SFA2_respiration.rds") %>% 
  filter(!Inoculant %in% c(0, 51)) # remove controls

# Growth estimates
growth <- readRDS("../data_intermediate/SFA2_growth_estimates_pap2.rds")

# Normalized abundances
norm_gr <- readRDS("../data_intermediate/SFA2_norm_grestimated.rds")
norm_all <- readRDS("../data_intermediate/SFA2_normalized.rds")

# All paprica estimates
pap_all <- readRDS("../data_intermediate/SFA2_paprica_all.rds")

# Combine and clean up growth and normalized abundance data
growth_abund <- left_join(growth, norm_gr) %>% 
  select(Inoculant, Day, ASV, slope, yint, start_day, end_day, k, n16S, norm_abund_avg)
```

# Total respired CO2

Calculate totals:

```{r}
# Cumulative mg CO2 and C for each replicate
resp_total <-  resp %>%
  group_by(Sample, Inoculant) %>%
  summarize(total_mgCO2 = sum(mgCO2), total_mgC = total_mgCO2*(12/44)) %>% # molar weight ratio of C in CO2
  ungroup() %>% 
  mutate(Inoculant = as.character(Inoculant))
```

```{r}
# Visualize
resp_total %>% 
  filter(!(Inoculant %in% c(0, 51))) %>% # remove controls
  ggplot(aes(x=Inoculant, y=total_mgCO2)) +
  geom_point() +
  theme_test()
```

C respired as CO2:

```{r}
mean(resp_total$total_mgC)
sd(resp_total$total_mgC)
```

Statistics:

Are there any differences in total respiration between inoculants?

```{r}
# linear model
resp_total_lm <- lm(total_mgCO2 ~ Inoculant, data=resp_total)
hist(resid(resp_total_lm)) # non-normal

# Kruskal-Wallis
kruskal.test(total_mgCO2 ~ Inoculant, data=resp_total)
```

# Respiration rate over time

Calculate mg CO2 respired per inoculant per day:

```{r}
# Each replicate rate
resp_rate <- resp %>% 
  select(Sample, Inoculant, Day, Timeframe, mgCO2) %>% 
  mutate(mgCO2_day = mgCO2/Timeframe) %>% 
  filter(!is.infinite(mgCO2_day)) # remove day 0 (no rate possible)

# Average replicates per day
resp_rate_inoc <- resp_rate %>% 
  group_by(Inoculant, Day) %>% 
  summarize(mgCO2_day = mean(mgCO2_day))
```

Visualize:

```{r}
resp_rate_inoc %>% 
  filter(!(Inoculant %in% c(0, 51))) %>%  # remove controls
  ggplot(aes(x=Day, y=mgCO2_day)) +
  geom_boxplot(aes(group=Day)) +
  geom_jitter() +
  geom_vline(xintercept = 5, linetype=2) +
  theme_test()
```

# Biomass vs respiration

```{r}
# Add 16S copies to normalized abundance data
pap_slim <- pap_all %>% 
  select(ASV, n16S)

norm_pap <- inner_join(norm_all, pap_slim)

# Average replicates and sum ASVs
norm_total <- norm_pap %>% 
  filter(Type=="Growth") %>% 
  select(Inoculant, Day, Replicate, ASV, norm_abund, n16S) %>% 
  group_by(Inoculant, Day, ASV, n16S) %>% # average reps
  summarize(norm_abund_avg = mean(norm_abund, na.rm=TRUE)) %>%
  ungroup() %>%
  mutate(norm_abund_cor = norm_abund_avg/n16S) %>% # correct by rrn copies
  group_by(Inoculant, Day) %>%  # sum ASV abundances for total
  summarize(norm_total = sum(norm_abund_cor, na.rm=TRUE)) %>% 
  ungroup()

# CO2 averages
resp_rate_avg <- resp_rate %>% 
  group_by(Inoculant, Day) %>% 
  summarize(mgCO2 = mean(mgCO2),
            mgCO2_day = mean(mgCO2_day)) %>% 
  ungroup()

# combine
norm_total_resp <- inner_join(norm_total, resp_rate_avg)
```

Visualize:

```{r}
norm_total_resp %>% 
  ggplot(aes(x=log(norm_total), y=mgCO2_day)) +
  geom_point() +
  geom_smooth(method="lm") +
  theme_test() 
```

Statistics:

```{r}
cor.test(log(norm_total_resp$norm_total), norm_total_resp$mgCO2_day)
```

# W.mean growth rate vs resp. rate

Calculate weighted mean growth rate for each time point:

```{r}
# Correct normalized abundance by 16S copy number
growth_abund <- growth_abund %>% 
  mutate(norm_abund_corr = norm_abund_avg/n16S)

# Calculate weighted k
weighted_gr <- data.frame()

for (i in unique(growth_abund$Inoculant)) {
  for (d in unique(growth_abund$Day)) {
    data_subset <- filter(growth_abund, Inoculant==i & Day==d) %>% 
      filter(start_day <= d & end_day >= d) # include only ASVs that grew on the given day
    weighted_mean <- weighted.mean(data_subset$k, data_subset$norm_abund_corr) # weight by corrected abundance
    this_row <- bind_cols(Inoculant=i, Day=d, weighted_k=weighted_mean)
    weighted_gr <- bind_rows(weighted_gr, this_row)
  }
}

# Visualize
weighted_gr %>% 
  ggplot(aes(x=Day, y=weighted_k)) +
  geom_boxplot(aes(group=Day)) +
  geom_point() +
  #geom_line() +
  #facet_wrap(~Inoculant) +
  labs(title="Weighted mean growth rates over time") +
  theme_test()
```

Combine weighted mean growth rate and respiration rate means:

```{r}
growth_resprate <- inner_join(weighted_gr, resp_rate_inoc)
```

Respiration rate x weighted growth rate:

```{r}
growth_resprate %>% 
  ggplot(aes(x=mgCO2_day, y=weighted_k)) +
  geom_point() +
  geom_smooth(method="lm", linetype=2) +
  theme_test() +
  labs(title="Weighted growth rates vs. respiration rates", x="Respiration rate mean (mgCO2/day)", y="specific growth rate w.mean")

# Averaged across inoculants
# growth_resprate %>% 
#   group_by(Day) %>% 
#   summarize(weighted_k = mean(weighted_k, na.rm=TRUE),
#             mgCO2_day = mean(mgCO2_day, na.rm=TRUE)) %>%
#   ungroup() %>% 
#   ggplot(aes(x=mgCO2_day, y=weighted_k)) +
#   geom_point() +
#   geom_smooth(method="lm", linetype=2) +
#   theme_test() +
#   labs(title="Weighted growth rates vs. respiration rates", x="Respiration rate mean (mgCO2/day)", y="specific growth rate w.mean")
```

Statistics:

```{r}
cor.test(growth_resprate$mgCO2_day, growth_resprate$weighted_k)
```

# Growth efficiency

Proxy for CUE using generation time, period of time, normalized abundance, and respiration rate.

N0 = normalized abundance of taxon at start of time interval (not log transformed)
g = generation time of taxon (days)
t = days in time frame
r = mg CO2/day, respiration rate

n = t/g, number of generations
Nt = N0*2^n, biomass at end of time frame
deltaN = Nt - N0, change in biomass
r*t = the mg CO2 produced in that time frame

growth efficiency = Î£deltaN/(r*t), ie sum of gained abundance divided by mg CO2 produced.

```{r}
# How frequent are drop outs?
drop_outs <- growth_abund %>% 
  group_by(Inoculant, ASV) %>% 
  summarize(count = n()) %>% 
  ungroup() %>% 
  filter(count < 20) %>% 
  nrow()

total <- growth_abund %>% 
  group_by(Inoculant, ASV) %>% 
  
  summarize(count = 1) %>% 
  ungroup() %>% 
  summarize(sum(count))

drop_outs/total
```

95% of estimates are missing at least one time point, impute all data during growth period.

## Impute

Imputing abundance at time points when respiration measurement was taken.

```{r}
# Prep growth data
growth_slim <- growth %>% 
  select(label, Inoculant, ASV, slope, yint, start_day, end_day, n16S)

# Prep respiration tps
resp_tps <- as.data.frame(unique(resp$Day)) %>% 
  select(Day = `unique(resp$Day)`) %>%
  arrange(Day) %>% 
  rownames_to_column(var="TP") %>% 
  mutate(TP = as.numeric(TP))

# Build growth df with respiration time points
growth_resptps <- data.frame()
for (l in unique(growth_slim$label)) {
  for (d in unique(resp_tps$Day)) {
    growth_l <- filter(growth_slim, label==l)
    this_row <- add_column(growth_l, Day=d)
    growth_resptps <- bind_rows(growth_resptps, this_row)
  }
}

# Impute
growth_impute <- growth_resptps %>% 
  # add respiration measurement tps
  mutate(growing = if_else(Day >= start_day & Day <= end_day, "yes", "no"), # label if during growth period
         impute_abund = if_else(growing=="yes", slope*Day+yint, NULL), # impute using linear estimate
         impute_abund_corr = exp(impute_abund)/n16S) %>% # un-ln and correct by n16S
  select(Inoculant, ASV, Day, start_day, end_day, impute_abund_corr) %>% 
  filter(!is.na(impute_abund_corr))

# Remove tp0
resp_tps2 <- resp_tps %>% 
  filter(TP > 1) %>% 
  select(Day) %>% 
  rownames_to_column(var="TP")

# Calculate deltaNg
deltaN_df <- data.frame()
for (i in unique(growth_impute$Inoculant)) {
  for (d in resp_tps2$Day) {
    prev_tp <- resp_tps[resp_tps$Day==d,]$TP - 1 # previous tp
    prev_day <- resp_tps[prev_tp, 2] # previous day
    growth_i <- filter(growth_impute, Inoculant==i & (Day==d | Day==prev_day)) %>% # isolate ests from inoc. during timeframe
      mutate(include = if_else(start_day <= prev_day & end_day >= d, "yes", "no")) %>%
      filter(include=="yes") %>% 
      mutate(Day2 = if_else(Day < d, "prev", "current")) %>% 
      select(everything(), -Day) %>% 
      pivot_wider(names_from = Day2, values_from=impute_abund_corr) %>% 
      mutate(deltaN = current-prev) # calculate change in abundance during time frame
    deltaN <- as.numeric(summarize(growth_i, deltaN = sum(deltaN)))
    this_row <- bind_cols(Inoculant=i, Day=d, deltaN=deltaN)
    deltaN_df <- bind_rows(deltaN_df, this_row)
  }
}

# Cumulative respiration
resp_df <- resp %>% 
  select(Inoculant, Day, mgCO2) %>% 
  filter(Day > 0) %>% # exclude day 0
  group_by(Inoculant, Day) %>%  # average across replicates each tp
  summarize(mgCO2 = mean(mgCO2)) %>%
  ungroup()


# Calculate efficiency
greff_df <- inner_join(deltaN_df, resp_df) %>% 
  mutate(greff = deltaN/mgCO2)
```

Visualize:

```{r}
greff_df %>% 
  mutate(phase = if_else(Day <= 9, "exp", "stat")) %>% 
  ggplot(aes(x=Day, y=log(greff))) +
  geom_boxplot(aes(group=Day)) +
  geom_point() +
  #geom_smooth(method="lm", aes(group=phase)) +
  #geom_smooth() +
  theme_test()
```

Statistics:

```{r}
# Spearman correlation
cor.test(log(greff_df$Day), log(greff_df$greff), method="spearman")
```


# Abundance gain vs respiration

```{r}
greff_df %>% 
  ggplot(aes(x=log(deltaN), y=mgCO2)) +
  geom_point() +
  geom_smooth(method="lm") +
  theme_test()
```

Stats:

```{r}
cor.test(log(greff_df$deltaN), greff_df$mgCO2, method="spearman")
```


Statistics:

# WIP

```{r}
#cor.test()
```

# Growing:non-growing

Import data of all ASVs:

* Normalized abundances at each time point
* PAPRICA predicions

```{r}
normabund_all <- readRDS("../data_intermediate/SFA2_normalized.rds")
paprica <- readRDS("../data_intermediate/SFA2_paprica_all.rds")

# Combine
normabund_pap <- inner_join(normabund_all, paprica)

asvs_growing <- unique(growth$ASV)

# Tidy up
normabund_pap <- normabund_pap %>% 
  full_join(growth) %>% 
  mutate(grew = if_else(ASV %in% asvs_growing, "yes", "no"),
         norm_abund_corr = norm_abund/n16S) %>% # correct for copy #
  filter(Type=="Growth") %>% 
  select(Sample, Inoculant, Day, ASV, start_day, end_day, norm_abund_corr, grew)
```

```{r}
# Calculate grow:no-grow ratio
grow_ratio <- data.frame()

for (i in unique(normabund_pap$Inoculant)) {
  for (d in unique(normabund_pap$Day)) {
    # Calculate gained abundance for each taxon
    grow_total <- filter(normabund_pap, Inoculant==i & Day==d & grew=="yes") %>% 
      mutate(growing = if_else(start_day <= d & end_day >= d, "yes", "no")) %>% # make sure growing on day of interest 
      filter(growing == "yes") %>% 
      summarize(total = sum(norm_abund_corr, na.rm=TRUE)) %>% 
      select(total) %>% 
      as.numeric()
    nogrow_total <- filter(normabund_pap, Inoculant==i & Day==d) %>% 
      mutate(growing = if_else(grew=="yes" & start_day <= d & end_day >= d, "yes", "no")) %>% 
      filter(growing == "no" | grew=="no") %>% 
      summarize(total = sum(norm_abund_corr, na.rm=TRUE)) %>% 
      select(total) %>% 
      as.numeric()
    ratio <- grow_total/nogrow_total # growing biomass/non-growing biomass
    add_row <- bind_cols(Inoculant=i, Day=d, ratio=ratio)
    grow_ratio <- bind_rows(grow_ratio, add_row)
  }
}

# Add respiration data
resp_mean <- resp_rate %>% 
  group_by(Inoculant, Day) %>% 
  summarize(mgCO2_day = mean(mgCO2_day))
ratio_resp <- inner_join(grow_ratio, resp_mean)
```

Visualize:

```{r}
ratio_resp %>% 
  ggplot(aes(x=mgCO2_day, y=log(ratio))) +
  geom_point() +
  theme_test()
```

# Figures

## Respiration rates over time

```{r}
plot_resp <- resp_rate_inoc %>% 
  filter(!(Inoculant %in% c(0, 51))) %>%  # remove controls
  ggplot(aes(x=Day, y=mgCO2_day)) +
  geom_boxplot(aes(group=Day)) +
  theme_test() +
  theme(axis.text=element_text(size=10),
        axis.title=element_blank())
plot_resp
```

```{r, eval=FALSE}
ggsave("../figures/supp_resprate.svg", plot_resp, height=90, width=180, units="mm", device="svg")
```

## W. mean growth rates vs. respiration rates

```{r}
plot1 <- growth_resprate %>% 
  ggplot(aes(y=mgCO2_day, x=weighted_k)) +
  geom_point() +
  geom_smooth(method="lm", linetype=2, color="#444444") +
  theme_test() +
  theme(axis.text=element_text(size=10),
        axis.title=element_blank())
plot1
```

Change in abundance vs CO2:

```{r}

plot2 <- greff_df %>% 
  ggplot(aes(x=log(deltaN), y=mgCO2)) +
  geom_point() +
  geom_smooth(method="lm", linetype=2, color="#444444") +
  theme_test() + 
  theme(axis.text=element_text(size=10),
        axis.title=element_blank())
plot2
```

Combine:

```{r, eval=FALSE}
plot_comb12 <- plot_grid(plot1, plot2, nrow=2)
plot_comb12
```

```{r, eval=FALSE}
ggsave("../figures/fig_grnCO2.svg", plot_comb12, height=180, width=180, units="mm", device="svg")
```

## Growth efficiency over time

```{r}
# original
plot3 <- greff_df %>% 
  ggplot(aes(x=Day, y=log(greff))) +
  geom_boxplot(aes(group=Day)) +
  geom_point() +
  geom_smooth(linetype=2, color="#444444") +
  theme_test() +
  theme(axis.text=element_text(size=10),
        axis.title=element_blank())
plot3

# Trying to make box plot width proportional to time interval
# WIP
time_intervals <- data.frame()
for (i in 1:(nrow(resp_tps)-1)) {
  int <- data.frame(int=(resp_tps[i+1,2] - resp_tps[i,2]))
  time_intervals <- bind_rows(time_intervals, int)
}

time_int_rep <- bind_rows(time_intervals, time_intervals) %>% 
  bind_rows(time_intervals) %>% 
  bind_rows(time_intervals) %>% 
  bind_rows(time_intervals) %>% 
  bind_rows(time_intervals) # six inoculants

greff_df2 <- greff_df %>% 
  arrange(Inoculant, Day) %>% 
  bind_cols(time_int_rep)

greff_df2 %>% 
  ggplot(aes(x=Day, y=log(greff))) +
  geom_boxplot(aes(group=Day)) +
  #geom_point() +
  geom_smooth(linetype=2, color="#444444") +
  theme_test() +
  theme(axis.text=element_text(size=10),
        axis.title=element_blank())
```

```{r}
ggsave("../figures/fig_greff.svg", plot3, height=90, width=180, units="mm", device="svg")
```








# SCRAP

OLD GREFF BRLOW

```{r}
# Time points for growth and respiration measurements aren't the same
gr_tps <- as.data.frame(unique(growth_abund$Day)) %>%
  select(Day = `unique(growth_abund$Day)`) %>%
  arrange(Day) %>% 
  rownames_to_column(var="TP") %>% 
  mutate(TP = as.numeric(TP))

resp_tps <- as.data.frame(unique(resp$Day)) %>% 
  select(Day = `unique(resp$Day)`) %>%
  arrange(Day) %>% 
  rownames_to_column(var="TP") %>% 
  mutate(TP = as.numeric(TP))
```

```{r}
# Calculate growth efficiency metric
growth_eff <- data.frame()
for (i in unique(growth_abund$Inoculant)) {
  for (d in unique(growth_abund$Day)) {
    # Calculate time frame
    next_tp <- gr_tps[gr_tps$Day==d,]$TP + 1
    next_day <- gr_tps[next_tp, 2]
    t <- next_day - d
    # Calculate gained abundance for each taxon
    gained_abund <- filter(growth_abund, Inoculant==i & Day==d) %>% 
      filter(start_day <= d & end_day >= d) %>% # remove taxa that were not growing during timeframe
      mutate(g = log(2)/k, # calculate doubling time (ln2 / specific growth rate)
             t = t, # timeframe
             n = t/g, # number of generations
             Nt = norm_abund_corr*2^n, ############### WHAT IF DROP OUT?????????????
             deltaN = Nt - norm_abund_corr) %>% # biomass at end of timeframe
      summarize(total = sum(deltaN)) %>% 
      select(total) %>% 
      as.numeric()
    # Calculate respired CO2
    times_subset <- filter(resp_tps, Day > d) # use the rate calculated for the timeframe, associated with next tp value
    resp_d <- times_subset[1,] %>% # will choose d or nearest time point after d
      select(Day) %>% 
      as.numeric()
    respired <- filter(resp_rate, Inoculant==i & Day==resp_d) %>% 
      summarize(rate = mean(mgCO2_day)) %>% # average technical replicates
      mutate(t = t,
             total = rate*t) %>%
      select(total) %>% 
      as.numeric()
    # Combine dataframes
    add_row <- bind_cols(Inoculant=i, Day=next_day, deltaN_total=gained_abund, CO2=respired)
    growth_eff <- bind_rows(growth_eff, add_row)
  }
}

# Calculate growth efficiency
growth_eff <- mutate(growth_eff, growth_eff = deltaN_total/CO2)
```

Visualize:

```{r}
# gained abundance vs CO2 produced
growth_eff %>% 
  ggplot(aes(x=log(deltaN_total), y=CO2)) +
  geom_point() +
  geom_smooth(method="lm", linetype=2) +
  theme_test()

# Growth efficiency over time
growth_eff %>% 
  ggplot(aes(x=Day, y=log(growth_eff))) +
  geom_boxplot(aes(group=Day)) +
  geom_point() +
  geom_smooth(linetype=2) +
  theme_test()
```

```{r}
# gained abundance vs CO2 produced
plot2 <- growth_eff %>% 
  ggplot(aes(x=log(deltaN_total), y=CO2)) +
  geom_point() +
  geom_smooth(method="lm", linetype=2, color="#444444") +
  theme_test() +
  theme(axis.text=element_text(size=10),
        axis.title=element_blank())
plot2
```

