---
title: "WIP_death_explore"
author: "Cassandra Wattenburger"
date: "11/18/2021"
output: html_document
---

```{r}
# Clear working directory, load in packages, generate package info
rm(list=ls())

library("tidyverse")
library("trelliscopejs")

sessionInfo()
```

# Import data

Files produced in 03_SFA2_deathestimates.Rmd
* death estimates
* normalized abundance data for time series with estimated death

```{r}
# death
death <- readRDS("../data_intermediate/SFA2_death_estimates.rds")

# Taxonomic information
tax <- readRDS("../data_intermediate/SFA2_tax_normalized.rds")
```

# Exploration

### Numbers of dying bacteria

```{r}
# Number of taxa dying
num_grow <- death %>% 
  group_by(DOC, Innoculant) %>% 
  summarize(num_grew = n()) %>% 
  ungroup()

num_grow

# treatment
num_grow %>% 
  group_by(DOC) %>% 
  summarize(mean_num = mean(num_grew), sd_num = sd(num_grew)) %>% 
  ungroup()

num_grow %>% 
  ggplot(aes(x=DOC, y=num_grew)) +
  geom_boxplot() +
  labs(x="DOC \"phenotype\"", y="Number of death estimated taxa") +
  theme_test() +
  theme()
```

Growth and death:

```{r}
growth <- readRDS("../data_intermediate/SFA2_growth_estimates.rds")

growth_death <- death %>% 
  inner_join(growth, by=c("DOC", "Innoculant", "ASV")) %>% 
  select(DOC, Innoculant, ASV) 

# Innoculant
growth_death %>% 
  group_by(DOC, Innoculant) %>% 
  summarize(number = n()) %>% 
  ungroup()

# Treatment
growth_death %>% 
  group_by(DOC, Innoculant) %>% 
  summarize(number = n()) %>% 
  ungroup() %>% 
  group_by(DOC) %>% 
  summarize(mean_num = mean(number), sd_num = sd(number)) %>% 
  ungroup()
```

# Phylogenetic membership:

```{r}
# Merge death estimates with taxonomy
death_tax <- inner_join(death, tax) 

# Graph phylogenetic membership
death_phylo_plot <- death_tax %>% 
  group_by(Phylum, DOC, Innoculant) %>% 
  summarize(count = n()) %>% 
  ungroup() %>% 
  arrange(count) %>% 
  ggplot(aes(x=count, y=reorder(Phylum, count), color=DOC)) +
  geom_boxplot() +
  labs(title="Death", y="", x="Number of ASVs") +
  theme_test() +
  theme(title = element_text(size=18),
        axis.title = element_text(size=16),
        axis.text = element_text(size=14),
        panel.grid.major.y = element_line(color = "gray",
                                          size = 0.5,
                                          linetype = 2))
death_phylo_plot
```

```{r, eval=FALSE}
ggsave("../figures/SFA2_death_phylo.png", death_phylo_plot, units="mm", width=200, height=100)
```


# Death parameters:

* specific growth rate (k)
* start day
* end day
* change in abundance
* start abundance
* end abundance

# Community-level

```{r}
# Summarize parameters
death_summary <- death %>% 
  group_by(DOC, Innoculant) %>% 
  summarize(mean_slope = mean(slope),
            mean_start_day = mean(start_day),
            mean_end_day = mean(end_day),
            mean_end_abund = mean(end_abund),
            total_end_abund = sum(end_abund),
            mean_change_abund = mean(change_abund),
            total_change_abund = sum(change_abund)) %>% 
  ungroup()
```

```{r}
# Mean k
slope_mean_plot <- death_summary %>% 
  ggplot(aes(x=DOC, y=mean_slope)) +
  geom_boxplot() +
  labs(x="DOC \"phenotype\"", y="Mean slope of death") +
  theme_test() +
  theme(title = element_text(size=18),
        axis.title = element_text(size=16),
        axis.text = element_text(size=14))
slope_mean_plot
  
# Mean start day
lag_mean_plot <- death_summary %>% 
  ggplot(aes(x=DOC, y=mean_start_day)) +
  geom_boxplot() +
  labs(x="DOC \"phenotype\"", y="Mean start of death (day)") +
  theme_test() +
  theme(title = element_text(size=18),
        axis.title = element_text(size=16),
        axis.text = element_text(size=14))
lag_mean_plot

# Mean change abundance
change_abund_mean_plot <- death_summary %>% 
  ggplot(aes(x=DOC, y=mean_change_abund)) +
  geom_boxplot() +
  labs(x="DOC \"phenotype\"", y="Mean change in relational abundance") +
  theme_test() +
  theme(title = element_text(size=18),
        axis.title = element_text(size=14),
        axis.text = element_text(size=14))
change_abund_mean_plot

# Total change abundance
change_abund_total_plot <- death_summary %>% 
  ggplot(aes(x=DOC, y=total_change_abund)) +
  geom_boxplot() +
  labs(x="DOC \"phenotype\"", y="Total change in relational abundance") +
  theme_test() +
  theme(title = element_text(size=18),
        axis.title = element_text(size=14),
        axis.text = element_text(size=14))
change_abund_total_plot
```

```{r, eval=FALSE}
ggsave("../figures/SFA2_death_slopemean.png", slope_mean_plot, units="mm", width=100, height=100)
ggsave("../figures/SFA2_death_lagmean.png", lag_mean_plot, units="mm", width=100, height=100)
ggsave("../figures/SFA2_death_changeabundmean.png", change_abund_mean_plot, units="mm", width=100, height=100)
ggsave("../figures/SFA2_death_changeabundtotal.png", change_abund_total_plot, units="mm", width=100, height=100)
```

# Statistics

Death rate:

```{r}
slope_lm <- lm(mean_slope ~ DOC, data=death_summary)
hist(resid(slope_lm))
plot(predict(slope_lm), resid(slope_lm))

anova(slope_lm)
```

Start day:

```{r}
start_day_lm <- lm(mean_start_day ~ DOC, data=death_summary)
hist(resid(start_day_lm))
plot(predict(start_day_lm), resid(start_day_lm))

anova(start_day_lm)
```

Mean change in abundance:

```{r}
mean_change_lm <- lm(mean_change_abund ~ DOC, data=death_summary)
hist(resid(mean_change_lm))
plot(predict(mean_change_lm), resid(mean_change_lm))

anova(mean_change_lm)
```

Total change in abundance:

```{r}
total_change_lm <- lm(total_change_abund ~ DOC, data=death_summary)
hist(resid(total_change_lm))
plot(predict(total_change_lm), resid(total_change_lm))

anova(total_change_lm)
```









# Distributions of parameters

Specific death rates

```{r}
# Distribution of death rates
death %>%
  ggplot(aes(x=slope, color=DOC)) +
  geom_density(alpha=0.5) +
  labs(x="Specific death rate (slope)", y="Kernel Density") +
  theme_test() +
  theme(#legend.position="none",
        title=element_text(size=12),
        axis.text=element_text(size=12),
        axis.title=element_text(size=12))

death %>%
  ggplot(aes(x=slope, color=Innoculant)) +
  geom_density(alpha=0.5) +
  labs(x="Specific death rate (k)", y="Kernel Density") +
  theme_test() +
  theme(#legend.position="none",
        title=element_text(size=12),
        axis.text=element_text(size=12),
        axis.title=element_text(size=12))
```

Change in relational abundance

```{r}
# Distribution of change in abundance during death
death %>%
  ggplot(aes(x=log(change_abund), color=DOC)) +
  geom_density(alpha=0.5) +
  labs(x="ln Change in relational abundance during death", y="Kernel Density") +
  theme_test() +
  theme(#legend.position="none",
        title=element_text(size=12),
        axis.text=element_text(size=12),
        axis.title=element_text(size=12))

death %>%
  ggplot(aes(x=log(change_abund), color=Innoculant, linetype=DOC)) +
  geom_density(alpha=0.5) +
  labs(x="ln Change in relational abundance during death", y="Kernel Density") +
  theme_test() +
  theme(#legend.position="none",
        title=element_text(size=12),
        axis.text=element_text(size=12),
        axis.title=element_text(size=12))
```

Start relational abundance

```{r}
# Distribution of change in abundance during death
death %>%
  ggplot(aes(x=log(start_abund), color=DOC)) +
  geom_density(alpha=0.5) +
  labs(x="ln Starting relational abundance", y="Kernel Density") +
  theme_test() +
  theme(#legend.position="none",
        title=element_text(size=12),
        axis.text=element_text(size=12),
        axis.title=element_text(size=12))

death %>%
  ggplot(aes(x=log(start_abund), color=Innoculant)) +
  geom_density(alpha=0.5) +
  labs(x="ln Starting in relational abundance", y="Kernel Density") +
  theme_test() +
  theme(#legend.position="none",
        title=element_text(size=12),
        axis.text=element_text(size=12),
        axis.title=element_text(size=12))
```

End relational abundance

```{r}
# Distribution of change in abundance during death
death %>%
  ggplot(aes(x=log(end_abund), color=DOC)) +
  geom_density(alpha=0.5) +
  labs(x="ln Ending relational abundance", y="Kernel Density") +
  theme_test() +
  theme(#legend.position="none",
        title=element_text(size=12),
        axis.text=element_text(size=12),
        axis.title=element_text(size=12))

death %>%
  ggplot(aes(x=log(end_abund), color=Innoculant)) +
  geom_density(alpha=0.5) +
  labs(x="ln Ending relational abundance", y="Kernel Density") +
  theme_test() +
  theme(#legend.position="none",
        title=element_text(size=12),
        axis.text=element_text(size=12),
        axis.title=element_text(size=12))
```

# Relationship to DOC measurement

Import DOC measurements

```{r}
# DOC measurements
doc <- readRDS("../data_DOC/SFA2/SFA2_doc.rds") %>% 
  select(everything(), Sample=sample_id) %>% 
  mutate(Sample = as.numeric(Sample))

# Metadata
meta <- read_tsv(file = "../data_amplicon/SFA2_full/SFA2_full_metadata.tsv") %>% 
  select(Sample, Type, Innoculant, DOC, Replicate, Day)

# Merge and average technical replicates
doc_meta <- inner_join(doc, meta) %>% 
  group_by(DOC, Innoculant) %>% 
  summarize(doc_avg = mean(mean)) %>% 
  ungroup() %>% 
  mutate(Innoculant = as.character(Innoculant))

# Join with death estimates
death_summary <- death %>% 
  group_by(DOC, Innoculant) %>% 
  summarize(mean_slope = mean(slope),
            mean_start_day = mean(start_day),
            mean_end_day = mean(end_day),
            total_start_abund = sum(start_abund),
            total_end_abund = sum(end_abund),
            total_change_abund = sum(change_abund)) %>% 
  ungroup()

doc_death <- inner_join(doc_meta, death_summary)
```

```{r}
# k
doc_death %>% 
  ggplot(aes(x=doc_avg, y=mean_slope, color=DOC)) +
  geom_point() +
  theme_test()

# start day
doc_death %>% 
  ggplot(aes(x=doc_avg, y=mean_start_day, color=DOC)) +
  geom_point() +
  theme_test()

# start abundance
doc_death %>% 
  ggplot(aes(x=doc_avg, y=total_start_abund, color=DOC)) +
  geom_point() +
  theme_test()

# end abundance
doc_death %>% 
  ggplot(aes(x=doc_avg, y=total_end_abund, color=DOC)) +
  geom_point() +
  theme_test()

# change abundance
doc_death %>% 
  ggplot(aes(x=doc_avg, y=total_change_abund, color=DOC)) +
  geom_point() +
  theme_test()
```