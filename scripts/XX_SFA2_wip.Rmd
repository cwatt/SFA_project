---
title: "WIP/Idea exploration"
author: "Cassandra Wattenburger"
date: "4/4/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

```{r}
# Clear working directory, load in packages, generate package info
rm(list=ls())

library("tidyverse")

sessionInfo()
```

# Import data

* growth and death estimates
* DOC measurements

```{r}
# growth
growth <- readRDS("../data_intermediate/SFA2_growth_estimates_pap.rds")

# death
death <- readRDS("../data_intermediate/SFA2_death_estimates_pap.rds")

# DOC
doc <- readRDS("../data_DOC/SFA2/SFA2_doc.rds") %>% 
  mutate(Sample = sample_id)

# metadata
meta <- read_tsv("../data_amplicon/SFA2_full/SFA2_metadata_corrected.tsv") %>% 
  mutate(Sample = as.character(Sample))

# Add metadata to doc
doc <- inner_join(meta, doc) %>% 
  select(SampleID, Sample, Type, Inoculant, Replicate, doc_ppm=mean)

# Rarefied count data
physeq <- readRDS("../data_intermediate/SFA2_physeq_rare.rds")
```

# Kernel density

### Growth

Observe growth characteristics of each inoculant on a per-ASV level (rather than avgs).

```{r}
# k 
growth %>%
  ggplot(aes(x=k, color=Inoculant)) +
  geom_density(alpha=0.5) +
  labs(x="specific growth rate", y="Kernel Density") +
  theme_test() +
  theme(#legend.position="none",
        title=element_text(size=12),
        axis.text=element_text(size=12),
        axis.title=element_text(size=12))

growth %>%
  ggplot(aes(x=log(change_abund), color=Inoculant)) +
  geom_density(alpha=0.5) +
  labs(x="ln change in abundance", y="Kernel Density") +
  theme_test() +
  theme(#legend.position="none",
        title=element_text(size=12),
        axis.text=element_text(size=12),
        axis.title=element_text(size=12))

growth %>%
  ggplot(aes(x=start_day, color=Inoculant)) +
  geom_density(alpha=0.5) +
  labs(x="lag", y="Kernel Density") +
  theme_test() +
  theme(#legend.position="none",
        title=element_text(size=12),
        axis.text=element_text(size=12),
        axis.title=element_text(size=12))
```

### Death

Observe growth characteristics of each inoculant on a per-ASV level (rather than avgs).

```{r}
# k 
death %>%
  ggplot(aes(x=k, color=Inoculant)) +
  geom_density(alpha=0.5) +
  labs(x="specific death rate", y="Kernel Density") +
  theme_test() +
  theme(#legend.position="none",
        title=element_text(size=12),
        axis.text=element_text(size=12),
        axis.title=element_text(size=12))

death %>%
  ggplot(aes(x=log(abs(change_abund)), color=Inoculant)) +
  geom_density(alpha=0.5) +
  labs(x="ln change in abundance", y="Kernel Density") +
  theme_test() +
  theme(#legend.position="none",
        title=element_text(size=12),
        axis.text=element_text(size=12),
        axis.title=element_text(size=12))

death %>%
  ggplot(aes(x=start_day, color=Inoculant)) +
  geom_density(alpha=0.5) +
  labs(x="lag", y="Kernel Density") +
  theme_test() +
  theme(#legend.position="none",
        title=element_text(size=12),
        axis.text=element_text(size=12),
        axis.title=element_text(size=12))
```

# Waves of growth and death

Is there a pattern?

```{r}
# Isolate growth and death lag
growth_start <- select(growth, Inoculant, ASV, growth=start_day)
death_start <- select(death, Inoculant, ASV, death=start_day)

# Combine
grde_lag <- inner_join(growth_start, death_start)  %>% 
  pivot_longer(-c(Inoculant, ASV), names_to="type", values_to="lag")

# Visualize
grde_lag %>% 
  ggplot(aes(x=lag, color=type)) +
  geom_density(alpha=0.5) +
  facet_wrap(~Inoculant, scales = "free") +
  labs(x="lag", y="Kernel Density") +
  theme_test() +
  theme(title=element_text(size=12),
        axis.text=element_text(size=12),
        axis.title=element_text(size=12))

```

# DOC

By inoculant.

```{r}
# Avg each incoulant DOC measurement
doc_mean <- doc %>% 
  group_by(Inoculant, Type) %>% 
  summarize(doc_ppm = mean(doc_ppm)) %>% 
  ungroup() %>% 
  filter(Type=="Growth")

doc %>% 
  filter(Type=="Growth") %>% 
  ggplot(aes(x=Inoculant, y=doc_ppm)) +
  geom_point(alpha=0.5) +
  theme_test()
```

# Characterize initial state

* alpha diversity
* beta diversity

### Alpha diversity

```{r}
count <- data.frame(otu_table(physeq))

# Reformat and calculate richness
tp0_alpha <- count %>% 
  pivot_longer(everything(), names_to = "SampleID", values_to="count") %>% 
  mutate(presabs = if_else(count > 0, 1, 0), # to count number of present ASVs
         SampleID = as.double(gsub("sa", "", SampleID))) %>% 
  group_by(SampleID) %>% 
  summarize(richness = sum(presabs)) %>% # calculate richness
  ungroup() %>% 
  inner_join(meta) %>% 
  filter(Day==0) %>% 
  select(SampleID, Sample, Type, Inoculant, Day, richness)

# Calculate Shannon's diversity index
shannon <- diversity(t(count), index="shannon") %>% 
  as.data.frame() %>% 
  rownames_to_column(var="SampleID") %>% 
  mutate(SampleID = as.double(gsub("sa", "", SampleID)))

tp0_alpha <- inner_join(tp0_alpha, shannon) %>% 
  rename(shannon=".")

# Calculate evenness
tp0_alpha <- tp0_alpha %>% 
  mutate(evenness = shannon/log(richness),
         Inoculant = as.character(Inoculant))
```

Visualize:

```{r}
# Richness
tp0_alpha %>% 
  ggplot(aes(x=Inoculant, y=richness)) +
  geom_point() +
  theme_test()

# Shannon's
tp0_alpha %>% 
  ggplot(aes(x=Inoculant, y=shannon)) +
  geom_point() +
  theme_test()

# Evenness
tp0_alpha %>% 
  ggplot(aes(x=Inoculant, y=evenness)) +
  geom_point() +
  theme_test()
```

### Beta diversity

Ordination:

```{r}
physeq_tp0 <- subset_samples(physeq, Day==0)

# Calculate weighted unifrac
wuni_tp0 <- distance(physeq_tp0, method="wunifrac")

# Ordinate
pcoa_tp0 <- ordinate(physeq_tp0, distance=wuni_tp0, method="PCoA")

plot_ordination(physeq_tp0, pcoa_tp0, color="Inoculant") +
  theme_test()
```

```{r}
# Reformat
wuni_df <- wuni_tp0 %>% 
  as.matrix() %>% 
  as.data.frame() %>%
  rownames_to_column(var="Sample1") %>% 
  pivot_longer(-Sample1, names_to = "Sample2", values_to = "wuni_dist")

wuni_df <- wuni_df[wuni_df$Sample1 != wuni_df$Sample2,] # remove self-comparisons
```

```{r}
# Remove duplicates
# SLOW
# Sort sample1 and sample2 to create a unique label for duplicates regardless of order in columns
all_labels <- as.character()
for (i in 1:nrow(wuni_df)) {
  string <- wuni_df[i,] %>% 
    select(Sample1, Sample2) %>% 
    as.character() %>% 
    sort()
  label <- paste0(string[1], string[2])
  all_labels <- append(all_labels, label)
}

wuni_df <- bind_cols(wuni_df, all_labels) %>% 
  select(wuni_dist, label=`...4`) %>% 
  distinct() %>% # remove duplicate pairwise comparisons
  mutate(Sample1 = gsub("(sa[0-9]+)(sa[0-9]+)", "\\1", label),
         Sample2 = gsub("(sa[0-9]+)(sa[0-9]+)", "\\2", label)) %>% 
  select(Sample1, Sample2, wuni_dist)

# Comparisons of interest
wuni_within <- data.frame()
for (i in c(41,2,10,12,19,47)) {
    sams <- filter(meta, Inoculant==i & Day==0) %>% 
      mutate(SampleID = gsub("([0-9]+)", "sa\\1", SampleID))
    sams <- sams$SampleID
    wuni_sub <- filter(wuni_df, Sample1 %in% sams & Sample2 %in% sams) # isolate samples of interest
    wuni_avg <- mean(wuni_sub$wuni_dist, na.rm = TRUE) # average
    this_row <- bind_cols(Inoculant=i, wuni_dist=wuni_avg)
    wuni_within <- bind_rows(wuni_within, this_row)
}
```

```{r}
wuni_within %>% 
  mutate(Inoculant=as.character(Inoculant)) %>%
  ggplot(aes(x=Inoculant, y=wuni_dist)) +
  geom_point() +
  labs(y="Weighted unifrac distance (between replicates)") +
  theme_test()
```








