---
title: "SFA2 - community dissimilarity vs."
author: "Cassandra Wattenburger"
date: "10/7/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(results = "show")
knitr::opts_chunk$set(message = FALSE)
```

```{r}
# Clear working directory, load in packages, generate package info
rm(list=ls())

library("tidyverse")
library("ape")
library("phyloseq")
library("vegan")
library("picante")

sessionInfo()
```

# Import data

* metadata
* rarefied phyloseq
* weighted unifrac distances
* growth estimates
* normalized abundances

```{r}
meta <- readRDS("../data_intermediate/SFA2_metadata.rds")
physeq <- readRDS("../data_intermediate/SFA2_physeq_rare.rds")
wuni_dist <- readRDS("../data_intermediate/SFA2_wunidist_slim.rds")
growth <- readRDS("../data_intermediate/SFA2_growth_estimates_pap.rds")
norm_gr <- readRDS("../data_intermediate/SFA2_norm_grestimated.rds") # in case want to do weighted mean k
bNTI <- readRDS("../data_intermediate/SFA2_bNTI_mean_overall.rds")
```

# Sample dispersion vs growth rates

How does the disimilarity between replicates within a sample relate to growth rates?

Calculate averages:

```{r}
# Calculate average distance per inoculant per day
comm_dist <- data.frame()
for (i in unique(meta$Inoculant)) {
  for (d in unique(meta$Day)) {
    meta_filt <- filter(meta, Type=="Growth" & Inoculant==i & Day==d)
    sams <- meta_filt$SampleID
    wuni_filt <- filter(wuni_dist, Sample1 %in% sams & Sample2 %in% sams)
    wuni_avg <- mean(wuni_filt$wuni_dist, na.rm=TRUE)
    add_row <- bind_cols(Inoculant=i, Day=d, avg_dist=wuni_avg)
    comm_dist <- bind_rows(comm_dist, add_row)
  }
}

# Remove unnecessary columns and combine
growth <- growth %>% 
  select(ASV, Inoculant, start_day, end_day, k, n16S)

norm_gr <- norm_gr %>% 
  select(ASV, Inoculant, Day, norm_abund_avg)

norm_growth <- inner_join(growth, norm_gr)

# Correct normalized abundance by 16S copy numbers
norm_growth <- norm_growth %>% 
  mutate(norm_abund_corr = norm_abund_avg/n16S)

# Calculate avg k
weighted_k <- data.frame()
for (i in unique(norm_growth$Inoculant)) {
  for (d in unique(norm_growth$Day)) {
    data_filt <- filter(norm_growth, Inoculant==i & Day==d) %>% 
      filter(start_day <= d & end_day >= d) # make sure ASV is growing on this day
    k_wmean <- weighted.mean(data_filt$k, data_filt$norm_abund_corr)
    add_row <- bind_cols(Inoculant=i, Day=d, wmean_k=k_wmean)
    weighted_k <- bind_rows(weighted_k, add_row)
  }
}
```

Combine distance and growth rate averages:

```{r}
dist_k <- inner_join(comm_dist, weighted_k)
```

Visualize:

```{r}
dist_k %>% 
  ggplot(aes(x=avg_dist, y=wmean_k)) +
  geom_point() +
  facet_wrap(~Inoculant) +
  geom_smooth(method="lm", linetype=2) +
  labs(x="Weighted unifrac distance (avg)", y="Weighted mean specific growth rate") +
  theme_test()

dist_k %>% 
  ggplot(aes(x=avg_dist, y=wmean_k)) +
  geom_point() +
  geom_smooth(method="lm", linetype=2) +
  labs(x="Weighted unifrac distance (avg)", y="weighted mean specific growth rate") +
  theme_test()
```

Statistics:

```{r}
# Overall
cor.test(dist_k$avg_dist, dist_k$wmean_k)
```

# BNTI vs. growth rates

Does growth rate correlate with stochasticity?

Import bNTI calculations:

```{r}
bNTI <- readRDS("../data_intermediate/SFA2_bNTI_mean_overall.rds")

# Combine with wmean growth rates
bNTI_wmk <- inner_join(bNTI, weighted_k) %>% 
  mutate(assembly = if_else(bNTI_mean >= -2 & bNTI_mean <= 2, "stochastic", "deterministic"))
```

Visualize:

```{r}
bNTI_wmk %>% 
  filter(!is.na(assembly)) %>% 
  ggplot(aes(x=assembly, y=wmean_k)) +
  geom_boxplot() +
  geom_jitter() +
  geom_smooth(method="lm", linetype=2) +
  theme_test()
```

# bNTI vs evenness

Calculate alpha diversity:

```{r}
# Extract data from phyloseq
count_physeq <- data.frame(otu_table(physeq)) %>% 
  rownames_to_column(var="ASV") %>% 
  gather(SampleID, count, -ASV)

# Add metadata
count_meta <- inner_join(count_physeq, meta, by="SampleID") %>% 
  mutate(Inoculant = as_factor(Inoculant)) %>% 
  filter(ASV != "445e8681c3c1a735760e6c394f5f4d0a") # remove spike-in

# Calculate evenness
# Reformat counts to be compatible with vegan
count_meta_wide <- count_meta %>% 
  select(ASV, SampleID, count) %>% 
  pivot_wider(names_from="ASV", values_from="count") %>% 
  column_to_rownames(var="SampleID")

# Calculate
shannon <- diversity(count_meta_wide, "shannon")
richness <- specnumber(count_meta_wide)
evenness <- shannon/log(richness)

# Add evennness values to data
even_df <- data.frame(evenness) %>% 
  rownames_to_column(var="SampleID")

alpha_df <- data.frame(richness) %>%
  rownames_to_column(var="SampleID") %>% 
  inner_join(even_df)

# Add Shannon's diversity index
alpha_df <- data.frame(shannon) %>% 
  rownames_to_column(var="SampleID") %>% 
  inner_join(alpha_df)

# Add metadata
alpha_df <- inner_join(alpha_df, meta)

# Add bNTI results 
alpha_bNTI <- inner_join(alpha_df, bNTI)
```

Filter and label based on bNTI:

```{r}
# Interested in days 20+ (return to stochasticity)
alpha_bNTI_day20plus <- alpha_bNTI %>% 
  filter(Day >= 20 & Type=="Growth") %>% 
  mutate(assembly = if_else(bNTI_mean >= -2, "deterministic", "stochastic")) %>% 
  select(Sample, Inoculant, Day, richness, shannon, evenness, bNTI_mean, assembly)
```

Visualize:

```{r}
alpha_bNTI_day20plus %>% 
  ggplot(aes(x=assembly, y=evenness)) +
  geom_boxplot() +
  geom_jitter() +
  labs(title="Evenness on days 20+") +
  theme_test()
```

