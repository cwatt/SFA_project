---
title: "SFA2 - CO2 data analysis"
author: "Cassandra Wattenburger"
date: "10/7/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

**Goal:** Analyze headspace CO2 from microcosms.

# Import libraries, clear working directory

```{r}
library(tidyverse)
library(cowplot)

sessionInfo()

rm(list=ls())
```
# Import and prep data

* respiration data
* growth estimates
* normalized abundances

```{r}
# Respiration data, remove non-samples
resp <- readRDS("../data_intermediate/SFA2_respiration.rds") %>% 
  filter(!Inoculant %in% c(0, 51))

# Growth estimates
growth <- readRDS("../data_intermediate/SFA2_growth_estimates_pap.rds")

# Normalized abundances
normabund <- readRDS("../data_intermediate/SFA2_norm_grestimated.rds")

# Combine and clean up growth and normalized abundance data
growth_abund <- full_join(growth, normabund) %>% 
  select(Inoculant, Day, ASV, start_day, end_day, k, n16S, norm_abund_avg) # remove unneeded columns
```

# Total respired CO2

Calculate totals:

```{r}
# Cumulative mg CO2 and C
resp_total <-  resp %>%
  group_by(Sample, Inoculant) %>%
  summarize(total_mgCO2 = sum(mgCO2), total_mgC = total_mgCO2*(12/44)) %>% # molar weight ratio of C in CO2
  ungroup() %>% 
  mutate(Inoculant = as.character(Inoculant))
```

```{r}
# Visualize
resp_total %>% 
  filter(!(Inoculant %in% c(0, 51))) %>% # remove controls
  ggplot(aes(x=Inoculant, y=total_mgCO2)) +
  geom_point() +
  theme_test()
```

Statistics:

Are there any differences in total respiration between inoculants?

```{r}
# linear model
resp_total_lm <- lm(total_mgCO2 ~ Inoculant, data=resp_total)
hist(resid(resp_total_lm)) # non-normal

# Kruskal-Wallis
kruskal.test(total_mgCO2 ~ Inoculant, data=resp_total)
```

# Respiration rate

Calculate mg CO2 respired per inoculant per day:

```{r}
resp_rate <- resp %>% 
  select(Sample, Inoculant, Day, Timeframe, mgCO2) %>% 
  mutate(mgCO2_day = mgCO2/Timeframe) %>% 
  filter(!is.infinite(mgCO2_day)) # remove day 0 (no rate possible)

# Average replicates for each inoculant
resp_rate_inoc <- resp_rate %>% 
  group_by(Inoculant, Day) %>% 
  summarize(mgCO2_day = mean(mgCO2_day))
```

Visualize:

```{r}
resp_rate_inoc %>% 
  filter(!(Inoculant %in% c(0, 51))) %>%  # remove controls
  ggplot(aes(x=Day, y=mgCO2_day)) +
  geom_boxplot(aes(group=Day)) +
    geom_jitter() +
  theme_test()
```

## Growth rate vs respiration rate

Calculate weighted mean growth rate for each time point:

```{r}
# Correct normalized abundance by 16S copy number
growth_abund <- growth_abund %>% 
  mutate(norm_abund_corr = norm_abund_avg/n16S)

# Calculate weighted k and summed k
weighted_gr <- data.frame()

for (i in unique(growth_abund$Inoculant)) {
  for (d in unique(growth_abund$Day)) {
    data_subset <- filter(growth_abund, Inoculant==i & Day==d) %>% 
      filter(start_day <= d & end_day >= d) # include only ASVs that grew on the given day
    weighted_mean <- weighted.mean(data_subset$k, data_subset$norm_abund_corr)
    this_row <- bind_cols(Inoculant=i, Day=d, weighted_k=weighted_mean)
    weighted_gr <- bind_rows(weighted_gr, this_row)
  }
}

# Visualize
weighted_gr %>% 
  ggplot(aes(x=Day, y=weighted_k)) +
  geom_boxplot(aes(group=Day)) +
  geom_point() +
  #geom_line() +
  #facet_wrap(~Inoculant) +
  labs(title="Weighted mean growth rates over time") +
  theme_test()
```

Combine weighted mean growth rate and respiration rate means:

```{r}
growth_resprate <- inner_join(weighted_gr, resp_rate_inoc)
```

Respiration rate x weighted growth rate:

```{r}
growth_resprate %>% 
  ggplot(aes(x=mgCO2_day, y=weighted_k)) +
  geom_point() +
  geom_smooth(method="lm", linetype=2) +
  theme_test() +
  labs(title="Weighted growth rates vs. respiration rates", x="Respiration rate mean (mgCO2/day)", y="specific growth rate w.mean")
```

Statistics:

```{r}
cor.test(growth_resprate$mgCO2_day, growth_resprate$weighted_k)
```

# Growth efficiency

Proxy for CUE using generation time, period of time, normalized abundance, and respiration rate.

N0 = normalized abundance of taxon at start of time interval (not log transformed)
g = generation time of taxon (days)
t = days in time frame
r = mg CO2/day, respiration rate

n = t/g, number of generations
Nt = N0*2^n, biomass at end of time frame
deltaN = Nt - N0, change in biomass
r*t = the mg CO2 produced in that time frame

growth efficiency = Î£deltaN/(r*t), the sum of gained abundance over mg CO2 produced

```{r}
growth_eff <- data.frame()

times <- as.data.frame(unique(growth_abund$Day)) %>%
  select(Day = `unique(growth_abund$Day)`) %>%
  arrange(Day) %>% 
  rownames_to_column(var="TP") %>% 
  mutate(TP = as.numeric(TP))

resp_times <- as.data.frame(unique(resp_rate$Day)) %>% 
  select(Day = `unique(resp_rate$Day)`) %>%
  arrange(Day) %>% 
  rownames_to_column(var="TP") %>% 
  mutate(TP = as.numeric(TP))

for (i in unique(growth_abund$Inoculant)) {
  for (d in unique(growth_abund$Day)) {
    # Calculate time frame
    next_tp <- times[times$Day==d,]$TP + 1
    next_day <- times[next_tp, 2]
    t <- next_day - d
    # Calculate gained abundance for each taxon
    gained_abund <- filter(growth_abund, Inoculant==i & Day==d) %>% 
      filter(start_day <= d & end_day >= d) %>% # remove taxa that did not grow on given day
      mutate(g = log(2)/k, # calculate doubling time (ln2 / specific growth rate)
             t = t, # timeframe
             n = t/g, # number of generations
             Nt = norm_abund_corr*2^n,
             deltaN = Nt - norm_abund_corr) %>% # biomass at end of timeframe
      summarize(total = sum(deltaN)) %>% 
      select(total) %>% 
      as.numeric()
    # Calculate respired CO2
    times_subset <- filter(resp_times, Day > d) # use the rate calculated for the timeframe, associated with next tp value
    resp_d <- times_subset[1,] %>% # will choose d or nearest time point after d
      select(Day) %>% 
      as.numeric()
    respired <- filter(resp_rate, Inoculant==i & Day==resp_d) %>% 
      summarize(rate = mean(mgCO2_day)) %>% # average technical replicates
      mutate(t = t,
             total = rate*t) %>%
      select(total) %>% 
      as.numeric()
    # Combine dataframes
    add_row <- bind_cols(Inoculant=i, Day=next_day, deltaN_total=gained_abund, CO2=respired)
    growth_eff <- bind_rows(growth_eff, add_row)
  }
}

# Calculate growth efficiency
growth_eff <- mutate(growth_eff, growth_eff = deltaN_total/CO2)
```

Visualize:

```{r}
# gained abundance vs CO2 produced
growth_eff %>% 
  ggplot(aes(x=log(deltaN_total), y=CO2)) +
  geom_point() +
  geom_smooth(method="lm", linetype=2) +
  theme_test()

# Growth efficiency over time
growth_eff %>% 
  ggplot(aes(x=Day, y=log(growth_eff))) +
  geom_point() +
  #geom_smooth(method="lm", linetype=2) +
  theme_test()
```

Statistics:

```{r}
# Spearman correlations
cor.test(log(growth_eff$deltaN_total), growth_eff$CO2, method="spearman")
cor.test(log(growth_eff$growth_eff), growth_eff$Day, method="spearman")
```


# Growing:non-growing

Import data of all ASVs:

* Normalized abundances at each time point
* PAPRICA predicions

```{r}
normabund_all <- readRDS("../data_intermediate/SFA2_normalized.rds")
paprica <- readRDS("../data_intermediate/SFA2_paprica_all.rds")

# Combine
normabund_pap <- inner_join(normabund_all, paprica)

asvs_growing <- unique(growth$ASV)

# Tidy up
normabund_pap <- normabund_pap %>% 
  full_join(growth) %>% 
  mutate(grew = if_else(ASV %in% asvs_growing, "yes", "no"),
         norm_abund_corr = norm_abund/n16S) %>% # correct for copy #
  filter(Type=="Growth") %>% 
  select(Sample, Inoculant, Day, ASV, start_day, end_day, norm_abund_corr, grew)
```


```{r}
# Calculate grow:no-grow ratio
grow_ratio <- data.frame()

for (i in unique(normabund_pap$Inoculant)) {
  for (d in unique(normabund_pap$Day)) {
    # Calculate gained abundance for each taxon
    grow_total <- filter(normabund_pap, Inoculant==i & Day==d & grew=="yes") %>% 
      mutate(growing = if_else(start_day <= d & end_day >= d, "yes", "no")) %>% # make sure growing on day of interest 
      filter(growing == "yes") %>% 
      summarize(total = sum(norm_abund_corr, na.rm=TRUE)) %>% 
      select(total) %>% 
      as.numeric()
    nogrow_total <- filter(normabund_pap, Inoculant==i & Day==d) %>% 
      mutate(growing = if_else(grew=="yes" & start_day <= d & end_day >= d, "yes", "no")) %>% 
      filter(growing == "no" | grew=="no") %>% 
      summarize(total = sum(norm_abund_corr, na.rm=TRUE)) %>% 
      select(total) %>% 
      as.numeric()
    ratio <- grow_total/nogrow_total # growing biomass/non-growing biomass
    add_row <- bind_cols(Inoculant=i, Day=d, ratio=ratio)
    grow_ratio <- bind_rows(grow_ratio, add_row)
  }
}

# Add respiration data
resp_mean <- resp_rate %>% 
  group_by(Inoculant, Day) %>% 
  summarize(mgCO2_day = mean(mgCO2_day))
ratio_resp <- inner_join(grow_ratio, resp_mean)
```

Visualize:

```{r}
ratio_resp %>% 
  ggplot(aes(x=mgCO2_day, y=log(ratio))) +
  geom_point() +
  theme_test()
```

# ARCHIVE

## Mean growth rate efficiency

Calculate efficiency:

```{r}
growth_resprate %>%
  mutate(eff = weighted_k/mgCO2_day) %>% 
  ggplot(aes(x=Day, y=eff)) +
  geom_point() +
  geom_smooth(method="lm", linetype=2) +
  theme_test()
```

# Ratio with growth efficiency

```{r}
ratio_eff <- inner_join(growth_eff, ratio_resp)

ratio_eff %>% 
  ggplot(aes(x=Day, y=log(growth_eff), size=ratio)) +
  geom_point() +
  #geom_smooth(method="lm", linetype=2) +
  theme_test()
```


## Cellular production rate vs respiration rate

Calculate cellular production rate:

Steps
* cellular production = specific growth rate x log corrected normalized abundance at time point
* Sum for total per day

This results in a measure of total new biomass that will be produced at that time point.

Note: multiply by log normalized abundance because k is calculated using log transformed abundance data.

```{r}
# Calculate total cellular production per day
cell_prod <- data.frame()

for (i in unique(growth_abund$Inoculant)) {
  for (d in unique(growth_abund$Day)) {
    data_subset <- filter(growth_abund, Inoculant==i & Day==d) %>% 
      filter(start_day <= d & end_day >= d) %>% # remove taxa that did not grow on given day
      mutate(cell_prod = k*log(norm_abund_corr)) # calculate cellular production by multiplying specific growth rate by log abundance
    cell_prod_total <- sum(data_subset$cell_prod) # total
    add_row <- bind_cols(Inoculant=i, Day=d, cell_prod=cell_prod_total)
    cell_prod <- bind_rows(cell_prod, add_row)
    }
}
```

Visualize:

```{r}
cell_prod %>% 
  ggplot(aes(x=Day, y=cell_prod)) +
  geom_jitter() +
  geom_smooth(linetype=2) +
  labs(title="Total cellular production over time") +
  theme_test()
```

Combine with respiration data:

```{r}
cell_prod_resp <- cell_prod %>% 
  inner_join(resp_rate_inoc, by=c("Inoculant", "Day"))
```

Correlation:

```{r}
cell_prod_resp %>% 
  ggplot(aes(x=mgCO2_day, y=cell_prod)) +
  geom_point() +
  geom_smooth(method="lm", linetype=2) +
  #facet_wrap(~Inoculant) +
  theme_test()
```

Statistics:

```{r}
cor.test(cell_prod_resp$mgCO2_day, cell_prod_resp$cell_prod)
```

## Cellular production efficiency

Calculate the ratio of CO2 respiration rate to log cellular production rate to estimate a proxy for efficiency.

Note: high efficiency proxy would be higher number because less CO2 produced per cellular production

```{r}
cell_prod_resp <- cell_prod_resp %>% 
  mutate(eff_proxy = cell_prod/mgCO2_day)
```

Save output for use in other scripts:

```{r, eval=FALSE}
saveRDS(cell_prod_resp, file="../data_intermediate/SFA2_cellprod_eff.rds")
```

Visualize over time:

```{r}
cell_prod_resp %>% 
  ggplot(aes(x=Day, y=eff_proxy)) +
  geom_point() +
  geom_smooth(method="lm", linetype=2) +
  theme_test()
```

Statistics:

```{r}
cor.test(cell_prod_resp$eff_proxy, cell_prod_resp$Day)
```


