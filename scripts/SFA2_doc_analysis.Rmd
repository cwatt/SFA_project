---
title: "SFA2 - DOC analysis"
author: "Cassandra Wattenburger"
date: "1/22/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(results = "show")
```

**Goal of this script:** Analyze DOC data from SFA2.

```{r}
rm(list=ls())

library(tidyverse)
require(broom)
library(lmerTest)
```

# Import DOC data

```{r}
# Import data
doc = readRDS("../data_DOC/SFA2/SFA2_doc.rds") %>%
  mutate(sample_id = as.numeric(sample_id)) %>%
  select(sample_id, "doc"=mean)

# Import metadata
meta = read.csv("../data_DOC/SFA2/SFA2_doc_metadata.csv") %>% 
  mutate(Inoculant = as.character(Inoculant))
  
# Merge
doc.meta = full_join(meta, doc, by=c("Sample" = "sample_id"))
```

# Visualize

```{r}
ggplot(doc.meta, aes(x=Inoculant, y=doc, color=DOC_pheno)) +
  geom_point() +
  facet_wrap(~Group) +
  theme_test() +
  labs(x="Sample", y="DOC conc.")

ggplot(doc.meta, aes(x=DOC_pheno, y=doc)) +
  geom_boxplot() +
  facet_wrap(~Group) +
  theme_test() +
  labs(x="Sample", y="DOC conc.")

doc.plot <- doc.meta %>%
  filter(DOC_pheno != "control", Group=="Headspace") %>%
  ggplot(aes(DOC_pheno, y=doc)) +
  geom_boxplot() +
  labs(x="DOC \"phenotype\"", y="DOC conc. (ppm)") +
  #annotate("text", x=2.1, y=950, label="P-value = 0.0123") +
  theme_test() +
  theme(title = element_text(size=18),
        axis.title = element_text(size=16),
        axis.text = element_text(size=14))
doc.plot
```

# Statistics

Test separately for headspace and growth experiments.

**Headspace microcosms**

Linear mixed effects model to allow inoculant to be random effect.

```{r}
headspace.doc = filter(doc.meta, Group=="Headspace" & Type=="Sample")
head.doc.lmer = lmer(doc ~ DOC_pheno + (1 + DOC_pheno|Inoculant), data = headspace.doc) # linear mixed effects model, allow inoculant to vary independently
hist(residuals(head.doc.lmer))
plot(predict(head.doc.lmer), residuals(head.doc.lmer))
anova(head.doc.lmer)
```

**Growth microcosms**

Linear mixed effects model to allow inoculant to be random effect.

```{r}
growth.doc = filter(doc.meta, Group=="Growth" & Type=="Sample")
grow.doc.lmer = lmer(log(doc) ~ DOC_pheno + (1 + DOC_pheno|Inoculant), data = growth.doc) # linear mixed effects model, allow inoculant to vary independently
hist(residuals(grow.doc.lmer))
plot(predict(grow.doc.lmer), residuals(grow.doc.lmer)) # Heteroskedastic
anova(grow.doc.lmer)
```

# Full model

```{r}
full_lm <- lm(log(doc) ~ DOC_pheno*Group, data=filter(doc.meta, DOC_pheno!="control"))
hist(resid(full_lm))
plot(predict(full_lm), resid(full_lm))
anova(full_lm)
```

**Headspace vs growth**

```{r}
headgr_doc_lmer = lmer(log(doc) ~ Group + DOC_pheno + Group:DOC_pheno + (1|Inoculant), data = filter(doc.meta, Type=="Sample")) 
hist(residuals(headgr_doc_lmer))
plot(predict(headgr_doc_lmer), residuals(headgr_doc_lmer))
anova(headgr_doc_lmer)
emmeans(headgr_doc_lmer, specs=pairwise ~ Group:DOC_pheno, adjust="none")
```

# DOC vs CO2

Is there a relationship between DOC and CO2?

```{r}
# Import CO2 data
co2 = readRDS("../data_CO2/SFA2/SFA2_CO2.rds") %>%
  rename(DOC_pheno = DOC_predict) %>% 
  mutate(Inoculant = as.character(Inoculant))

doc.co2 = full_join(headspace.doc, co2, by=c("Sample", "Inoculant", "DOC_pheno"))
```

**Visualize**

```{r}
doc.co2 %>%
  filter(DOC_pheno != "NA") %>%
  ggplot(aes(x=doc, y=totalCO2mg)) +
  geom_point(aes(color=DOC_pheno)) +
  geom_smooth(method="lm") +
  theme_test()
```

No relationship between DOC and CO2.

# DOC vs protein

Assessing to check that the starting volume of inoculant did not affect DOC outcome. Making sure the protein measurement allowed us to control for starting biomass.

```{r}
# Import protein metadata
prot = read_csv("~/SFAgrowthrate/data_protein/SFA1_washprotein_metadata.csv")
head.doc.prot = left_join(headspace.doc, prot, by=c("Inoculant"="Sample"))
```

**Visualize**

```{r}
doc.prot %>% 
  ggplot(aes(x=Volume, y=doc)) +
  geom_point() +
  geom_smooth(method="lm") +
  theme_test()
```

No clear relationship.