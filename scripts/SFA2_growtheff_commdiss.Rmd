---
title: "SFA - growth efficiency difference vs community dissimilarity"
author: "Cassandra Wattenburger"
date: "11/16/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

```{r}
# Import libraries
library(vegan)
library(phyloseq)
library(tidyverse)
library(cowplot)

sessionInfo()

# Clear environment
rm(list=ls())
```

# Import data

* metadata
* growth efficiency calculations
* rarefied physeq
* unrarefied physeq

```{r}
# Metadata
meta <- read_tsv("../data_amplicon/SFA2_full/SFA2_metadata_corrected.tsv")
# Growth efficiency
groweff <- readRDS("../data_intermediate/SFA2_growtheff.rds")
# Rarefied count
physeq_rare <- readRDS("../data_intermediate/SFA2_physeq_rare.rds")
# Not rarefied counts
physeq_unrare <- readRDS("../data_intermediate/SFA2_physeq_unrare.rds")
```

# Rarefying losses

How much data lost to rarefication?

```{r}
# How many taxa/samples are lost to rarefication?
physeq_rare
physeq_unrare

# Per sample?
rare_count <- data.frame(otu_table(physeq_rare))
unrare_count <- data.frame(otu_table(physeq_unrare))

# Count ASVs per sample
rare_binary <- rare_count %>% 
  mutate(across(everything(), ~if_else(. > 1, 1, 0)))
rare_binary <- colSums(rare_binary)
rare_sams <- names(rare_binary) # samples left after rarefication

unrare_binary <- unrare_count %>% 
  mutate(across(everything(), ~if_else(. > 1, 1, 0)))
unrare_binary <- colSums(unrare_binary)
unrare_binary <- unrare_binary[names(unrare_binary) %in% rare_sams] # filter samples not in rarefied
  
# Combine
rich_compare <- data.frame(rare=rare_binary, unrare=unrare_binary) %>% 
  mutate(diff = unrare - rare)

# Visualize
rich_compare %>% 
  ggplot(aes(x=reorder(rownames(.), diff), y=diff)) +
  geom_point() +
  labs(x="sample", y="difference in ASVs") +
  theme_test()

rich_compare %>%
  mutate(SampleID = rownames(.),
         SampleID = gsub("sa", "", SampleID),
         SampleID = as.numeric(SampleID)) %>% 
  inner_join(meta) %>% 
  ggplot(aes(x=Day, y=diff)) +
  geom_point() +
  labs(x="Day", y="difference in ASVs") +
  theme_test()
```

Calculate relative abundances:

```{r}
physeq_relabund <- transform_sample_counts(physeq_unrare, function(x) x/sum(x))
```

Compare oridnations:

```{r}
set.seed(2)

# Rarefied
wuni_rare <- distance(physeq_rare, method="wunifrac")
rare_pcoa <- ordinate(physeq_rare, method="PCoA", distance=wuni_rare)

# Relative abundances
wuni_relabund <- distance(physeq_relabund, method="wunifrac")
relabund_pcoa <- ordinate(physeq_relabund, method="PCoA", distance=wuni_relabund)

# Visualize
plot_ordination(physeq_rare, rare_pcoa, color="Day") +
  theme_test()
plot_ordination(physeq_relabund, unrare_pcoa, color="Day") +
  theme_test()
```

# Calculate community dissimilarity

* Using relative abundance data because it looks similar to rarefied w/similar dispersion but doesn't throw out data

Average replicates:

```{r}
nongrowth_sams <- filter(meta, Type!="Growth")
nongrowth_sams <- nongrowth_sams$SampleID

# Average technical replicates
relabund_avg <- data.frame(otu_table(physeq_relabund)) %>% # lots of reformatting needed
  as.matrix() %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var="SampleID") %>%  
  pivot_longer(cols=c(-SampleID), names_to="ASV", values_to="relabund") %>% # long format
  mutate(SampleID = gsub("sa", "", SampleID),
         SampleID = as.numeric(SampleID)) %>% 
  filter(!(SampleID %in% nongrowth_sams)) %>% 
  inner_join(meta) %>% # add metadata
  mutate(ucosm = paste0(Inoculant, Day)) %>%
  group_by(ucosm, ASV) %>% 
  summarize(relabund_avg = mean(relabund)) %>% # calc. mean
  ungroup() %>% 
  pivot_wider(names_from=ASV, values_from=relabund_avg) %>% 
  column_to_rownames(var="ucosm") %>% # reformat back
  as.matrix() %>% 
  t()

# Add metadata
meta2 <- meta %>% 
  filter(Type=="Growth") %>% 
  mutate(ucosm = paste0(Inoculant, Day)) %>% 
  select(ucosm, Type, Inoculant, Day) %>% 
  unique() %>% 
  mutate(ucosm2 = ucosm) %>% 
  arrange(ucosm) %>% 
  column_to_rownames(var="ucosm2")

# Phyloseq reobjectify
physeq_relabund_avg <- phyloseq(otu_table(relabund_avg, taxa_are_rows = TRUE), 
                                sample_data(meta2), phy_tree(physeq_relabund))

# Remove samples not in the growth efficiency dataset
greff_meta <- groweff %>% 
  mutate(ucosm = paste0(Inoculant, Day)) %>% 
  filter(!is.na(Day)) %>% # remove na rows
  arrange(ucosm)

greff_ucosms <- unique(greff_meta$ucosm)

physeq_relabund_sub <- subset_samples(physeq_relabund_avg, ucosm %in% greff_ucosms)
physeq_relabund_sub
```

```{r}
# Calculate community distances
wuni_relabund <- distance(physeq_relabund_sub, method="wunifrac")
wuni_mx <- as.matrix(wuni_relabund)
```

# Calculate efficiency differences

```{r}
# Convert to matrix
groweff_mx <- greff_meta %>%  
  select(ucosm, growth_eff) %>% 
  arrange(ucosm) %>% 
  column_to_rownames(var="ucosm") %>% 
  as.matrix()

wuni_colorder <- colnames(wuni_mx)

# Calculate difference into distance matrix
greff_dist <- dist(groweff_mx, method="maximum") 
greff_mx <- as.matrix(greff_dist)

greff_mx <- as.data.frame(greff_mx) %>% # reorder to match wuni dist matrix
  select(`1010`, `1012`, `1014`, `1016`, `1018`, `1021`, `1024`, `1027`, `103`, `103.5`, `1030`, `104`, `104.5`, `105`, `105.5`, `106`, `107`, `108`, `109`, `1210`, `1212`, `1214`, `1216`, `1218`, `1221`, `1224` , `1227`, `123`, `123.5`, `1230`, `124`, `124.5`, `125`, `125.5`, `126`, `127`, `128`, `129`, `1910` , `1912`, `1914`, `1916`, `1918`, `1921`, `1924`, `1927`, `193`, `193.5`, `1930`, `194`, `194.5`, `195`, , `195.5`, `196`, `197`, `198`, `199`, `210`, `212`, `214`, `216`, `218`, `221`, `224`, `227`, , `23`, , `23.5`, `230`, `24`, , `24.5`, `25`, , `25.5`, `26`, , `27`, , `28`, , `29`, , `4110`, `4112` , `4114`, `4116`, `4118`, `4121`, `4124`, `4127`, `413`, `413.5`, `4130`, `414`, `414.5`, `415`, `415.5`, `416`, `417`, `418`, `419`, `4710`, `4712`, `4714`, `4716`, `4718`, `4721`, `4724`, `4727`, `473`, `473.5`, `4730`, `474`, `474.5`, `475`, `475.5`, `476`, `477`, `478`, `479`) %>% 
  as.matrix()
```

# Mantel test

```{r}
# Mantel test
mantel(wuni_mx, greff_mx)
```

# Dispersion vs. growth efficiency

```{r}
# Import data
wuni_rep <- readRDS("SFA_wunidist_withinreps.rds")

# Combine with growth efficiency 
greff_wuni <- inner_join(groweff, wuni_rep) %>% 
  filter(!is.na(wuni_dist)) # remove na rows

# Visualize
greff_wuni %>%
  ggplot(aes(x=wuni_dist, y=log(growth_eff))) +
  geom_point() +
  geom_smooth(method="lm") +
  theme_test()
```
 
Pearson Correlation:
 
```{r}
cor.test(greff_wuni$wuni_dist, greff_wuni$growth_eff, method="pearson")
```
 
