---
title: "Climax community"
author: "Cassandra Wattenburger"
date: "4/13/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

```{r}
# Clear working directory, load in packages, generate package info
rm(list=ls())

library("tidyverse")

sessionInfo()
```

# Notes

# Import data

* metadata
* growth estimates
* normalized abundances
* rarefied phyloseq

```{r}
# Metadata
meta <- readRDS("../data_intermediate/SFA2_metadata.rds")

# Growth estimates
growth <- readRDS("../data_intermediate/SFA2_growth_estimates_pap.rds")

# Normalized abundance data
norm <- readRDS("../data_intermediate/SFA2_normalized.rds")

# Rarefied phyloseq
physeq <- readRDS("../data_intermediate/SFA2_physeq_rare.rds")
```

# Idenitfy climax community

Defining as when the total normalized abundance of each inoculant evens out, indicating balanced growth and death.

### Total normalized abundances

Whole communities:

```{r}
# Add metadata and reformat
meta <- meta %>%
  select(SampleID, Sample, Inoculant, Day, Replicate)

norm_meta <- norm %>%
  full_join(meta)

# Calculate total normalized abundance through time
norm_total <- norm_meta %>% 
  group_by(Inoculant, Day, ASV) %>% 
  summarize(norm_abund_avg = mean(norm_abund, na.rm=TRUE)) %>% # average across reps
  ungroup() %>%
  group_by(Inoculant, Day) %>%
  summarize(whole = sum(norm_abund_avg, na.rm=TRUE)) %>% # calc total abund
  ungroup()

# Visualize
norm_total %>% 
  filter(Inoculant %in% c(10, 12,19, 2, 41,47)) %>% 
  ggplot(aes(x=Day, y=log(whole), color=Inoculant)) +
  geom_point() +
  geom_line() +
  labs(title="Total community normalized abundance") +
  theme_test()
```

Growers only:

```{r}
# Make a label
growth_labels <- growth %>% 
  mutate(label = paste0(Inoculant, ASV)) %>%
  select(label)

# Calculate total normalized abundance through time
norm_total_gr <- norm_meta %>% 
  mutate(label = paste0(Inoculant, ASV)) %>% 
  inner_join(growth_labels) %>% # isolate growing taxa only
  group_by(Inoculant, Day, ASV) %>% # average across replicates
  summarize(norm_abund_avg = mean(norm_abund, na.rm=TRUE)) %>% 
  ungroup() %>%
  group_by(Inoculant, Day) %>% # total normalized abundance
  summarize(growth = sum(norm_abund_avg, na.rm=TRUE)) %>%
  ungroup()

# Visualize
norm_total_gr %>% 
  ggplot(aes(x=Day, y=log(growth), color=Inoculant)) +
  geom_point() +
  geom_line() + 
  labs(title="Growing taxa total normalized abundance") +
  theme_test()
```

Together:

```{r}
# Combine whole community and growing community normalized abundance totals
norm_total_all <- norm_total %>% 
  inner_join(norm_total_gr) %>% 
  pivot_longer(-c(Inoculant, Day), names_to="type", values_to="norm_abund")

# Visualize
norm_total_all %>% 
  ggplot(aes(x=Day, y=log(norm_abund), alpha=type)) + 
  geom_point() +
  geom_line() +
  facet_wrap(~Inoculant) +
  theme_test()
```

Most abundance is made up of taxa with growth estimates after day 3 or 4, indicating we did a pretty good job of capturing the growers/major players in the bottles.

Average total abundance across inoculants:

```{r}
norm_total_all %>% 
  group_by(Day, type) %>%
  summarize(norm_abund = mean(norm_abund, na.rm=TRUE)) %>% 
  ungroup() %>% 
  ggplot(aes(x=Day, y=log(norm_abund))) +
  geom_point(aes(shape=type)) +
  geom_line(aes(linetype=type)) +
  geom_vline(xintercept = 9, linetype=2) +
  theme_test()
```

Day 9 seems to be where the total abundances start to "even out". We'll define this until the end of the incubation as the climax community.

Define pre and post-climax:

```{r}
 
```
















### Alpha diversity

* at each tp, each inoc
* richness, shannon, evenness

```{r}

  

```

### Beta diversity

* weighted unifrac comparisons across time for each rep