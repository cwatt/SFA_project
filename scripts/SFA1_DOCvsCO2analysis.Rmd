---
title: "SFA1 - DOC vs CO2 analysis"
author: "Cassi Wattenburger"
date: "3/17/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(results = "hide")
```

**Goal of this script:** Identify high and low DOC-producing communties from soil microcosms

```{r}
rm(list=ls())

library(tidyverse)
require(broom)
library(reshape2)
library(plyr)
library(car)
```

```{r}
# Import data

# DOC
load("../data_DOC/SFA1/SFA1_DOC.data.RData")

# CO2
load("../data_CO2/SFA1/SFA1_CO2.data.RData")

```

```{r}
# Reformat data so they fit together
DOC.data=DOC.data[,c(1,3,6)]
colnames(DOC.data)=c("ucosm","DOC","Sample")
DOC.data=subset(DOC.data, !(Sample=="Abiotic" | Sample=="Blank"))# remove controls

CO2.data=CO2.data[,1:3]
colnames(CO2.data)=c("ucosm","Sample","CO2")

both.data=merge(DOC.data, CO2.data, by="ucosm")
both.data=both.data[,c(3,1,2,5)]
colnames(both.data)[1]="Sample"

# Average replicates
DOC.avg=ddply(DOC.data[,-1], c("Sample"), summarize, DOC.avg=mean(DOC))
CO2.avg=ddply(CO2.data[,-1], c("Sample"), summarize, CO2.avg=mean(CO2))
both.avg=merge(DOC.avg, CO2.avg)
```

```{r}
hi=c(50,42,4,47,2,19)
lo=c(31,32,17,10,12,41)
both.data = mutate(both.data, type=ifelse(Sample==51, "negative", ifelse(Sample %in% hi, "high", ifelse(Sample %in% lo, "low", "sample"))))

ggplot(both.data, aes(x=Sample, y=DOC, color=type)) +
  geom_boxplot() +
  labs(title="DOC variability") +
  theme_test() +
  theme(axis.text.x = element_text(angle=45))

ggplot(both.data, aes(x=Sample, y=CO2, color=type)) +
  geom_boxplot() +
  labs(title="CO2 variability") +
  theme_test() +
  theme(axis.text.x = element_text(angle=45))
```

```{r}
# Remove negative control
both.data=subset(both.data, !Sample==51)
both.avg=subset(both.avg, !Sample==51)

# Is the data normal?
qplot(both.avg$DOC) # looks lognormal
qplot(log(both.avg$DOC)) # maybe
qplot(both.avg$CO2) # normalish
qplot(log(both.avg$CO2))

shapiro.test(both.avg$DOC.avg) # normal
shapiro.test(log(both.avg$DOC.avg)) # normal
shapiro.test(both.avg$CO2.avg) # normal
shapiro.test(log(both.avg$CO2.avg)) # normal

# Data is likely normal enough to not violate assumption of normality, use parametric tests

# Pearson correlation test
test.avg=cor.test(both.avg$DOC, both.avg$CO2, method="pearson")
test.avg
#p=5.315e-09, conf ints: 0.545, 0.828, cor=0.715

# Linear regression fit
test.fit=lm(DOC.avg ~ CO2.avg, both.avg)
summary(test.fit)
# slope = 8.342
```

```{r}
docco2.biplot=ggplot(both.avg, aes(x=DOC.avg, y=CO2.avg)) +
  geom_point(size=2) +
  geom_smooth(method=lm, linetype=2) +
  labs(x="DOC (ppm)", y=bquote('Total respired CO'[2]~'(mg)')) +
  theme_test() +
  theme(title = element_text(size=18),
        axis.title = element_text(size=16),
        axis.text = element_text(size=14))
docco2.biplot
```

```{r, eval=FALSE, include=FALSE}
ggsave("../figures/SFA1_DOCvsCO2.graph.png", plot=docco2.biplot, width=250, height=150, units="mm")
```

### Standardization check

Let's check if there are any correlations between my dilution standardization and DOC or CO2 production. I want to make sure that the standarization removed any effects of initial biomass on DOC production. If the protein measurements were incorrect, more soil wash added would mean more initial biomass and likely CO2 and DOC production.

```{r}
prot.meta = read.csv("SFA1_washprotein_metadata.csv")

prot.DOC = merge(both.avg, prot.meta, by.x=1, by.y=1)

ggplot(prot.DOC, aes(x=DOC.avg, y=Volume)) +
  geom_point() +
  theme_test() +
  labs(x="DOC", y="Volume of wash used")

ggplot(prot.DOC, aes(x=CO2.avg, y=Volume)) +
  geom_point() +
  theme_test() +
  labs(x="CO2", y="Volume of wash used")

```

No correlation with wash dilution. Means that the protein standardization likely worked and initial biomass is not a confounding factor!

High and low DOC producing samples:

```{r}
high = arrange(both.avg, desc(DOC.avg))
high = high[1:6,]
low = arrange(both.avg, DOC.avg)
low = low[1:6,]
```

```{r, results="show"}
high
low
```

