---
title: "Growth and death dynamics during exponential and stationary phases"
author: "Cassandra Wattenburger"
date: "4/13/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

```{r}
# Clear working directory, load in packages, generate package info
rm(list=ls())

library("phyloseq")
library("vegan")
library("tidyverse")
library("lmerTest")
library("cowplot")

sessionInfo()

# I can't type "head" apparently so I'm going to make an alias
h <- function(x) {head(x)}
```

# Notes

* Copy of SFA2_expstatphases_growthdeath
* Plan to clean up

# Import data

* metadata
* growth estimates
* normalized abundances
* rarefied phyloseq

```{r}
# Metadata
meta <- readRDS("../data_intermediate/SFA2_metadata.rds")

# Growth estimates
growth <- readRDS("../data_intermediate/SFA2_growth_estimates_pap.rds")

# Death estimates
death <- readRDS("../data_intermediate/SFA2_death_estimates_pap.rds")

# All paprica estimates
pap_all <- readRDS("../data_intermediate/SFA2_paprica_all.rds")

# Normalized abundance data
norm <- readRDS("../data_intermediate/SFA2_normalized.rds")

# Rarefied phyloseq
physeq <- readRDS("../data_intermediate/SFA2_physeq_rare.rds")
```

# Total abundance

Defining as when the total normalized abundance of each inoculant evens out, indicating balanced growth and death.

## All taxa

```{r}
# Add metadata and reformat
meta <- meta %>%
  select(SampleID, Sample, Inoculant, Day, Replicate)

norm_meta <- norm %>%
  full_join(meta)

pap_slim <- pap_all %>% 
  select(ASV, n16S)

# Calculate total normalized abundance through time
norm_whole_total <- norm_meta %>% 
  inner_join(pap_slim) %>% # add 16S copy predictions
  mutate(norm_abund_corr = norm_abund / n16S) %>% # correct normalized abundance by 16S copies
  group_by(Inoculant, Day, ASV) %>% # average across replicates
  summarize(norm_abund_corr = mean(norm_abund_corr, na.rm=TRUE)) %>% 
  ungroup() %>%
  group_by(Inoculant, Day) %>%  # sum across ASVs
  summarize(total = sum(norm_abund_corr, na.rm=TRUE)) %>%
  ungroup() %>%
  filter(Inoculant %in% c(10, 12,19, 2, 41, 47)) %>% # remove controls
  select(Inoculant, Day, total) # tidy

# Calculate overall avg
norm_whole_avg <- norm_whole_total %>% 
  group_by(Day) %>% 
  summarize(total = mean(total)) %>% 
  ungroup() %>% 
  add_column(Inoculant="avg") %>% 
  select(Inoculant, Day, total)
```

Visualize:

```{r}
plot_whole_total <- norm_whole_total %>% 
  add_row(norm_whole_avg) %>% 
  mutate(fade = if_else(Inoculant!="avg", "avg", "inoc")) %>% 
  ggplot(aes(x=Day, y=log(total), group=Inoculant, alpha=fade)) +
  geom_point() +
  geom_line() + 
  geom_vline(xintercept=9, linetype=2) +
  labs(title="Summed normalized abundance of all taxa", y="ln summed normalized abundance") +
  theme_test() +
  theme(legend.position = "none")
plot_whole_total
```

## Growing taxa

```{r}
# Add metadata and reformat
meta <- meta %>%
  select(SampleID, Sample, Inoculant, Day, Replicate)

norm_meta <- norm %>%
  full_join(meta)

# Make a label for growing ASVs
growth_labels <- growth %>% 
  mutate(label = paste0(Inoculant, ASV)) %>%
  select(label, n16S)

# Calculate total normalized abundance through time
norm_growth_total <- norm_meta %>% 
  mutate(label = paste0(Inoculant, ASV)) %>% 
  inner_join(growth_labels) %>% # isolate growing taxa only
  mutate(norm_abund_corr = norm_abund / n16S) %>% # correct normalized abundance by 16S copies
  group_by(Inoculant, Day, ASV) %>% # average across replicates
  summarize(norm_abund_corr = mean(norm_abund_corr, na.rm=TRUE)) %>% 
  ungroup() %>%
  group_by(Inoculant, Day) %>% 
  summarize(total = sum(norm_abund_corr)) %>% # total normalized abundances
  ungroup() %>%
  filter(Inoculant %in% c(10, 12,19, 2, 41,47)) %>% # remove controls
  select(Inoculant, Day, total)

# Calculate overall avg
norm_growth_avg <- norm_growth_total %>% 
  group_by(Day) %>% 
  summarize(total = mean(total)) %>% 
  ungroup() %>% 
  add_column(Inoculant="avg") %>% 
  select(Inoculant, Day, total)
```

Visualize:

```{r}
plot_grow_total<- norm_growth_total %>% 
  add_row(norm_growth_avg) %>% 
  mutate(fade = if_else(Inoculant!="avg", "avg", "inoc")) %>% 
  ggplot(aes(x=Day, y=log(total), group=Inoculant, alpha=fade)) +
  geom_point() +
  geom_line() + 
  geom_vline(xintercept=9, linetype=2) +
  labs(title="Summed normalized abundance of growing taxa", y="ln summed normalized abundance") +
  coord_cartesian(xlim = c(0, 30)) +
  theme_test() +
  theme(legend.position = "none")
plot_grow_total 
```

# Group ASVs

Group 1: start_day end_day <= 9 (grew during exponential phase only)
group 2: end_day  > 9 (grew during exponential and/or stationary phases)

```{r}
# Growth
growth_grp <- growth %>% 
  mutate(group = if_else(end_day <= 9, "grp1", "grp2"),
         group = as.factor(group))

# Death
death_grp <- death %>% 
  mutate(group = if_else(end_day <= 9, "grp 1", "grp2"),
         group = as.factor(group))
```

Summary of number ASVs per group:

```{r}
growth_grp %>% 
  group_by(Inoculant, group) %>% 
  summarize(total = n()) %>% 
  ungroup() %>% 
  group_by(group) %>% 
  summarize(total_mean = mean(total), total_sd = sd(total)) %>% 
  ungroup()

death_grp %>% 
  group_by(Inoculant, group) %>% 
  summarize(total = n()) %>% 
  ungroup() %>% 
  group_by(group) %>% 
  summarize(total_mean = mean(total), total_sd = sd(total)) %>% 
  ungroup()
```

Summary of phylogenetic placements in groups:

* Phylum level

```{r}
growth_grp %>% 
  group_by(Inoculant, group, Phylum) %>% 
  summarize(total = n()) %>% 
  ungroup() %>% 
  group_by(group, Phylum) %>% 
  summarize(total_mean = mean(total, na.rm=TRUE), total_sd = sd(total, na.rm=TRUE)) %>% 
  ungroup() %>% 
  arrange(group, desc(total_mean))
```

```{r}
death_grp %>% 
  group_by(Inoculant, group, Phylum) %>% 
  summarize(total = n()) %>% 
  ungroup() %>% 
  group_by(group, Phylum) %>% 
  summarize(total_mean = mean(total, na.rm=TRUE), total_sd = sd(total, na.rm=TRUE)) %>% 
  ungroup() %>% 
  arrange(group, desc(total_mean))
```

## Growth group examples

```{r}
# 157, 129
# group 1
growth_grp1_ex <- growth_grp %>% 
  filter(ASV==growth[157,]$ASV & Inoculant==growth[157,]$Inoculant) # see growth estimation plots from script 03

# Prepare abudnance table
norm_grp1_ex <- norm_meta %>%
  filter(ASV==growth[157,]$ASV & Inoculant==growth[157,]$Inoculant) %>% 
  group_by(Inoculant, Day) %>% 
  summarize(norm_abund_avg = mean(norm_abund, na.rm=TRUE)) %>% # average across technical replicates
  ungroup() %>% 
  arrange(Day) %>% 
  filter(norm_abund_avg > 0) # filter missing values
              
# Visualize
plot_grp1_ex <- norm_grp1_ex %>% 
  ggplot(aes(x=Day, y=log(norm_abund_avg))) +
  geom_point(shape=1, size=3, color="#6F7378") +
  geom_line(color="#6F7378") +
  geom_vline(xintercept=9, linetype=2) +
  geom_smooth(method="lm", data=norm_grp1_ex[growth_grp1_ex$start_pt:growth_grp1_ex$end_pt,], linetype=2, color="black") +
  labs(title=paste0("group 1 example - ", growth_grp1_ex$Phylum, ", ", growth_grp1_ex$Genus), x="Day", y="ln normalized abundance") +
  coord_cartesian(xlim = c(0, 30)) +
  theme_test()
plot_grp1_ex
```

```{r}
# group 2
growth_grp2_ex <- growth_grp %>% 
  filter(ASV==growth[79,]$ASV & Inoculant==growth[79,]$Inoculant) # see growth estimation plots from script 03

# Prepare abudnance table
norm_grp2_ex <- norm_meta %>%
  filter(ASV==growth[79,]$ASV & Inoculant==growth[79,]$Inoculant) %>% 
  group_by(Inoculant, Day) %>% 
  summarize(norm_abund_avg = mean(norm_abund, na.rm=TRUE)) %>% # average across technical replicates
  ungroup() %>% 
  arrange(Day) %>% 
  filter(norm_abund_avg > 0) # filter missing values
              
# Visualize
plot_grp2_ex <- norm_grp2_ex %>% 
  ggplot(aes(x=Day, y=log(norm_abund_avg))) +
  geom_point(shape=1, size=3, color="#6F7378") +
  geom_line(color="#6F7378") +
  geom_vline(xintercept=9, linetype=2) +
  geom_smooth(method="lm", data=norm_grp2_ex[growth_grp2_ex$start_pt:growth_grp2_ex$end_pt,], linetype=2, color="black") +
  labs(title=paste0("group 2 example - ", growth_grp2_ex$Phylum, ", ", growth_grp2_ex$Genus), x="Day", y="ln normalized abundance") +
  coord_cartesian(xlim = c(0, 30)) +
  theme_test()
plot_grp2_ex
```

All together:

```{r}
# Comgroupe examples into one df
norm_grp1_ex <- add_column(norm_grp1_ex, group="grp1")
norm_grp2_ex <- add_column(norm_grp2_ex, group="grp2")
norm_grps_ex <- bind_rows(norm_grp1_ex, norm_grp2_ex)

# Visualize
norm_grps_ex %>% 
  ggplot(aes(x=Day, y=log(norm_abund_avg))) +
  geom_point(size=3, aes(shape=group)) +
  geom_line(aes(group=group)) +
  geom_vline(xintercept=9, linetype=2) +
  # Growth estimates
  geom_smooth(method="lm", data=norm_grp1_ex[growth_grp1_ex$start_pt:growth_grp1_ex$end_pt,], linetype=2, alpha=0.2) +
  geom_smooth(method="lm", data=norm_grp2_ex[growth_grp2_ex$start_pt:growth_grp2_ex$end_pt,], linetype=2, alpha=0.2) +
  #labs(title=paste0("group 3 example -", growth_grp3_ex$Phylum, ", ", growth_grp3_ex$Genus), x="Day", y="ln normalized abundance") +
  coord_cartesian(xlim = c(0, 30)) +
  theme_test()
```

## Summary

```{r}
growth_grp %>% 
  group_by(Inoculant, group) %>% 
  summarize(total=n()) %>% 
  ungroup() %>% 
  group_by(group) %>% 
  summarize(mean = mean(total),
            sd = sd(total))

death_grp %>% 
  group_by(Inoculant, group) %>% 
  summarize(total=n()) %>% 
  ungroup() %>% 
  group_by(group) %>% 
  summarize(mean = mean(total),
            sd = sd(total))
```



# Growth traits

* growth rates
* change in abundance
* n16S

Visualize:

```{r}
# k
growth_grp %>% 
  ggplot(aes(x=group, y=k)) +
  geom_boxplot() +
  geom_jitter(size=2, alpha=0.5) +
  theme_test() +
  labs(y="Growth rate (day-1)", x="") +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 15))

# change in abundance
growth_grp %>% 
  ggplot(aes(x=group, y=log(change_abund_corr))) +
  geom_boxplot() +
  geom_jitter(size=2, alpha=0.5) +
  theme_test() +
  labs(y="Normalized abundance change (ln)", x="") +
  theme(axis.text = element_text(size = 10),
        axis.title = element_text(size = 12))

# n16S
growth_grp %>% 
  ggplot(aes(x=group, y=n16S)) +
  geom_boxplot() +
  geom_jitter(size=2, alpha=0.5) +
  theme_test() +
  labs(y="16S copy number", x="") +
  theme(axis.text = element_text(size = 10),
        axis.title = element_text(size = 12))
```

## Statistics

Linear mixed effects models with random slopes and intercepts for inoculant

```{r}
# k
k_lmer <- lmer(k ~ group + (1 + Inoculant | Inoculant), growth_grp)
hist(resid(k_lmer))
plot(predict(k_lmer), resid(k_lmer))
anova(k_lmer)

# change abund
chg_lmer <- lmer(log(change_abund_corr) ~ group + (1 + Inoculant | Inoculant), growth_grp)
hist(resid(chg_lmer))
plot(predict(chg_lmer), resid(chg_lmer))
anova(chg_lmer)

# 16S
n16s_lmer <- lmer(log(n16S) ~ group + (1 + Inoculant | Inoculant), growth_grp)
hist(resid(n16s_lmer))
plot(predict(n16s_lmer), resid(n16s_lmer))
anova(n16s_lmer)
```

# Death Traits

Visualize:

```{r}
# k
death_grp %>% 
  ggplot(aes(x=group, y=k)) +
  geom_boxplot() +
  geom_jitter(size=2, alpha=0.5) +
  theme_test() +
  labs(y="Death rate (day-1)", x="") +
  theme(axis.text = element_text(size = 10),
        axis.title = element_text(size = 12))

# change in abundance
death_grp %>% 
  ggplot(aes(x=group, y=log(abs(change_abund_corr)))) +
  geom_boxplot() +
  geom_jitter(size=2, alpha=0.5) +
  theme_test() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 15)) +
  labs(y="Normalized abundance change (ln abs. value)", x="")

# n16S
death_grp %>% 
  ggplot(aes(x=group, y=n16S)) +
  geom_boxplot() +
  geom_jitter(size=2, alpha=0.5) +
  theme_test() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 15)) +
  labs(y="16S copy numbers", x="")
```

### Statistics 

Linear mixed effects models with random slopes and intercepts for inoculant

```{r}
# k
kdeath_lmer <- lmer(log(abs(k)) ~ group + (1 + Inoculant | Inoculant), death_grp)
hist(resid(kdeath_lmer))
plot(predict(kdeath_lmer), resid(kdeath_lmer))
anova(kdeath_lmer)

# change abund
chgdeath_lmer <- lmer(log(abs(change_abund_corr)) ~ group + (1 + Inoculant | Inoculant), death_grp)
hist(resid(chgdeath_lmer))
plot(predict(chgdeath_lmer), resid(chgdeath_lmer))
anova(chgdeath_lmer)

# n16S
n16S_lmer <- lmer(n16S ~ group + (1 + Inoculant | Inoculant), death_grp)
hist(resid(chgdeath_lmer))
plot(predict(chgdeath_lmer), resid(chgdeath_lmer))
anova(chgdeath_lmer)
```

# MESS BELOW

# Correlations

Teasing apart relationship between category and growth traits, is it due to length of growth?

Growth rate vs change abundance:

```{r}
growth_grp %>% 
  mutate(length = end_day-start_day,
         change_abund_length = change_abund_corr/length) %>% 
  ggplot(aes(y=log(change_abund_corr), x=k, color=group)) + 
  geom_point(size=2) +
  geom_smooth(method="lm", linetype=2, alpha=0.1) +
  labs(x="Growth rate (day-1)", y="Relational abundance change (ln)") +
  theme_test() +  
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 15))
```

Length of growth vs growth rates:

```{r}
growth_grp <- growth_grp %>% 
  mutate(length=end_day-start_day) 

growth_grp %>% 
  ggplot(aes(x=length, y=k)) + 
  geom_point() +
  geom_smooth(method="lm", linetype=2) +
  theme_test()
```

Statistics:

* Pearson correlation

```{r}
cor.test(growth_grp$k, growth_grp$length, method="pearson")
```

Length of growth vs change in abundance:

```{r}
growth_grp %>% 
  ggplot(aes(x=length, y=log(change_abund_corr))) + 
  geom_point() +
  geom_smooth(method="lm", linetype=2) +
  theme_test()
```

Statistics:

* Pearson correlation

```{r}
cor.test(log(growth_grp$change_abund_corr), growth_grp$length, method="pearson")
```

Lag vs growth rate:

```{r}
growth_grp %>% 
  ggplot(aes(x=start_day, y=log(k))) + 
  geom_point() +
  geom_smooth(method="lm", linetype=2) +
  theme_test()
```

Lag vs change in abundance:

```{r}
growth_grp %>% 
  ggplot(aes(x=start_day, y=log(change_abund_corr))) + 
  geom_point() +
  geom_smooth(method="lm", linetype=2) +
  theme_test()
```

Statistics:

* Pearson correlation

```{r}
cor.test(log(growth_grp$change_abund_corr), growth_grp$start_day, method="spearm")
```

### Length of growth

```{r}
growth_grp %>% 
  ggplot(aes(x=group, y=log(length), color=group)) +
  geom_jitter() +
  theme_test()
```

Statistics: 

Linear mixed effects models with random slopes and intercepts for inoculant

```{r}
length_lmer <- lmer(log(length) ~ group + (1 + Inoculant | Inoculant), growth_grp)
hist(resid(length_lmer))
plot(predict(length_lmer), resid(length_lmer))
anova(length_lmer)
```

### 16S

```{r}
growth_grp %>% 
  ggplot(aes(x=group, y=log(n16S), color=group)) +
  geom_jitter() +
  labs(y="ln n16S", x="Period of growth")
  theme_test() +
  theme(axis.text = element_text(size = 10),
        axis.title = element_text(size = 12))
```

16S x growth rates

```{r}
growth_grp %>% 
  ggplot(aes(x=n16S, y=k)) +
  geom_point() +
  geom_smooth(method="lm") +
  labs(x="Predicted 16S copy number", y="Growth rate (day-1)") +
  theme_test() +
  theme(axis.text = element_text(size = 10),
        axis.title = element_text(size = 12))
```

16S x change abundance

```{r}
growth_grp %>% 
  ggplot(aes(x=n16S, y=log(change_abund_corr))) +
  geom_point() +
  geom_smooth(method="lm") +
  labs(x="Predicted 16S copy number", y="ln Change relational abundance") +
  theme_test() +
  theme(axis.text = element_text(size = 10),
        axis.title = element_text(size = 12))
```

Statistics:

Linear mixed effects

```{r}
n16S_lmer <- lmer(log(n16S) ~ group + (1 + Inoculant | Inoculant), growth_grp)
hist(resid(n16S_lmer))
plot(predict(n16S_lmer), resid(n16S_lmer))
anova(n16S_lmer)
```

Correlations

```{r}
cor.test(growth_grp$n16S, log(growth_grp$change_abund_corr), method="pearson")
cor.test(growth_grp$n16S, growth_grp$k, method="pearson")
```

# Figures

Total normalized abundance:

```{r}
plot1 <- norm_growth_total %>% 
  add_row(norm_growth_avg) %>% 
  mutate(fade = if_else(Inoculant!="avg", "avg", "inoc")) %>% 
  ggplot(aes(x=Day, y=log(total), group=Inoculant, alpha=fade)) +
  geom_point() +
  geom_line() + 
  geom_vline(xintercept=9, linetype=2) +
  coord_cartesian(xlim = c(0, 30)) +
  theme_test() +
  theme(axis.text = element_text(size=10),
        axis.title = element_blank())
plot1
```

Examples

```{r}
plot2 <- norm_grps_ex %>% 
  ggplot(aes(x=Day, y=log(norm_abund_avg))) +
  geom_point(aes(shape=group), size=2) +
  geom_line(aes(group=group)) +
  geom_vline(xintercept=9, linetype=2) +
  geom_smooth(method="lm", data=norm_grp1_ex[growth_grp1_ex$start_pt:growth_grp1_ex$end_pt,], linetype=2, color="#444444", alpha=0.3) +
  geom_smooth(method="lm", data=norm_grp2_ex[growth_grp2_ex$start_pt:growth_grp2_ex$end_pt,], linetype=2, color="#444444", alpha=0.3) +
  coord_cartesian(xlim = c(0, 30)) +
  theme_test() +
  theme(axis.text = element_text(size=10),
      axis.title = element_blank())
plot2
```

Combine:

```{r}
plot_comb12 <- plot_grid(plot1, plot2, nrow=2)
plot_comb12
```

```{r, eval=FALSE}
ggsave("../figures/fig_totalnorm_ex.svg", plot_comb12, height=180, width=180, units="mm", device="svg")
```

Groups growth and death traits:

```{r}
# growth k
plot3 <- growth_grp %>% 
  ggplot(aes(x=group, y=k)) +
  geom_boxplot() +
  geom_jitter(alpha=0.5) +
  #labs(title="plot3") +
  theme_test() +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=10),
        axis.title = element_blank())
plot3

# growth change in abundance
plot4 <- growth_grp %>% 
  ggplot(aes(x=group, y=log(change_abund_corr))) +
  geom_boxplot() +
  geom_jitter(alpha=0.5) +
  #labs(title="plot4") +
  theme_test() +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=10),
        axis.title = element_blank())
plot4

# death k
plot5 <- death_grp %>% 
  ggplot(aes(x=group, y=k)) +
  geom_boxplot() +
  geom_jitter(alpha=0.5) +
  #labs(title="plot5") +
  theme_test() +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=10),
        axis.title = element_blank())
plot5

# change in abundance
plot6 <- death_grp %>% 
  ggplot(aes(x=group, y=log(abs(change_abund_corr)))) +
  geom_boxplot() +
  geom_jitter(alpha=0.5) +
  #labs(title="plot6") +
  theme_test() +
  theme(axis.text = element_text(size = 10)) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=10),
        axis.title = element_blank())
plot6
```

Combine:

```{r}
plot_comb36 <- plot_grid(plot3, plot5, plot4, plot6, nrow=2)
plot_comb36
```

```{r, eval=FALSE}
ggsave("../figures/fig_growthdeathgroups.svg", plot_comb36, height=180, width=180, units="mm", device="svg")
```

Supplemental: Whole vs growth only total abundances

```{r}
# Comgroupe whole and growing only data averages
norm_whole_avg <- add_column(type="whole", norm_whole_avg)
norm_growth_avg <- add_column(type="growth", norm_growth_avg)

norm_avg <- groupd_rows(norm_whole_avg, norm_growth_avg)
```

```{r}
supp1 <- norm_avg %>% 
  mutate(type = as_factor(type),
         type = fct_relevel(type, c("whole", "growth"))) %>% 
  ggplot(aes(x=Day, y=log(total), shape=type)) +
  geom_point(size=3) +
  geom_line(aes(group=type, linetype=type)) +
  labs(y="Total relational abundnace (ln avg)") +
  theme_test()
supp1
```

```{r, eval=FALSE}
ggsave("../figures/supp_wholegrtotal.svg", supp1, height=180, width=180, units="mm", device="svg")
```