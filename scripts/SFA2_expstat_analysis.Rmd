---
title: "Growth and death dynamics during exponential and stationary phases"
author: "Cassandra Wattenburger"
date: "4/13/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

```{r}
# Clear working directory, load in packages, generate package info
rm(list=ls())

library("phyloseq")
library("vegan")
library("tidyverse")
library("lmerTest")
library("cowplot")

sessionInfo()

# I can't type "head" apparently so I'm going to make an alias
h <- function(x) {head(x)}
```

# Notes

* Copy of SFA2_expstatphases_growthdeath
* Plan to clean up

# Import data

* metadata
* growth estimates
* normalized abundances
* rarefied phyloseq

```{r}
# Metadata
meta <- readRDS("../data_intermediate/SFA2_metadata.rds")

# Growth estimates
growth <- readRDS("../data_intermediate/SFA2_growth_estimates_pap2.rds")

# Death estimates
death <- readRDS("../data_intermediate/SFA2_death_estimates_pap2.rds")

# All paprica estimates
pap_all <- readRDS("../data_intermediate/SFA2_paprica_all.rds")

# Normalized abundance data
norm <- readRDS("../data_intermediate/SFA2_normalized.rds")

# Rarefied phyloseq
physeq <- readRDS("../data_intermediate/SFA2_physeq_rare.rds")
```

# Total abundance

Defining as when the total normalized abundance of each inoculant evens out, indicating balanced growth and death.

## All taxa

```{r}
# Add metadata and reformat
meta <- meta %>%
  select(SampleID, Sample, Inoculant, Day, Replicate)

norm_meta <- norm %>%
  full_join(meta)

pap_slim <- pap_all %>% 
  select(ASV, n16S)

# Calculate total normalized abundance through time
norm_whole_total <- norm_meta %>% 
  inner_join(pap_slim) %>% # add 16S copy predictions
  mutate(norm_abund_corr = norm_abund / n16S) %>% # correct normalized abundance by 16S copies
  group_by(Inoculant, Day, ASV) %>% # average across replicates
  summarize(norm_abund_corr = mean(norm_abund_corr, na.rm=TRUE)) %>% 
  ungroup() %>%
  group_by(Inoculant, Day) %>%  # sum across ASVs
  summarize(total = sum(norm_abund_corr, na.rm=TRUE)) %>%
  ungroup() %>%
  filter(Inoculant %in% c(10, 12,19, 2, 41, 47)) %>% # remove controls
  select(Inoculant, Day, total) # tidy

# Calculate overall avg
norm_whole_avg <- norm_whole_total %>% 
  group_by(Day) %>% 
  summarize(total = mean(total)) %>% 
  ungroup() %>% 
  add_column(Inoculant="avg") %>% 
  select(Inoculant, Day, total)
```

Visualize:

```{r}
plot_whole_total <- norm_whole_total %>% 
  add_row(norm_whole_avg) %>% 
  mutate(fade = if_else(Inoculant!="avg", "avg", "inoc")) %>% 
  ggplot(aes(x=Day, y=log(total), group=Inoculant, alpha=fade)) +
  geom_point() +
  geom_line() + 
  geom_vline(xintercept=9, linetype=2) +
  labs(title="Summed normalized abundance of all taxa", y="ln summed normalized abundance") +
  theme_test() +
  theme(legend.position = "none")
plot_whole_total
```

## Growing taxa

```{r}
# Add metadata and reformat
meta <- meta %>%
  select(SampleID, Sample, Inoculant, Day, Replicate)

norm_meta <- norm %>%
  full_join(meta)

# Make a label for growing ASVs
growth_labels <- growth %>% 
  mutate(label = paste0(Inoculant, ASV)) %>%
  select(label, n16S)

# Calculate total normalized abundance through time
norm_growth_total <- norm_meta %>% 
  mutate(label = paste0(Inoculant, ASV)) %>% 
  inner_join(growth_labels) %>% # isolate growing taxa only
  mutate(norm_abund_corr = norm_abund / n16S) %>% # correct normalized abundance by 16S copies
  group_by(Inoculant, Day, ASV) %>% # average across replicates
  summarize(norm_abund_corr = mean(norm_abund_corr, na.rm=TRUE)) %>% 
  ungroup() %>%
  group_by(Inoculant, Day) %>% 
  summarize(total = sum(norm_abund_corr)) %>% # total normalized abundances
  ungroup() %>%
  filter(Inoculant %in% c(10, 12,19, 2, 41,47)) %>% # remove controls
  select(Inoculant, Day, total)

# Calculate overall avg
norm_growth_avg <- norm_growth_total %>% 
  group_by(Day) %>% 
  summarize(total = mean(total)) %>% 
  ungroup() %>% 
  add_column(Inoculant="avg") %>% 
  select(Inoculant, Day, total)
```

Visualize:

```{r}
plot_grow_total<- norm_growth_total %>% 
  add_row(norm_growth_avg) %>% 
  mutate(fade = if_else(Inoculant!="avg", "avg", "inoc")) %>% 
  ggplot(aes(x=Day, y=log(total), group=Inoculant, alpha=fade)) +
  geom_point() +
  geom_line() + 
  geom_vline(xintercept=9, linetype=2) +
  labs(title="Summed normalized abundance of growing taxa", y="ln summed normalized abundance") +
  coord_cartesian(xlim = c(0, 30)) +
  theme_test() +
  theme(legend.position = "none")
plot_grow_total 
```

# Group ASVs

Group 1: start_day end_day <= 9 (grew during exponential phase only)
group 2: end_day  > 9 (grew during exponential and/or stationary phases)

```{r}
# Growth
growth_grp <- growth %>% 
  mutate(group = if_else(end_day <= 9, "grp1", "grp2"),
         group = as.factor(group))

# Death
death_grp <- death %>% 
  mutate(group = if_else(end_day <= 9, "grp1", "grp2"),
         group = as.factor(group))
```

Summary of number ASVs per group:

```{r}
growth_grp %>% 
  group_by(Inoculant, group) %>% 
  summarize(total = n()) %>% 
  ungroup() %>% 
  group_by(group) %>% 
  summarize(total_mean = mean(total), total_sd = sd(total)) %>% 
  ungroup()

death_grp %>% 
  group_by(Inoculant, group) %>% 
  summarize(total = n()) %>% 
  ungroup() %>% 
  group_by(group) %>% 
  summarize(total_mean = mean(total), total_sd = sd(total)) %>% 
  ungroup()
```

Summary of phylogenetic placements in groups:

* Phylum level

```{r}
growth_grp %>% 
  group_by(Inoculant, group, Phylum) %>% 
  summarize(total = n()) %>% 
  ungroup() %>% 
  group_by(group, Phylum) %>% 
  summarize(total_mean = mean(total, na.rm=TRUE), total_sd = sd(total, na.rm=TRUE)) %>% 
  ungroup() %>% 
  arrange(group, desc(total_mean))
```

```{r}
death_grp %>% 
  group_by(Inoculant, group, Phylum) %>% 
  summarize(total = n()) %>% 
  ungroup() %>% 
  group_by(group, Phylum) %>% 
  summarize(total_mean = mean(total, na.rm=TRUE), total_sd = sd(total, na.rm=TRUE)) %>% 
  ungroup() %>% 
  arrange(group, desc(total_mean))
```

Summary of k, lag, change abund for each group:

```{r}
growth_grp %>% 
  mutate(g = log(2)/abs(k)) %>% # calculate generation time
  group_by(group) %>% 
  summarize(g_mean = mean(g, na.rm=TRUE),
            g_df = sd(g, na.rm=TRUE),
            lag_mean = mean(start_day, na.rm=TRUE),
            lag_sd = sd(start_day, na.rm=TRUE),
            chgabund_mean = mean(change_abund_corr, na.rm=TRUE),
            chgabund_sd = sd(change_abund_corr, na.rm=TRUE)) %>% 
  ungroup()
```

```{r}
death_grp %>% 
  mutate(h = log(2)/abs(k)) %>% # calculate halving time
  group_by(group) %>% 
  summarize(h_mean = mean(h, na.rm=TRUE),
            h_df = sd(h, na.rm=TRUE),
            lag_mean = mean(start_day, na.rm=TRUE),
            lag_sd = sd(start_day, na.rm=TRUE),
            chgabund_mean = mean(change_abund_corr, na.rm=TRUE),
            chgabund_sd = sd(change_abund_corr, na.rm=TRUE)) %>% 
  ungroup()
```


## Growth group examples

```{r}
# 157, 129
# group 1
growth_grp1_ex <- growth_grp %>% 
  filter(ASV==growth[157,]$ASV & Inoculant==growth[157,]$Inoculant) # see growth estimation plots from script 03

# Prepare abudance table
norm_grp1_ex <- norm_meta %>%
  filter(ASV==growth[157,]$ASV & Inoculant==growth[157,]$Inoculant) %>% 
  group_by(Inoculant, Day) %>% 
  summarize(norm_abund_avg = mean(norm_abund, na.rm=TRUE)) %>% # average across technical replicates
  ungroup() %>% 
  arrange(Day) %>% 
  filter(norm_abund_avg > 0) # filter missing values
              
# Visualize
plot_grp1_ex <- norm_grp1_ex %>% 
  ggplot(aes(x=Day, y=log(norm_abund_avg))) +
  geom_point(shape=1, size=3, color="#6F7378") +
  geom_line(color="#6F7378") +
  geom_vline(xintercept=9, linetype=2) +
  geom_smooth(method="lm", data=norm_grp1_ex[growth_grp1_ex$start_pt:growth_grp1_ex$end_pt,], linetype=2, color="black") +
  labs(title=paste0("group 1 example - ", growth_grp1_ex$Phylum, ", ", growth_grp1_ex$Genus), x="Day", y="ln normalized abundance") +
  coord_cartesian(xlim = c(0, 30)) +
  theme_test()
plot_grp1_ex
```

```{r}
# group 2
growth_grp2_ex <- growth_grp %>% 
  filter(ASV==growth[79,]$ASV & Inoculant==growth[79,]$Inoculant) # see growth estimation plots from script 03

# Prepare abudnance table
norm_grp2_ex <- norm_meta %>%
  filter(ASV==growth[79,]$ASV & Inoculant==growth[79,]$Inoculant) %>% 
  group_by(Inoculant, Day) %>% 
  summarize(norm_abund_avg = mean(norm_abund, na.rm=TRUE)) %>% # average across technical replicates
  ungroup() %>% 
  arrange(Day) %>% 
  filter(norm_abund_avg > 0) # filter missing values
              
# Visualize
plot_grp2_ex <- norm_grp2_ex %>% 
  ggplot(aes(x=Day, y=log(norm_abund_avg))) +
  geom_point(shape=1, size=3, color="#6F7378") +
  geom_line(color="#6F7378") +
  geom_vline(xintercept=9, linetype=2) +
  geom_smooth(method="lm", data=norm_grp2_ex[growth_grp2_ex$start_pt:growth_grp2_ex$end_pt,], linetype=2, color="black") +
  labs(title=paste0("group 2 example - ", growth_grp2_ex$Phylum, ", ", growth_grp2_ex$Genus), x="Day", y="ln normalized abundance") +
  coord_cartesian(xlim = c(0, 30)) +
  theme_test()
plot_grp2_ex
```

All together:

```{r}
# Comgroupe examples into one df
norm_grp1_ex <- add_column(norm_grp1_ex, group="grp1")
norm_grp2_ex <- add_column(norm_grp2_ex, group="grp2")
norm_grps_ex <- bind_rows(norm_grp1_ex, norm_grp2_ex)

# Visualize
norm_grps_ex %>% 
  ggplot(aes(x=Day, y=log(norm_abund_avg))) +
  geom_point(size=3, aes(shape=group)) +
  geom_line(aes(group=group)) +
  geom_vline(xintercept=9, linetype=2) +
  # Growth estimates
  geom_smooth(method="lm", data=norm_grp1_ex[growth_grp1_ex$start_pt:growth_grp1_ex$end_pt,], linetype=2, alpha=0.2) +
  geom_smooth(method="lm", data=norm_grp2_ex[growth_grp2_ex$start_pt:growth_grp2_ex$end_pt,], linetype=2, alpha=0.2) +
  #labs(title=paste0("group 3 example -", growth_grp3_ex$Phylum, ", ", growth_grp3_ex$Genus), x="Day", y="ln normalized abundance") +
  coord_cartesian(xlim = c(0, 30)) +
  theme_test()
```

## Summary

```{r}
growth_grp %>% 
  group_by(Inoculant, group) %>% 
  summarize(total=n()) %>% 
  ungroup() %>% 
  group_by(group) %>% 
  summarize(mean = mean(total),
            sd = sd(total))

death_grp %>% 
  group_by(Inoculant, group) %>% 
  summarize(total=n()) %>% 
  ungroup() %>% 
  group_by(group) %>% 
  summarize(mean = mean(total),
            sd = sd(total))
```

## Phylogenetic memberships

relative abundances down to order level for each inoculant

By number of estimates.

Growth:

```{r}
# Phylum-level makeup of ASV estimates
growth_phyla <- growth_grp %>% 
  group_by(Phylum, ASV) %>% 
  summarize(total=n())

# total number of growth estimates
growth_ests <- nrow(growth_grp)

# Calculate % estimates of each phylum
growth_phyla %>%
  group_by(Phylum) %>% 
  summarize(total=n()) %>% 
  arrange(desc(total)) %>% 
  add_column(all = growth_ests) %>% 
  mutate(perc = (total/all)*100)
```


```{r}
# Total ASVs estimated per inoculant/group
gr_inocgrp_totals <- growth_grp %>% 
  group_by(Inoculant, group) %>% 
  summarize(total = n()) %>% 
  ungroup()

# Order level
gr_ord_relabund <- growth_grp %>% 
  group_by(Inoculant, group, Phylum, Order) %>% 
  summarize(order_total = n()) %>% 
  ungroup() %>% 
  inner_join(gr_inocgrp_totals) %>% 
  mutate(relabund = order_total/total)
gr_ord_relabund
```

Death: 

```{r}
# Phylum-level makeup of ASV estimates
death_phyla <- death_grp %>% 
  group_by(Phylum, ASV) %>% 
  summarize(total=n())

# total number of death estimates
death_ests <- nrow(death_grp)

# Calculate % estimates of each phylum
death_phyla %>%
  group_by(Phylum) %>% 
  summarize(total=n()) %>% 
  arrange(desc(total)) %>% 
  add_column(all = death_ests) %>% 
  mutate(perc = (total/all)*100)
```

Visualize:

```{r}
gr_ord_relabund %>% 
  ggplot(aes(x=group, y=order_total, color=Phylum)) +
  geom_jitter() +
  geom_vline(xintercept=1.5) +
  facet_wrap(~Inoculant) +
  theme_test()

gr_ord_relabund %>% 
  mutate(border = if_else(Phylum=="Actinobacteriota", "yes", "no")) %>% 
  ggplot(aes(x=group, y=relabund, fill=Order, color=Phylum)) +
  geom_col() +
  facet_wrap(~Inoculant) +
  theme_test()
```

## Group 3

Started growth after day 9.

```{r}
# Growth estimates
growth_grp3 <- growth %>% 
  mutate(group = if_else(start_day > 9, "grp3", "not"),
         group = as.factor(group)) %>% 
  filter(group=="grp3")

# Death estimates
norm_grp3_prep <- growth_grp3 %>% 
  inner_join(norm) %>%
  select(label, Sample, Inoculant, Day, ASV, norm_abund) %>% 
  group_by(label, Inoculant, Day, ASV) %>% # average technical reps
  summarize(norm_abund = mean(norm_abund)) %>% 
  ungroup() %>% 
  arrange(Inoculant, Day) %>% 
  filter(norm_abund > 0) %>% # remove drop outs
  mutate(norm_abund_ln = log(norm_abund))

# Taxonomy
tax_grp3 <- growth_grp3 %>% 
  inner_join(norm) %>%
  select(ASV, Phylum:Genus) %>% 
  unique()
```

Visualize:

```{r}
count <-  0
for (l in as.character(growth_grp3$label)) {
  # Subset time series
  count <- count+1
  growth_label <- filter(growth_grp3, label==l)
  norm_label <- filter(norm_grp3_prep, label==l) %>% 
    arrange(Day)
  # Title information
  asv <- growth_label$ASV
  tax_info <- filter(tax_grp3, ASV == asv)
  title <- paste0(tax_info$Phylum, ", ", tax_info$Genus)
  # Graph with estimate
  graph <- ggplot(norm_label, aes(x=Day, y=norm_abund_ln)) +
    geom_point(shape=1, size=3, color="#6F7378") +
    geom_line(color="#6F7378") +
    geom_smooth(method="lm", data=norm_label[growth_label$start_pt:growth_label$end_pt,], linetype=2, color="black") +
    labs(title=paste0(title), x="Day", y="ln Relational abundance") +
    theme_test() +
    theme(axis.title = element_blank(),
        axis.text = element_text(size=10))
  print(graph)
  assign(paste0("plot", count, "_grp3"), graph)
}
```

# Growth traits

* growth rates
* change in abundance
* n16S

Visualize:

```{r}
# k
growth_grp %>% 
  ggplot(aes(x=group, y=k)) +
  geom_boxplot() +
  geom_jitter(size=2, alpha=0.5) +
  theme_test() +
  labs(y="Growth rate (day-1)", x="") +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 15))

# change in abundance
growth_grp %>% 
  ggplot(aes(x=group, y=log(change_abund_corr))) +
  geom_boxplot() +
  geom_jitter(size=2, alpha=0.5) +
  theme_test() +
  labs(y="Normalized abundance change (ln)", x="") +
  theme(axis.text = element_text(size = 10),
        axis.title = element_text(size = 12))

# n16S
growth_grp %>% 
  ggplot(aes(x=group, y=log(n16S))) +
  geom_boxplot() +
  geom_jitter(size=2, alpha=0.5) +
  theme_test() +
  labs(y="16S copy number (ln)", x="") +
  theme(axis.text = element_text(size = 10),
        axis.title = element_text(size = 12))

# Lag 
growth_grp %>% 
  filter(start_day <= 6) %>% # for group 2 taxa that started same time as group 1
  ggplot(aes(x=group, y=start_day)) +
  geom_boxplot() +
  geom_jitter(size=2, alpha=0.5) +
  theme_test() +
  labs(y="lag", x="") +
  theme(axis.text = element_text(size = 10),
        axis.title = element_text(size = 12))
```

## Statistics

Linear mixed effects models with random slopes and intercepts for inoculant

```{r}
# k
k_lmer <- lmer(k ~ group + (1 + Inoculant | Inoculant), growth_grp)
hist(resid(k_lmer))
plot(predict(k_lmer), resid(k_lmer))
anova(k_lmer)

# change abund
chg_lmer <- lmer(log(change_abund_corr) ~ group + (1 + Inoculant | Inoculant), growth_grp)
hist(resid(chg_lmer))
plot(predict(chg_lmer), resid(chg_lmer))
anova(chg_lmer)

# 16S
n16s_lmer <- lmer(log(n16S) ~ group + (1 + Inoculant | Inoculant), growth_grp)
hist(resid(n16s_lmer))
plot(predict(n16s_lmer), resid(n16s_lmer)) # heteroskedastic
# Welch t-test
t.test(log(n16S) ~ group, data=growth_grp) 

# lag
lag_lmer <- lmer(start_day ~ group + (1 + Inoculant | Inoculant), filter(growth_grp, start_day <= 6))
hist(resid(lag_lmer)) # non-normal
plot(predict(lag_lmer), resid(lag_lmer))
# Welch t-test
t.test(start_day ~ group, filter(growth_grp, start_day <= 6))
```

# Death Traits

Visualize:

```{r}
# k
death_grp %>% 
  ggplot(aes(x=group, y=k)) +
  geom_boxplot() +
  geom_jitter(size=2, alpha=0.5) +
  theme_test() +
  labs(y="Death rate (day-1)", x="") +
  theme(axis.text = element_text(size = 10),
        axis.title = element_text(size = 12))

# change in abundance
death_grp %>% 
  ggplot(aes(x=group, y=log(abs(change_abund_corr)))) +
  geom_boxplot() +
  geom_jitter(size=2, alpha=0.5) +
  theme_test() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 15)) +
  labs(y="Normalized abundance change (ln abs. value)", x="")

# n16S
death_grp %>% 
  ggplot(aes(x=group, y=n16S)) +
  geom_boxplot() +
  geom_jitter(size=2, alpha=0.5) +
  theme_test() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 15)) +
  labs(y="16S copy numbers", x="")
```

### Statistics 

Linear mixed effects models with random slopes and intercepts for inoculant

```{r}
# k
kdeath_lmer <- lmer(log(abs(k)) ~ group + (1 + Inoculant | Inoculant), death_grp)
hist(resid(kdeath_lmer))
plot(predict(kdeath_lmer), resid(kdeath_lmer))
anova(kdeath_lmer)

# change abund
chgdeath_lmer <- lmer(log(abs(change_abund_corr)) ~ group + (1 + Inoculant | Inoculant), death_grp)
hist(resid(chgdeath_lmer))
plot(predict(chgdeath_lmer), resid(chgdeath_lmer))
anova(chgdeath_lmer)

# n16S
n16S_lmer <- lmer(n16S ~ group + (1 + Inoculant | Inoculant), death_grp)
hist(resid(chgdeath_lmer))
plot(predict(chgdeath_lmer), resid(chgdeath_lmer))
anova(chgdeath_lmer)
```

# Abundance gains during exp and stat

N0 = normalized abundance of taxon at start of time interval (not log transformed)
g = generation time of taxon (days)
t = days in time frame
n = t/g, number of generations
Nt = N0*2^n, biomass at end of time frame
deltaN = Nt - N0, change in biomass

Full equation:
deltaN = N0*2^((end-start)/g) - N0

## Growth TROUBLESHOOT

Why is exponential gain so low? it makes no sense, missing data somehow?

```{r}
# Prepare data
growth_slim <- growth %>% 
  select(Inoculant, ASV, slope, yint, k, start_day, end_day, n16S)

growth_norm <- norm %>% 
  filter(Type=="Growth") %>% 
  select(Inoculant, Day, ASV, norm_abund) %>% 
  inner_join(growth_slim) %>%
  mutate(norm_abund_corr = norm_abund/n16S, # normalized abundance corrected
         g = log(2)/k) %>%  # generation time
  select(Inoculant, Day, ASV, start_day, end_day, slope, yint, g, norm_abund_corr, n16S) %>% 
  group_by(Inoculant, ASV, Day, slope, yint, g, start_day, end_day, n16S) %>% 
  summarize(norm_abund_corr = mean(norm_abund_corr)) %>% # average replicate values
  ungroup() %>% 
  mutate(group = if_else(start_day <= 9 & end_day <= 9, "group 1", "group 2"))
```

### Impute 0s

Identify problem 0s:

```{r}
# Check for problematic 0s for taxa on start of growth
impute_start <- growth_norm %>% 
  mutate(label = paste0(Inoculant, "_", ASV),
         impute = if_else(Day==start_day & norm_abund_corr==0, "impute", # mark for imputation if 0 at start
                                   if_else(Day!=start_day, "NA", "no impute"))) %>% 
  filter(impute=="impute")
impute_start
# none

# Check for 0s on day 9 (shift between exp and stationary)
impute_day9 <- growth_norm %>%
  mutate(label = paste0(Inoculant, "_", ASV),
         impute = if_else(Day==9 & norm_abund_corr==0, "impute", # mark for imputation if 0 at start
                                   if_else(Day!=start_day, "NA", "no impute"))) %>%
  filter(impute=="impute" & group=="group 2")
impute_day9
# Seems like a lot 79/131 (where day 9 = 0 abund), I'll impute all using the slope of the original linear model
# TROUBLESHOOT this seems high?
```

Impute day 9 for group 2:

Using slope of linear model to solve y (ln abundance) at x=9 (day)

Group 2 only.

```{r}
growth_impute <- growth_norm %>% 
  filter(group == "group 2" & Day==9) %>%
  mutate(impute_lnabund = slope*9 + yint,
         impute_abund = exp(impute_lnabund),
         impute_abund_corr = impute_abund/n16S) %>% 
  full_join(growth_norm) %>% 
  mutate(norm_abund_corr = if_else(Day==9 & norm_abund_corr==0, impute_abund_corr, norm_abund_corr)) %>% # impute
  select(Inoculant, ASV, Day, start_day, end_day, g, norm_abund_corr)
```

### Calc. deltaNg per phase

```{r}
# Exponential phase

# Group 1
exp_gain1 <- filter(growth_norm, end_day <= 9) %>% # grew only during exponential
  filter(start_day==Day) %>% # use abundance at start of growth (N0)
  mutate(deltaN = norm_abund_corr*2^((end_day-start_day)/g) - norm_abund_corr) %>% # gained during growth
  group_by(Inoculant) %>% 
  summarize(deltaN = sum(deltaN)) %>% 
  ungroup()

# Group 2
exp_gain2 <- filter(growth_norm, end_day >= 9 & start_day < 9) %>% # grew after exponential too
  filter(start_day==Day) %>% # starting abundance at start day
  mutate(deltaN = norm_abund_corr*2^((9-start_day)/g) - norm_abund_corr) %>% # gained prior to day 9
  group_by(Inoculant) %>% 
  summarize(deltaN = sum(deltaN)) %>% 
  ungroup()

# Stationary phase

# Group 2
stat_gain1 <- filter(growth_impute, end_day >= 9 & start_day <= 9) %>% # started growing in exponential
  filter(Day==9) %>% # starting abundnace will be abundance on day 9
  mutate(deltaN = norm_abund_corr*2^((end_day-9)/g) - norm_abund_corr) %>% # gained after day 9
  group_by(Inoculant) %>% 
  summarize(deltaN = sum(deltaN)) %>% 
  ungroup()

# Group 3
stat_gain2 <- filter(growth_norm, end_day >= 9 & start_day >= 9) %>% # started growing in stationary
  filter(Day==start_day) %>% # abundance at start of growth
  mutate(deltaN = norm_abund_corr*2^((end_day-start_day)/g) - norm_abund_corr) %>%
  group_by(Inoculant) %>% 
  summarize(deltaN = sum(deltaN)) %>% 
  ungroup() %>% 
  add_row(Inoculant="41", deltaN=0) %>% # add missing incoulants (no observed estiamtes)
  add_row(Inoculant="19", deltaN=0)

# Combine
expstat_gain <- bind_cols(exp_gain1, exp_gain2) %>% 
  bind_cols(stat_gain1) %>%
  bind_cols(stat_gain2) %>% 
  select(Inoculant=`Inoculant...1`, deltaN_exp1=`deltaN...2`, deltaN_exp2=`deltaN...4`, deltaN_stat=`deltaN...6`) %>% 
  mutate(deltaN_exp = deltaN_exp1 + deltaN_exp2)

expstat_gain %>% 
  summarize(exp_mean = mean(deltaN_exp),
            exp_sd = sd(deltaN_exp),
            stat_mean = mean(deltaN_stat),
            stat_sd = sd(deltaN_stat))
```

## Death

```{r}
# Prepare data
death_slim <- death %>% 
  select(Inoculant, ASV, slope, yint, k, start_day, end_day, n16S)

death_norm <- norm %>% 
  filter(Type=="Growth") %>% 
  select(Inoculant, Day, ASV, norm_abund) %>% 
  inner_join(death_slim) %>%
  mutate(norm_abund_corr = norm_abund/n16S, # normalized abundance corrected
         h = log(2)/k) %>%  # generation time
  select(Inoculant, Day, ASV, start_day, end_day, slope, yint, h, norm_abund_corr, n16S) %>% 
  group_by(Inoculant, ASV, Day, slope, yint, h, start_day, end_day, n16S) %>% 
  summarize(norm_abund_corr = mean(norm_abund_corr)) %>% # average replicate values
  ungroup() %>% 
  mutate(group = if_else(start_day <= 9 & end_day <= 9, "group 1", "group 2"))
```

### Impute 0s

Identify problem 0s:

```{r}
# Check for problematic 0s for taxa on start of death
impute_start <- death_norm %>% 
  mutate(label = paste0(Inoculant, "_", ASV),
         impute = if_else(Day==start_day & norm_abund_corr==0, "impute", # mark for imputation if 0 at start
                                   if_else(Day!=start_day, "NA", "no impute"))) %>% 
  filter(impute=="impute")
impute_start
# none

# Check for 0s on day 9 (shift between exp and stationary)
impute_day9 <- death_norm %>%
  mutate(label = paste0(Inoculant, "_", ASV),
         impute = if_else(Day==9 & norm_abund_corr==0, "impute", # mark for imputation if 0 at start
                                   if_else(Day!=start_day, "NA", "no impute"))) %>%
  filter(impute=="impute" & group=="group 2")
impute_day9
# Seems like a lot 79/131 (where day 9 = 0 abund), I'll impute all using the slope of the original linear model
# TROUBLESHOOT this seems high?
```

Impute day 9 for group 2:

Using slope of linear model to solve y (ln abundance) at x=9 (day)

Group 2 only.

```{r}
death_impute <- death_norm %>% 
  filter(group == "group 2" & Day==9) %>%
  mutate(impute_lnabund = slope*9 + yint,
         impute_abund = exp(impute_lnabund),
         impute_abund_corr = impute_abund/n16S) %>% 
  full_join(death_norm) %>% 
  mutate(norm_abund_corr = if_else(Day==9 & norm_abund_corr==0, impute_abund_corr, norm_abund_corr)) %>% # impute
  select(Inoculant, ASV, Day, start_day, end_day, h, norm_abund_corr)
```

### Calc. deltaNd per phase

```{r}
# Exponential phase

# Group 1
exp_loss1 <- filter(death_norm, end_day <= 9) %>% # grew only during exponential
  filter(start_day==Day) %>% # use abundance at start of death (N0)
  mutate(deltaN = norm_abund_corr*2^((end_day-start_day)/h) - norm_abund_corr) %>% # lossed during death
  group_by(Inoculant) %>% 
  summarize(deltaN = sum(deltaN)) %>% 
  ungroup()

# Group 2
exp_loss2 <- filter(death_norm, end_day >= 9 & start_day <= 9) %>% # grew after exponential too
  filter(start_day==Day) %>% # starting abundance at start day
  mutate(deltaN = norm_abund_corr*2^((9-start_day)/h) - norm_abund_corr) %>% # lossed prior to day 9 
  group_by(Inoculant) %>% 
  summarize(deltaN = sum(deltaN)) %>% 
  ungroup() %>% 
  add_row(Inoculant="41", deltaN=0) # inlcude inoculants with no estimates here

# Stationary phase

# Group 2
stat_loss1 <- filter(death_impute, end_day >= 9 & start_day <= 9) %>% # started growing in exponential
  filter(Day==9) %>% # starting abundnace will be abundance on day 9
  mutate(deltaN = norm_abund_corr*2^((end_day-9)/h) - norm_abund_corr) %>% # lossed after day 9
  group_by(Inoculant) %>% 
  summarize(deltaN = sum(deltaN)) %>% 
  ungroup() %>% 
  add_row(Inoculant="41", deltaN=0) # inlcude inoculants with no estimates here

# Group 3
stat_loss2 <- filter(death_norm, end_day >= 9 & start_day >= 9) %>% # started growing in stationary
  filter(Day==start_day) %>% # abundance at start of death
  mutate(deltaN = norm_abund_corr*2^((end_day-start_day)/h) - norm_abund_corr) %>%
  group_by(Inoculant) %>% 
  summarize(deltaN = sum(deltaN)) %>% 
  ungroup() %>% 
  add_row(Inoculant="41", deltaN=0) %>% # add missing incoulants (no observed estiamtes)
  add_row(Inoculant="19", deltaN=0)

# Combine
expstat_loss <- bind_cols(exp_loss1, exp_loss2) %>% 
  bind_cols(stat_loss1) %>%
  bind_cols(stat_loss2) %>% 
  select(Inoculant=`Inoculant...1`, deltaN_exp1=`deltaN...2`, deltaN_exp2=`deltaN...4`, deltaN_stat=`deltaN...6`) %>% 
  mutate(deltaN_exp = deltaN_exp1 + deltaN_exp2)

expstat_loss %>% 
  summarize(exp_mean = mean(deltaN_exp),
            exp_sd = sd(deltaN_exp),
            stat_mean = mean(deltaN_stat),
            stat_sd = sd(deltaN_stat))
```

Visualize:

```{r}
# Combine gains and losses
expstat_gain2 <- expstat_gain %>% 
  select(Inoculant, deltaN_exp, deltaN_stat) %>% 
  pivot_longer(cols=!Inoculant, names_to="phase", values_to="deltaN") %>% 
  mutate(phase = gsub("deltaN_", "", phase),
         type="growth")

expstat_loss2 <- expstat_loss %>% 
  select(Inoculant, deltaN_exp, deltaN_stat) %>% 
  pivot_longer(cols=!Inoculant, names_to="phase", values_to="deltaN") %>% 
  mutate(phase = gsub("deltaN_", "", phase),
         type="death")

expstat_gainloss <- bind_rows(expstat_gain2, expstat_loss2)

# Plot
expstat_gainloss %>% 
  ggplot(aes(x=phase, y=log(deltaN), color=type)) +
  geom_boxplot() +
  theme_test()
```

# Group 1 : Group 2

How does ratio of biomass in each group change with time?

# TROUBLESHOOT Inf values
## need to impute value in place of 0s in group 1 and 2

```{r}
death_grp_slim <- death_grp %>% 
  select(Inoculant, ASV, group)

norm_grp_ratio <- norm %>% 
  filter(Type=="Growth") %>% 
  select(Inoculant, Day, ASV, norm_abund) %>% 
  inner_join(pap_slim) %>% 
  inner_join(death_grp_slim) %>% 
  mutate(norm_abund_corr = norm_abund/n16S) %>%
  group_by(Inoculant, Day, group) %>% 
  summarize(total = sum(norm_abund_corr)) %>% 
  ungroup() %>%
  pivot_wider(names_from = group, values_from = total) %>% 
  mutate(ratio = grp1/grp2)
```

Visualize:

```{r}
norm_grp_ratio %>% 
  ggplot(aes(x=Day, y=ratio, color=Inoculant)) +
  geom_point() +
  geom_line(aes(group=Inoculant)) +
  geom_vline(xintercept = 9, linetype=2) +
  theme_test()
  
```

# MESS BELOW

# Correlations

Teasing apart relationship between category and growth traits, is it due to length of growth?

Growth rate vs change abundance:

```{r}
growth_grp %>% 
  mutate(length = end_day-start_day,
         change_abund_length = change_abund_corr/length) %>% 
  ggplot(aes(y=log(change_abund_corr), x=k, color=group)) + 
  geom_point(size=2) +
  geom_smooth(method="lm", linetype=2, alpha=0.1) +
  labs(x="Growth rate (day-1)", y="Relational abundance change (ln)") +
  theme_test() +  
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 15))
```

Length of growth vs growth rates:

```{r}
growth_grp <- growth_grp %>% 
  mutate(length=end_day-start_day) 

growth_grp %>% 
  ggplot(aes(x=length, y=k)) + 
  geom_point() +
  geom_smooth(method="lm", linetype=2) +
  theme_test()
```

Statistics:

* Pearson correlation

```{r}
cor.test(growth_grp$k, growth_grp$length, method="pearson")
```

Length of growth vs change in abundance:

```{r}
growth_grp %>% 
  ggplot(aes(x=length, y=log(change_abund_corr))) + 
  geom_point() +
  geom_smooth(method="lm", linetype=2) +
  theme_test()
```

Statistics:

* Pearson correlation

```{r}
cor.test(log(growth_grp$change_abund_corr), growth_grp$length, method="pearson")
```

Lag vs growth rate:

```{r}
growth_grp %>% 
  ggplot(aes(x=start_day, y=log(k))) + 
  geom_point() +
  geom_smooth(method="lm", linetype=2) +
  theme_test()
```

Lag vs change in abundance:

```{r}
growth_grp %>% 
  ggplot(aes(x=start_day, y=log(change_abund_corr))) + 
  geom_point() +
  geom_smooth(method="lm", linetype=2) +
  theme_test()
```

Statistics:

* Pearson correlation

```{r}
cor.test(log(growth_grp$change_abund_corr), growth_grp$start_day, method="spearm")
```

### Length of growth

```{r}
growth_grp %>% 
  ggplot(aes(x=group, y=log(length), color=group)) +
  geom_jitter() +
  theme_test()
```

Statistics: 

Linear mixed effects models with random slopes and intercepts for inoculant

```{r}
length_lmer <- lmer(log(length) ~ group + (1 + Inoculant | Inoculant), growth_grp)
hist(resid(length_lmer))
plot(predict(length_lmer), resid(length_lmer))
anova(length_lmer)
```

### 16S

```{r}
growth_grp %>% 
  ggplot(aes(x=group, y=log(n16S), color=group)) +
  geom_jitter() +
  labs(y="ln n16S", x="Period of growth")
  theme_test() +
  theme(axis.text = element_text(size = 10),
        axis.title = element_text(size = 12))
```

16S x growth rates

```{r}
growth_grp %>% 
  ggplot(aes(x=n16S, y=k)) +
  geom_point() +
  geom_smooth(method="lm") +
  labs(x="Predicted 16S copy number", y="Growth rate (day-1)") +
  theme_test() +
  theme(axis.text = element_text(size = 10),
        axis.title = element_text(size = 12))
```

16S x change abundance

```{r}
growth_grp %>% 
  ggplot(aes(x=n16S, y=log(change_abund_corr))) +
  geom_point() +
  geom_smooth(method="lm") +
  labs(x="Predicted 16S copy number", y="ln Change relational abundance") +
  theme_test() +
  theme(axis.text = element_text(size = 10),
        axis.title = element_text(size = 12))
```

Statistics:

Linear mixed effects

```{r}
n16S_lmer <- lmer(log(n16S) ~ group + (1 + Inoculant | Inoculant), growth_grp)
hist(resid(n16S_lmer))
plot(predict(n16S_lmer), resid(n16S_lmer))
anova(n16S_lmer)
```

Correlations

```{r}
cor.test(growth_grp$n16S, log(growth_grp$change_abund_corr), method="pearson")
cor.test(growth_grp$n16S, growth_grp$k, method="pearson")
```

# Figures

Total normalized abundance:

```{r}
plot1 <- norm_growth_total %>% 
  add_row(norm_growth_avg) %>% 
  mutate(fade = if_else(Inoculant!="avg", "avg", "inoc")) %>% 
  ggplot(aes(x=Day, y=log(total), group=Inoculant, alpha=fade)) +
  geom_point() +
  geom_line() + 
  geom_vline(xintercept=9, linetype=2) +
  coord_cartesian(xlim = c(0, 30)) +
  theme_test() +
  theme(axis.text = element_text(size=10),
        axis.title = element_blank())
plot1
```

Examples

```{r}
plot2 <- norm_grps_ex %>% 
  ggplot(aes(x=Day, y=log(norm_abund_avg))) +
  geom_point(aes(shape=group), size=2) +
  geom_line(aes(group=group)) +
  geom_vline(xintercept=9, linetype=2) +
  geom_smooth(method="lm", data=norm_grp1_ex[growth_grp1_ex$start_pt:growth_grp1_ex$end_pt,], linetype=2, color="#444444", alpha=0.3) +
  geom_smooth(method="lm", data=norm_grp2_ex[growth_grp2_ex$start_pt:growth_grp2_ex$end_pt,], linetype=2, color="#444444", alpha=0.3) +
  coord_cartesian(xlim = c(0, 30)) +
  theme_test() +
  theme(axis.text = element_text(size=10),
      axis.title = element_blank())
plot2
```

Combine:

```{r}
plot_comb12 <- plot_grid(plot1, plot2, nrow=2)
plot_comb12
```

```{r, eval=FALSE}
ggsave("../figures/fig_totalnorm_ex.svg", plot_comb12, height=180, width=180, units="mm", device="svg")
```

Groups growth and death traits:

```{r}
# growth k
plot3 <- growth_grp %>% 
  ggplot(aes(x=group, y=k)) +
  geom_boxplot() +
  geom_jitter(alpha=0.5) +
  #labs(title="plot3") +
  theme_test() +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=10),
        axis.title = element_blank())
plot3

# growth change in abundance
plot4 <- growth_grp %>% 
  ggplot(aes(x=group, y=log(change_abund_corr))) +
  geom_boxplot() +
  geom_jitter(alpha=0.5) +
  #labs(title="plot4") +
  theme_test() +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=10),
        axis.title = element_blank())
plot4

# death k
plot5 <- death_grp %>% 
  ggplot(aes(x=group, y=k)) +
  geom_boxplot() +
  geom_jitter(alpha=0.5) +
  #labs(title="plot5") +
  theme_test() +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=10),
        axis.title = element_blank())
plot5

# change in abundance
plot6 <- death_grp %>% 
  ggplot(aes(x=group, y=log(abs(change_abund_corr)))) +
  geom_boxplot() +
  geom_jitter(alpha=0.5) +
  #labs(title="plot6") +
  theme_test() +
  theme(axis.text = element_text(size = 10)) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=10),
        axis.title = element_blank())
plot6
```

Combine:

```{r}
plot_comb36 <- plot_grid(plot3, plot5, plot4, plot6, nrow=2)
plot_comb36
```

```{r, eval=FALSE}
ggsave("../figures/fig_growthdeathgroups.svg", plot_comb36, height=180, width=180, units="mm", device="svg")
```

Supplemental: Whole vs growth only total abundances

```{r}
# Comgroupe whole and growing only data averages
norm_whole_avg <- add_column(type="whole", norm_whole_avg)
norm_growth_avg <- add_column(type="growth", norm_growth_avg)

norm_avg <- bind_rows(norm_whole_avg, norm_growth_avg)
```

```{r}
# Total averaged abundances by phase, compraing whole to growing
norm_avg %>% 
  mutate(phase = if_else(Day <= 9, "exp", "stat")) %>% 
  group_by(phase, type) %>% 
  summarize(total = mean(total))
```


```{r}
supp1 <- norm_avg %>% 
  mutate(type = as_factor(type),
         type = fct_relevel(type, c("whole", "growth"))) %>% 
  ggplot(aes(x=Day, y=log(total), shape=type)) +
  geom_point(size=3) +
  geom_line(aes(group=type, linetype=type)) +
  labs(y="Total relational abundnace (ln avg)") +
  theme_test()
supp1
```

```{r, eval=FALSE}
ggsave("../figures/supp_wholegrtotal.svg", supp1, height=180, width=180, units="mm", device="svg")
```

Supplement group 3:

```{r}
count <-  0
for (l in as.character(growth_grp3$label)) {
  # Subset time series
  count <- count+1
  growth_label <- filter(growth_grp3, label==l)
  norm_label <- filter(norm_grp3_prep, label==l) %>% 
    arrange(Day)
  # Title information
  asv <- growth_label$ASV
  tax_info <- filter(tax_grp3, ASV == asv)
  title <- paste0(tax_info$Phylum, ", ", tax_info$Genus)
  # Graph with estimate
  graph <- ggplot(norm_label, aes(x=Day, y=norm_abund_ln)) +
    geom_point(shape=1, size=3, color="#6F7378") +
    geom_line(color="#6F7378") +
    geom_smooth(method="lm", data=norm_label[growth_label$start_pt:growth_label$end_pt,], linetype=2, color="black") +
    labs(title=paste0(title), x="Day", y="ln Relational abundance") +
    theme_test() +
    theme(title = element_text(size=12),
        axis.title = element_blank(),
          axis.text = element_text(size=10))
  print(graph)
  assign(paste0("plot", count, "_grp3"), graph)
}
```

Combine:

```{r}
supp_grp3 <- plot_grid(plot1_grp3, plot2_grp3, plot3_grp3, plot4_grp3, plot5_grp3, plot6_grp3, nrow=2)
supp_grp3
```

```{r, eval=FALSE}
ggsave("../figures/supp_grp3.svg", supp_grp3, height=120, width=210, units="mm", device="svg")
```

