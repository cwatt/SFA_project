---
title: "SFA2 betaNTI"
author: "Cassandra Wattenburger"
date: "3/23/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(results = "show")
knitr::opts_chunk$set(message = FALSE)
```

```{r}
# Clear working directory, load in packages, generate package info
rm(list=ls())

library("tidyverse")
library("ape")
library("phyloseq")
library("picante")

sessionInfo()
```

# Notes

# Import data

* Rarefied phyloseq object
* growth estimates

```{r}
# Phyloseq object with all growth samples
physeq <- readRDS("../data_intermediate/SFA2_physeq_rare.rds")

# Growth estimates
growth <- readRDS("../data_intermediate/SFA2_growth_estimates_pap.rds")
```

Extract from phyloseq:

```{r}
# Count table
count <- data.frame(otu_table(physeq))

# Tree
tree <- phy_tree(physeq)

# Metadata
meta <- data.frame(sample_data(physeq)) %>% 
  select(-SampleID) %>% 
  rownames_to_column(var="SampleID")
```

Prepare data:

```{r}
# Order names on phylogeny based on count table
matched <- match.phylo.data(tree, count)
```

# Whole community

### betaNTI

SLOW STEP

```{r, eval=FALSE}
# Calculate empirical betaMNTD
bMNTD <-  as.matrix(comdistnt(t(matched$data), cophenetic(matched$phy), abundance.weighted=T))
dim(bMNTD)

# Double check data compatibility, both should be TRUE
identical(colnames(matched$data), colnames(bMNTD))
identical(colnames(matched$data), rownames(bMNTD))

# Calculate randomized betaMNTD (999 randomizations)
reps <- 999

rand_bMNTD <- array(c(-999), dim=c(ncol(matched$data), ncol(matched$data), reps))
dim(rand_bMNTD)

for (rep in 1:reps) {
  rand_bMNTD[,,rep] = as.matrix(comdistnt(t(matched$data), taxaShuffle(cophenetic(matched$phy)), abundance.weighted=T, exclude.conspecifics=F))
  print(c(date(), rep))
}

# Calculate betaNTI
bNTI = matrix(c(NA), nrow=ncol(matched$data), ncol=ncol(matched$data)) # create empty matrix of same size
dim(bNTI)

for (column in 1:(ncol(matched$data) - 1)) {
  for (row in (column + 1):ncol(matched$data)) {
    rand_vals = rand_bMNTD[row, column,]
    bNTI[row, column] = (bMNTD[row, column] - mean(rand_vals)) / sd(rand_vals)
    #rm("rand_vals")
  }
}

rownames(bNTI) = colnames(matched$data);
colnames(bNTI) = colnames(matched$data);

# Visualize
hist(bNTI)

# Save output
saveRDS(bNTI, file="../data_intermediate/SFA2_bNTI_all.rds")
```

Evaluating each inoculant separately. Interested in stochasticity/determinism over time and between communities.

```{r}
# Load data
bNTI <- readRDS("../data_intermediate/SFA2_bNTI_all.rds") %>% 
  as.data.frame()

dim(bNTI)
```

Subset contrasts of interest:

```{r}
bNTI_contrasts <- data.frame()

bNTI_list <- list()
for (inoc in unique(meta$Inoculant)) {
  for (day in unique(meta$Day)) {
    meta_subset <- filter(meta, Day==day & Inoculant==inoc)
    samids <- meta_subset$SampleID
    bNTI_list <- bNTI[, (colnames(bNTI) %in% samids)] %>% # get columns with samples of interest
      rownames_to_column(var="SampleID") %>% 
      filter(SampleID %in% samids) %>% # get rows with samples of interest
      column_to_rownames(var="SampleID") %>% 
      as.matrix() %>% 
      as.list() %>% 
      unlist() %>% # flatten the dataframe into a list
      .[!is.na(.)] # remove NAs
    bNTI_mean <- mean(bNTI_list)
    this_row <- data.frame(Inoculant=inoc, Day=day, bNTI_mean)
    bNTI_contrasts <- bind_rows(bNTI_contrasts, this_row)
  }
}

bNTI_contrasts <- arrange(bNTI_contrasts, Day)
```

Visualize:

```{r}
bNTI_contrasts %>% 
  ggplot(aes(x=Day, y=bNTI_mean, color=Inoculant)) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = c(2, -2), linetype=2) +
  geom_hline(yintercept = 0) +
  theme_test()

bNTI_contrasts %>% 
  ggplot(aes(x=Day, y=bNTI_mean)) +
  geom_point() +
  geom_line() +
  facet_wrap(~ Inoculant) +
  geom_hline(yintercept = c(2, -2), linetype=2) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 10, linetype=3) +
  theme_test()
```

Between -2 and 2 is stochastic, below -2 is homogenizing selection, above 2 is variable selection.

Average across inoculants:

```{r}
bNTI_overall <- bNTI_contrasts %>% 
  group_by(Day) %>% 
  summarize(bNTI_mean = mean(bNTI_mean)) %>% 
  ungroup() %>% 
  mutate(Inoculant = "overall") %>% 
  select(Inoculant, Day, bNTI_mean) %>% 
  bind_rows(bNTI_contrasts)

bNTI_overall %>% 
  filter(Inoculant=="overall") %>% 
  ggplot(aes(x=Day, y=bNTI_mean)) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = c(-2), linetype=2) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 3.5, linetype=3) +
  geom_vline(xintercept = 9, linetype=3) +
  geom_vline(xintercept = 18, linetype=3) +
  geom_vline(xintercept = 24, linetype=3)

bNTI_overall%>% 
  mutate(fade = if_else(Inoculant=="overall", "yes", "no")) %>% 
  ggplot(aes(x=Day, y=bNTI_mean, alpha=fade, color=Inoculant)) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = c(-2), linetype=2) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 3.5, linetype=3) +
  geom_vline(xintercept = 9, linetype=3) +
  geom_vline(xintercept = 18, linetype=3) +
  geom_vline(xintercept = 24, linetype=3) +
  theme_test() +
  theme(legend.position = "none")
```

Turning points seem to be at ~ days 3.5, 9, and 24.

Q: I wonder if ~ day 3.5 the effects of the taxa that started growing on day 0 are being "seen" and having a randomzing effect ie luck of the draw for who wins? Day 3.5 is also when a lot of the death estimates that didn't begin on day 0 start showing up.

### Beta diversity

Weighted unifrac distances:

```{r}
# Calculate wunifrac distance
wuni_dist <- distance(physeq, method="wunifrac")

meta_sub <- select(meta, SampleID, Inoculant, Day)

# Reformat
wuni_df <- wuni_dist %>% 
  as.matrix() %>% 
  as.data.frame() %>%
  rownames_to_column(var="Sample1") %>% 
  pivot_longer(-Sample1, names_to = "Sample2", values_to = "wuni_dist")
wuni_df <- wuni_df[wuni_df$Sample1 != wuni_df$Sample2,] # remove self-comparisons
```

Remove duplicate pairwise comparisons:

* SLOW step, only run on purpose

```{r, eval=FALSE}
# Remove duplicates
# SLOW
# Sort sample1 and sample2 to create a unique label for duplicates regardless of order in columns
all_labels <- as.character()
for (i in 1:nrow(wuni_df)) {
  string <- wuni_df[i,] %>% 
    select(Sample1, Sample2) %>% 
    as.character() %>% 
    sort()
  label <- paste0(string[1], string[2])
  all_labels <- append(all_labels, label)
}

wuni_df2 <- bind_cols(wuni_df, all_labels) %>% 
  select(wuni_dist, label=`...4`) %>% 
  distinct() %>% # remove duplicate pairwise comparisons!
  mutate(Sample1 = gsub("(sa[0-9]+)(sa[0-9]+)", "\\1", label),
         Sample2 = gsub("(sa[0-9]+)(sa[0-9]+)", "\\2", label)) %>% 
  select(Sample1, Sample2, wuni_dist)

saveRDS(wuni_df2, "../data_intermediate/SFA2_wunidist_slim.rds")
```

```{r}
wuni_df <- readRDS("../data_intermediate/SFA2_wunidist_slim.rds")

# Comparisons of interest
wuni_within <- data.frame()
for (i in unique(meta$Inoculant)) {
  for (d in unique(meta[meta$Inoculant==i,]$Day)) {
    sams <- filter(meta, Inoculant==i & Day==d) 
    sams <- sams$SampleID
    wuni_sub <- filter(wuni_df, Sample1 %in% sams & Sample2 %in% sams) # isolate samples of interest
    wuni_avg <- mean(wuni_sub$wuni_dist) # average
    this_row <- bind_cols(Inoculant=i, Day=d, wuni_dist=wuni_avg)
    wuni_within <- bind_rows(wuni_within, this_row)
  }
}

# Visualize
wuni_within %>% 
  ggplot(aes(x=Day, y=wuni_dist)) +
  geom_boxplot(aes(group=Day)) +
  labs(y="Weighted unifrac distance (between replicates)") +
  theme_test()

wuni_within %>% 
  ggplot(aes(x=Day, y=wuni_dist, color=Inoculant)) +
  geom_point() +
  geom_line() +
  facet_wrap(~Inoculant) +
  labs(y="Weighted unifrac distance (between replicates)") +
  theme_test()
```

NMDS ordination:

```{r}
# Ordinate 
# Using pcoa because no convergence with nmds
ord_pcoa<- ordinate(physeq, method="PCoA", distance=wuni_dist)

# Visualize
plot_ordination(physeq, ord_pcoa, color="Inoculant") +
  stat_ellipse(type="t") +
  facet_wrap(~Day) +
  theme_test()

plot_ordination(physeq, ord_pcoa, color="Day", shape="Replicate") +
  #stat_ellipse(type="t") +
  facet_wrap(~Inoculant) +
  theme_test()
```

PermANOVA:

```{r}
# Overall 
adonis(wuni_dist~Inoculant*Day, data=meta, permutations=999)

# TP 0
meta_day0 <- meta %>% filter(Day==0)
physeq_day0 <- subset_samples(physeq, Day==0)
wuni_day0 <- distance(physeq_day0, method="wunifrac")
adonis(wuni_day0~Inoculant, data=meta_day0, permutations=999)

# TP 30
meta_day30 <- meta %>% filter(Day==30)
physeq_day30 <- subset_samples(physeq, Day==30)
wuni_day30 <- distance(physeq_day30, method="wunifrac")
adonis(wuni_day30~Inoculant, data=meta_day30, permutations=999)
```

Inoculants started with significantly different communities then became indistinguishable, but I wouldn't call it convergence. The variation increased between replicates. Indicates stochastic processes?

# Growth estimated only

### betaNTI

Isolate taxa that grew:

```{r}
# Isolate taxa that grew during any pt in incubation
growth_asvs <- growth$ASV
count_growth <- count %>% 
  rownames_to_column(var="ASV") %>% 
  filter(ASV %in% growth_asvs) %>% 
  column_to_rownames(var="ASV")
```

Prepare data:

```{r}
# Order names on phylogeny based on count table
matched_growth <- match.phylo.data(tree, count_growth)
```

Calculate betaNTI:

SLOW STEP

```{r, eval=FALSE}
# Calculate empirical betaMNTD
bMNTD_growth <-  as.matrix(comdistnt(t(matched_growth$data), cophenetic(matched_growth$phy), abundance.weighted=T))
dim(bMNTD_growth)

# Double check data compatibility, both should be TRUE
identical(colnames(matched_growth$data), colnames(bMNTD_growth))
identical(colnames(matched_growth$data), rownames(bMNTD_growth))

# Calculate randomized betaMNTD (999 randomizations)
reps <- 999

rand_bMNTD_growth <- array(c(-999), dim=c(ncol(matched_growth$data), ncol(matched_growth$data), reps))
dim(rand_bMNTD_growth)

for (rep in 1:reps) {
  rand_bMNTD_growth[,,rep] = as.matrix(comdistnt(t(matched_growth$data), taxaShuffle(cophenetic(matched_growth$phy)), abundance.weighted=T, exclude.conspecifics=F))
  print(c(date(), rep))
}

# Calculate betaNTI
bNTI_growth = matrix(c(NA), nrow=ncol(matched_growth$data), ncol=ncol(matched_growth$data)) # create empty matrix of same size
dim(bNTI_growth)

for (column in 1:(ncol(matched_growth$data) - 1)) {
  for (row in (column + 1):ncol(matched_growth$data)) {
    rand_vals = rand_bMNTD_growth[row, column,]
    bNTI_growth[row, column] = (bMNTD_growth[row, column] - mean(rand_vals)) / sd(rand_vals)
    rm("rand_vals")
  }
}

rownames(bNTI_growth) = colnames(matched_growth$data);
colnames(bNTI_growth) = colnames(matched_growth$data);

# Visualize
hist(bNTI_growth)

# Save output
saveRDS(bNTI_growth, file="../data_intermediate/SFA2_bNTI_growth.rds")
```

Subset contrasts of interest:

```{r}
bNTI_growth <- readRDS("../data_intermediate/SFA2_bNTI_growth.rds") %>% 
  as.data.frame()

bNTI_contrasts_growth <- data.frame()

bNTI_list_growth <- list()
for (inoc in unique(meta$Inoculant)) {
  for (day in unique(meta$Day)) {
    meta_subset <- filter(meta, Day==day & Inoculant==inoc)
    samids <- meta_subset$SampleID
    bNTI_list_growth <- bNTI_growth[, (colnames(bNTI_growth) %in% samids)] %>% # get columns with samples of interest
      rownames_to_column(var="SampleID") %>% 
      filter(SampleID %in% samids) %>% # get rows with samples of interest
      column_to_rownames(var="SampleID") %>% 
      as.matrix() %>% 
      as.list() %>% 
      unlist() %>% # flatten the dataframe into a list
      .[!is.na(.)] # remove NAs
    bNTI_mean <- mean(bNTI_list_growth)
    this_row <- data.frame(Inoculant=inoc, Day=day, bNTI_mean)
    bNTI_contrasts_growth <- bind_rows(bNTI_contrasts_growth, this_row)
  }
}

bNTI_contrasts_growth <- arrange(bNTI_contrasts_growth, Day)
```

Visualize:

```{r}
bNTI_contrasts_growth %>% 
  ggplot(aes(x=Day, y=bNTI_mean, color=Inoculant)) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = c(2, -2), linetype=2) +
  geom_hline(yintercept = 0) +
  theme_test()

bNTI_contrasts_growth %>% 
  ggplot(aes(x=Day, y=bNTI_mean)) +
  geom_point() +
  geom_line() +
  facet_wrap(~ Inoculant) +
  geom_hline(yintercept = c(2, -2), linetype=2) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 10, linetype=3) +
  theme_test()
```

Assembly of growth estimated taxa mainly stochastic.

### Beta diversity

Weighted unifrac distances:

```{r}
# Isolate taxa with growth estimates
physeq_growth <- subset_taxa(physeq, ASV %in% growth_asvs)

# Calculate wunifrac distance
wuni_dist_growth <- distance(physeq_growth, method="wunifrac")

# Reformat
wuni_df_growth <- wuni_dist_growth %>% 
  as.matrix() %>% 
  as.data.frame() %>%
  rownames_to_column(var="Sample1") %>% 
  pivot_longer(-Sample1, names_to = "Sample2", values_to = "wuni_dist")

wuni_df_growth <- wuni_df_growth[wuni_df_growth$Sample1 != wuni_df_growth$Sample2,] # remove self-comparisons
```

Remove duplicate pairwise comparisons:

* SLOW step, only run on purpose

```{r, eval=FALSE}
# Remove duplicates
# SLOW
# Sort sample1 and sample2 to create a unique label for duplicates regardless of order in columns
all_labels <- as.character()
for (i in 1:nrow(wuni_df_growth)) {
  string <- wuni_df_growth[i,] %>% 
    select(Sample1, Sample2) %>% 
    as.character() %>% 
    sort()
  label <- paste0(string[1], string[2])
  all_labels <- append(all_labels, label)
}

wuni_df2_growth <- bind_cols(wuni_df_growth, all_labels) %>% 
  select(wuni_dist, label=`...4`) %>% 
  distinct() %>% # remove duplicate pairwise comparisons!
  mutate(Sample1 = gsub("(sa[0-9]+)(sa[0-9]+)", "\\1", label),
         Sample2 = gsub("(sa[0-9]+)(sa[0-9]+)", "\\2", label)) %>% 
  select(Sample1, Sample2, wuni_dist)

saveRDS(wuni_df2_growth, "../data_intermediate/SFA2_wunidist_slim_growth.rds")
```

```{r}
wuni_df_growth <- readRDS("../data_intermediate/SFA2_wunidist_slim_growth.rds")

# Comparisons of interest
wuni_within_growth <- data.frame()
for (i in unique(meta$Inoculant)) {
  for (d in unique(meta[meta$Inoculant==i,]$Day)) {
    sams <- filter(meta, Inoculant==i & Day==d) 
    sams <- sams$SampleID
    wuni_sub <- filter(wuni_df_growth, Sample1 %in% sams & Sample2 %in% sams) # isolate samples of interest
    wuni_avg <- mean(wuni_sub$wuni_dist) # average
    this_row <- bind_cols(Inoculant=i, Day=d, wuni_dist=wuni_avg)
    wuni_within_growth <- bind_rows(wuni_within_growth, this_row)
  }
}

# Visualize
wuni_within_growth %>% 
  ggplot(aes(x=Day, y=wuni_dist)) +
  geom_boxplot(aes(group=Day)) +
  labs(y="Weighted unifrac distance, growing taxa (between replicates)") +
  theme_test()

wuni_within_growth %>% 
  ggplot(aes(x=Day, y=wuni_dist, color=Inoculant)) +
  geom_point() +
  geom_line() +
  facet_wrap(~Inoculant) +
  labs(y="Weighted unifrac distance, growing taxa (between replicates)") +
  theme_test()
```

Ordinate:

```{r}
# Ordinate 
# Using pcoa because no convergence with nmds
ord_pcoa_growth  <- ordinate(physeq_growth, method="PCoA", distance=wuni_dist_growth)

# Visualize
plot_ordination(physeq, ord_pcoa_growth, color="Inoculant") +
  stat_ellipse(type="t") +
  facet_wrap(~Day) +
  theme_test()
```

