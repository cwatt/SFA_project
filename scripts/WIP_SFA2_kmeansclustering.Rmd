---
title: "Untitled"
author: "Cassandra Wattenburger"
date: "2/22/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(results = "show")
knitr::opts_chunk$set(message = FALSE)
```

```{r}
# Clear working directory, load in packages, generate package info
rm(list=ls())

library("tidyverse")
library("ggfortify")
library("factoextra")
library("cluster")

sessionInfo()
```

# Resources used

https://www.kaggle.com/sabanasimbutt/clustering-visualization-of-clusters-using-pca/notebook

https://andrewmourcos.github.io/blog/2019/06/06/PCA.html

https://www.statology.org/k-means-clustering-in-r/

# Import data

```{r}
growth <- readRDS("../data_intermediate/SFA2_growth_estimates_pap.rds")

death <- readRDS("../data_intermediate/SFA2_death_estimates_pap.rds")
```

# Growth 

### Preparation

Check for correlations among growth parameters:

```{r}
# Growth parameters only
growth_prep <- growth %>% 
  column_to_rownames(var="label") %>% 
  mutate(start_abund = start_abund/n16S,
         end_abund = end_abund/n16S,
         change_abund =change_abund/n16S) %>%  # Correct for 16S copy number
  select(k, start_day, end_day, start_abund, end_abund, change_abund)
  

# Investigate correlations
growth_corr <- cor(growth_prep[,unlist(lapply(growth_prep, is.numeric))]) 
growth_corr
```

End abundance and change abundance are almost perfectly correlated (0.999), so I'll remove end_abund, since change in abundance is a particular parameter of interest.

```{r}
# Remove unneeded parameters, reformat
growth_prep <- growth_prep %>% 
  select(-end_abund)
```

Normalize:

Z-score standardization = (value - mean) / standard dev

```{r}
# Calculate mean and sd of each parameter
growth_summary <- growth_prep %>% 
  summarize(k_mean = mean(k), k_sd = sd(k),
            start_day_mean = mean(start_day), start_day_sd = sd(start_day),
            end_day_mean = mean(end_day), end_day_sd = sd(end_day),
            start_abund_mean = mean(start_abund), start_abund_sd = sd(start_abund),
            change_abund_mean = mean(change_abund), change_abund_sd = sd(change_abund))

# Normalize all values
growth_norm <- growth_prep %>% 
  mutate(k = (k - growth_summary$k_mean)/growth_summary$k_sd,
         start_day = (start_day - growth_summary$start_day_mean)/growth_summary$start_day_sd,
         end_day = (end_day - growth_summary$end_day_mean)/growth_summary$end_day_sd,
         start_abund = (start_abund - growth_summary$start_abund_mean)/growth_summary$start_abund_sd,
         change_abund = (change_abund - growth_summary$change_abund_mean)/growth_summary$change_abund_sd)
```

### Principle components analysis

I want to check visually for clusters.

```{r}
# Calculate principle components
growth_pca <- prcomp(growth_norm)
summary(growth_pca)

# Plot
autoplot(growth_pca, data=growth_norm)
```

Nothing is jumping out to me, but let's see what k-means clustering can do.

### K means clustering

Determine appropriate number of clusters:

```{r}
fviz_nbclust(growth_norm, kmeans, method="wss") # Using within cluster sum of squares
```

Not much of an elbow. I would say 4 is where the drop in WSS starts to slow down.

Cluster:

```{r}
set.seed(4)

growth_km <- kmeans(growth_norm, centers = 4, nstart = 25)
growth_km

# Plot
fviz_cluster(growth_km, data = growth_norm, labelsize=0)
```

Outlier forms it's own cluster and should probably be disregarded?

# Death

### Preparation

Check for correlations among death parameters:

```{r}
# Growth parameters only
death_prep <- death %>% 
  column_to_rownames(var="label") %>% 
  mutate(start_abund = start_abund/n16S,
         end_abund = end_abund/n16S,
         change_abund =change_abund/n16S) %>%  # Correct for 16S copy number
  select(k, start_day, end_day, start_abund, end_abund, change_abund)
  

# Investigate correlations
death_corr <- cor(death_prep[,unlist(lapply(death_prep, is.numeric))]) 
death_corr
```

Lots of highly correlated parameters. End day nad start day is 0.8, start abundance and change abundance is 0.99. I think I'll remove start day and start abundance.

```{r}
# Remove unneeded parameters, reformat
death_prep <- death_prep %>% 
  select(-c(start_day, start_abund))
```

Normalize:

Z-score standardization = (value - mean) / standard dev

```{r}
# Calculate mean and sd of each parameter
death_summary <- death_prep %>% 
  summarize(k_mean = mean(k), k_sd = sd(k),
            end_day_mean = mean(end_day), end_day_sd = sd(end_day),
            end_abund_mean = mean(end_abund), end_abund_sd = sd(end_abund),
            change_abund_mean = mean(change_abund), change_abund_sd = sd(change_abund))

# Normalize all values
death_norm <- death_prep %>% 
  mutate(k = (k - death_summary$k_mean)/death_summary$k_sd,
         end_day = (end_day - death_summary$end_day_mean)/death_summary$end_day_sd,
         end_abund = (end_abund - death_summary$end_abund_mean)/death_summary$end_abund_sd,
         change_abund = (change_abund - death_summary$change_abund_mean)/death_summary$change_abund_sd)

death_norm
```

### Principle components analysis

I want to check visually for clusters.

```{r}
# Calculate principle components
death_pca <- prcomp(death_norm)
summary(death_pca)

# Plot
autoplot(death_pca, data=death_norm)
```

That line is weird. Maybe autocorrelation is still a problem or something?

### K means clustering

Determine appropriate number of clusters:

```{r}
fviz_nbclust(death_norm, kmeans, method="wss") # Using within cluster sum of squares
```

Not much of an elbow. I would say 4 is where the drop in WSS starts to slow down.

Cluster:

```{r}
set.seed(4)

death_km <- kmeans(death_norm, centers = 4, nstart = 25)
death_km

# Plot
fviz_cluster(death_km, data = death_norm, labelsize=0)
```


