---
title: "SFA2 - DOC workup"
author: "Cassandra Wattenburger"
date: "1/22/2021"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(results = "show")
knitr::opts_knit$set(root.dir = '~/SFAgrowthrate/SFAphase1.5')
```

**Goal of script:** Work up DOC data from sand microcosms innoculated with "high" and "low" DOC phenotype communities.

Script based heavily on Taylor Cyle's script, shimadzu_workup_template.Rmd.

Meant to be run with samples analyzed using Shimadzu NPOC measurement only, 3/5 injections.

Notes: 

* These samples were run on the TOC analyzer by Rachelle LaCroix, because I can no longer access the TOC analyzer due to COVID precuations. Minor differences in run set up exist that required script tweaks because of this.
* Blank and internal standard Sample IDs were also changed to numbers for more explicit labelling.

Original data files:

* 20210121_toc_sampletable_cassi.txt
* 20210121_toc_results_cassi.txt

Used in analysis:
* toc_results_20210221.csv

Cleaned up version of 20210121_toc_sampletable_cassi.txt. Removed header and saved as csv. Fixed blank and internal standard sample names to reflect order ran.

### Script requirements
* Shimadzu exported data with header info and blank rows removed
* Sample metadata file with atleast an "ID"id column and "dilution" column (ie 8 if you diluted samples by hand 8-fold prior to measuring NOT the same as auto-dilute which the machine performs for you)

### Run specific info
* NPOC standard = 100 ppm KHP
* Ext check 1 = 1 mM glycine
* Ext check 2 = 1 mM alanine
* Ext check 3 = 1 mM glucose

## Step 0: Clear workspace, attach packages, set working directory
```{r}
rm(list=ls())

library(tidyverse)
require(broom)
```

```{r, results="show"}
sessionInfo()
```

```{r}
# Names of external/internal checks and samples as entered into Shimadzu software
stds.name <- "Std"
int1.name <- 'Internal'
sam1.name <- 'Sample'
blank.name <- 'Blank'
#expblank.name <- 'Sample blank'

# Internal check info
int.ppm <- 25 # expected concentration of internal checks in ppm

# Sample dilution info
dil <- 23 # hand-dilution of samples before running
```

## Step 1: Import data and subset standards, checks, samples

```{r}
# Import raw data with header notes removed manually in excel or text editor
# The data was export in two separate files, one for the standards and one for the samples
raw = read_csv("~/SFA/data_DOC/SFA2/toc_results_01212021.csv")

# Clean up
raw.clean = raw %>%
  filter(Excluded == 0) %>% # remove excluded injections
  select(1,3:4,9,12:14) %>% # remove junk columns
  rename(date_time = 'Date / Time', sample_type = 'Sample Name', analys_type = 'Analysis(Inj.)', sample_id = 'Sample ID') # rename columns 

# Subset standard data and remove unnecessary columns
stds = raw.clean[which(raw.clean$sample_type == stds.name),]

# Subset internal checks
ints = raw.clean[which(raw.clean$sample_type == int1.name),]

# Subset samples
samples = raw.clean[which(raw.clean$sample_type == sam1.name | raw.clean$sample_type == blank.name),]
```


## Step 2: Assess standard curve
```{r}
# NPOC
npoc.lm = lm(Area ~ Conc., data = stds)
plot(Area ~ Conc., data = stds, main = "Initial Cal Curve NPOC") +
  abline(npoc.lm)
summary(npoc.lm)
cal.NPOC <- as.data.frame(tidy(npoc.lm))
```

This looks good.

## Step 3: Assess external checks

Not necessary because did not measure TN.

## Step 4: Assess internal checks for drift over time

```{r}
# Convert date/time to POSIXct (format= specifies input format)
ints$date_time_new = as.POSIXct(ints$date_time, format="%m/%d/%Y %H:%M")
head(ints)
```

It appears that the first internal check is an outlier, and something may have gone wrong with setup. It looks like the blank was accidentally run instead based on area measurement. Excluding from drift analysis. I'll replace it with the 10 ppm check from the calibration curve as the next best proxy for drift. It also looks like the internal check was set to 10 ppm rather than 25 ppm based on areas. Will check with Rachael about this.

```{r}
# Remove internal check 1
ints.rm = filter(ints, !sample_id==1)

# Replace with std 10 ppm from calibration curve
stds.10ppm = filter(stds, Conc.==10) # isolate 10 ppm std

ints.rp = stds.10ppm %>%
  bind_rows(ints.rm) %>% # add to internal check data
  mutate(date_time_new = as.POSIXct(date_time, format="%m/%d/%Y %H:%M")) # fix date and time for replacement

# Time of first check
t1 = as.data.frame(ints.rp[1,8])

# Create time elapsed column
ints.rp = ints.rp %>%
  mutate(seconds = round(date_time_new - t1[1,1], 2)) # time elapsed since first internal check
  
# Summarize mean time since start of run for each internal check group
int.times = ints.rp %>% 
  group_by(sample_id) %>% 
  summarize(seconds_avg = mean(seconds)) # this is broken for some reason, it's taking the whole avg not by grp

# Calculate concentration in internal standards based on curve
# I've found that the concentrations that the machine comes up with have no relationship to the standard curve for some reason
ints.rp = ints.rp %>% 
  mutate(Corr.Conc.=(Area-cal.NPOC[1,2])/(cal.NPOC[2,2]))

int.conc = ints.rp %>% 
  group_by(analys_type, sample_id) %>% 
  summarize(mean.conc = mean(Corr.Conc.))

ints.summary = inner_join(int.times, int.conc, by='sample_id')

# Calculate concentration of NPOC in standards based on standard curve
NPOC.stds.summary = stds %>% 
  group_by(Conc.) %>% 
  summarize(mean.area = mean(Area))

NPOC.stds.summary = NPOC.stds.summary %>% 
  mutate(calc.conc = (mean.area-cal.NPOC[1,2])/cal.NPOC[2,2])

# Actual concentrations expected from internal checks based on standard curves
NPOC.std.10ppm = NPOC.stds.summary[NPOC.stds.summary$Conc.==10,]$calc.conc # changed from 25 to 10

# Calculate percent and proportion drift
ints.summary <- ints.summary %>% mutate(percent_drift = ((mean.conc-NPOC.std.10ppm)/NPOC.std.10ppm)*100)
ints.summary <- ints.summary %>% mutate(prop_drift = (mean.conc/NPOC.std.10ppm))

# Plot internal standards over time
ggplot(ints.summary, aes(seconds_avg, percent_drift, colour = analys_type, fill = analys_type)) + 
  geom_point() +
  labs(x = "Time (min)", y = "% Drift from Original Curve Value") +
  ggtitle("Check Standard Drift - Percentage Basis") + 
    theme_bw() + theme(panel.grid.major = element_blank(), 
                       panel.grid.minor = element_blank()) +
  geom_smooth(method='lm')

ggplot(ints.summary, aes(seconds_avg, prop_drift, colour = analys_type, fill = analys_type)) + 
  geom_point() +
  labs(x = "Time (min)", y = "Proportion of Original Value") +
  ggtitle("Check Standard Drift - Proportional Basis") + 
    theme_bw() + theme(panel.grid.major = element_blank(), 
                       panel.grid.minor = element_blank()) +
  geom_smooth(method='lm')
```


## Step 5: Correct drift and recalculate samples based on standard curve

```{r}
# NPOC drift regression
drift.fix = lm(prop_drift ~ seconds_avg, data=ints.summary)
drift.fix = tidy(drift.fix)
drift.fix = as.data.frame(drift.fix)

# Re-calculate sample concentrations based on std curve
samples <- samples %>% 
  mutate(Corr.Conc.=(Area-cal.NPOC[1,2])/(cal.NPOC[2,2])) 

# Convert date/time to POSIXct
samples$date_time_new = as.POSIXct(samples$date_time, format="%m/%d/%Y %H:%M")

# Create time elapsed since first internal check
samples = samples %>%
  mutate(time_elapsed = round(date_time_new - t1[1,1], 2)) %>% # time elapsed since first internal check
  mutate(time_elapsed = as.numeric(time_elapsed*3600)) # convert to seconds to match drift calibration

# NPOC drift correction
samples = mutate(samples, drift.Conc = Corr.Conc./(time_elapsed*drift.fix[2,2]+drift.fix[1,2]))

# Correct for hand-dilution (not dilutions done by Shimadzu, which are already accounted for)
samples.final <- samples %>% mutate(doc = drift.Conc*dil) 

# Remove blanks from data (no longer needed)
samples.final <- samples.final[!samples.final$sample_type=="Blank",]

# Average injections for same sample
samples.final.avg <- samples.final %>% 
  group_by(sample_id) %>% 
  summarize(mean = mean(doc))
```

Save results for analysis

```{r}
saveRDS(samples.final.avg, "../data_DOC/SFA2/SFA2_doc.rds")
```

