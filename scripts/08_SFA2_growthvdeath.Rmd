---
title: "WIP_SFA2_growthvdeath.Rmd"
author: "Cassandra Wattenburger"
date: "1/25/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

```{r}
# Clear working directory, load in packages, generate package info
rm(list=ls())

library("tidyverse")

sessionInfo()
```

# Import and reformat data

```{r}
# growth
growth <- readRDS("../data_intermediate/SFA2_growth_estimates_pap.rds")

# death
death <- readRDS("../data_intermediate/SFA2_death_estimates_pap.rds")

# Taxonomic information
tax <- readRDS("../data_intermediate/SFA2_taxonomy.rds")
```

# ASV-level

```{r}
growth_asv <- growth %>% 
  group_by(DOC, ASV) %>% 
  summarize(k_growth = mean(k),
            gr_start_day = mean(start_day),
            gr_end_day = mean(end_day),
            gr_length = mean(end_day - start_day),
            gr_start_abund = mean(start_abund/n16S), # adjust for copy number
            gr_end_abund = mean(end_abund/n16S), # adjust for copy number
            gr_change_abund = mean(change_abund/n16S)) %>% # adjust for copy number
  ungroup()

death_asv <- death %>% 
  group_by(DOC, ASV) %>% 
  summarize(k_death = mean(k),
            de_start_day = mean(start_day),
            de_end_day = mean(end_day),
            de_length = mean(end_day - start_day),
            de_start_abund = mean(start_abund/n16S), # adjust for copy number
            de_end_abund = mean(end_abund/n16S), # adjust for copy number
            de_change_abund = mean(change_abund/n16S),
            n16S = mean(n16S),
            genome_size = mean(genome_size)) %>% # adjust for copy number
  ungroup() %>% 
  inner_join(tax)
```

Combine growth and death estimates

```{r}
grde_asv <- inner_join(growth_asv, death_asv, by=c("DOC", "ASV"))
dim(grde_asv)
head(grde_asv)
```

### Plots

Growth rate vs death rate:

```{r}
grde_asv %>% 
  ggplot(aes(x=k_growth, y=k_death)) +
  geom_point() +
  geom_smooth(method="lm", linetype=2) +
  facet_wrap(~ DOC) +
  theme_test()
```

Change in abundance:

```{r}
grde_asv %>% 
  ggplot(aes(x=log(gr_change_abund), y=log(abs(de_change_abund)))) +
  geom_point() +
  geom_smooth(method="lm") +
  facet_wrap(~ DOC) +
  theme_test()
```

### Statistics

Change in abundance:

```{r}
# Overall
chgabund_lm <- lm(log(gr_change_abund) ~ log(abs(de_change_abund)), data=grde_asv)
hist(resid(chgabund_lm))
plot(predict(chgabund_lm), resid(chgabund_lm))
summary(chgabund_lm)

# High DOC
chgabund_hi_lm <- lm(log(gr_change_abund) ~ log(abs(de_change_abund)), data=grde_asv[grde_asv$DOC=="high",])
hist(resid(chgabund_hi_lm))
plot(predict(chgabund_hi_lm), resid(chgabund_hi_lm))
summary(chgabund_hi_lm)

# Low DOC
chgabund_lo_lm <- lm(log(gr_change_abund) ~ log(abs(de_change_abund)), data=grde_asv[grde_asv$DOC=="low",])
hist(resid(chgabund_lo_lm))
plot(predict(chgabund_lo_lm), resid(chgabund_lo_lm))
summary(chgabund_lo_lm)
```

# Sample-level

```{r}
growth_sample <- growth %>% 
  group_by(DOC, Inoculant) %>% 
  summarize(k = mean(k),
            start_day = mean(start_day),
            end_day = mean(end_day),
            length = mean(end_day - start_day),
            start_abund = mean(start_abund/n16S), # adjust by copy number
            end_abund = mean(end_abund/n16S), # adjust by copy number
            mean_change_abund = mean(change_abund/n16S), # adjust by copy number
            total_change_abund = sum(change_abund/n16S), # adjust by copy number
            n16S = mean(n16S),
            genome_size = mean(genome_size)) %>%  
  ungroup()

death_sample <- death %>% 
  group_by(DOC, Inoculant) %>% 
  summarize(k = mean(k),
            start_day = mean(start_day),
            end_day = mean(end_day),
            length = mean(end_day - start_day),
            start_abund = mean(start_abund/n16S), # adjust by copy number
            end_abund = mean(end_abund/n16S), # adjust by copy number
            mean_change_abund = mean(change_abund/n16S), # adjust by copy number
            total_change_abund = sum(change_abund/n16S), # adjust by copy number
            n16S = mean(n16S),
            genome_size = mean(genome_size)) %>%  
  ungroup()
```

Net biomass change:

* Growth-death change in abundance

```{r}
# Reformat
growth_sample_net <- growth_sample %>% select(DOC, Inoculant, mean_chabund_gr=mean_change_abund, total_chabund_gr=total_change_abund)
death_sample_net <- death_sample %>% select(DOC, Inoculant, mean_chabund_de=mean_change_abund, total_chabund_de=total_change_abund)

# Combine and calculate net change abundance
chabund_net <- full_join(growth_sample_net, death_sample_net) %>% 
  mutate(net_mean_chabund = mean_chabund_gr + mean_chabund_de,
         net_total_chabund = total_chabund_gr + total_chabund_de)
```

# NOTE: investigate outlier Inoculant 47, has much lower values than other high DOC innocs

### Plots

```{r}
# Mean
chabund_net %>% 
  ggplot(aes(x=DOC, y=net_mean_chabund, color=Inoculant)) +
  geom_point() +
  theme_test()

# Total
chabund_net %>% 
  ggplot(aes(x=DOC, y=net_total_chabund, color=Inoculant)) +
  geom_point() +
  theme_test()
```

### Statistics

Net mean:

```{r}
# Linear model
net_mean_lm <- lm(net_mean_chabund ~ DOC, data=chabund_net)
hist(resid(net_mean_lm))
plot(predict(net_mean_lm), resid(net_mean_lm))
summary(net_mean_lm)
```

Net total:

```{r}
# Linear model
net_total_lm <- lm(net_total_chabund ~ DOC, data=chabund_net)
hist(resid(net_total_lm))
plot(predict(net_total_lm), resid(net_total_lm)) # heteroskedastic
summary(net_total_lm)

# Welch's t-test
t.test(net_total_chabund ~ DOC, data=chabund_net, var.equal=FALSE)
```

Trends of net change in abundance being greater/more positive for low samples than for high samples.


