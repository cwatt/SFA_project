---
title: "SFA2 - add paprica predictions"
author: "Cassandra Wattenburger"
date: "2/22/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(results = "show")
knitr::opts_chunk$set(message = FALSE)
```

```{r}
# Clear working directory, load in packages, generate package info
rm(list=ls())

library("tidyverse")

sessionInfo()
```

# Import data

Files produced using paprica v0.6. See /home/cassi/SFA/paprica_analysis directory.

```{r}
# PAPRICA outputs
# Bacteria
pap_bac <- read_csv("../paprica_analysis/output_bacteria/est-seqs.bacteria.edge_data.csv")
place_bac <- read_csv("../paprica_analysis/output_bacteria/est-seqs.bacteria.combined_16S.bacteria.tax.placements.csv")

# Archaea
pap_arc <- read_csv("../paprica_analysis/output_archaea/est-seqs.archaea.edge_data.csv")
place_arc <- read_csv("../paprica_analysis/output_archaea/est-seqs.archaea.combined_16S.archaea.tax.placements.csv")

# Growth and death estimates
growth <- readRDS("../data_intermediate/SFA2_growth_estimates.rds")
death <- readRDS("../data_intermediate/SFA2_death_estimates.rds")

# Taxonomy
tax <- readRDS("../data_intermediate/SFA2_taxonomy.rds")

# Pathways
path_bac <- read_csv("../paprica_analysis/output_bacteria/est-seqs.bacteria.pathways.csv")
path_arc <- read_csv("../paprica_analysis/output_archaea/est-seqs.archaea.pathways.csv")
```

# Edge data predictions

```{r}
# What's going on here:
# The global_edge_num col in the "...placements.csv" file matches to part of the string in the Pquery col in the "...edge_data.csv" file
# Using these to merge files

# Bacteria
place_bac <- place_bac %>% mutate(ASV = gsub("[0-9]+\\|(*)+", "\1", Pquery),
         ASV = gsub("\001", "", ASV))

pap_bac <- pap_bac %>% select(global_edge_num='...1', n16S, genome_size, phi, npaths_actual, nec_actual, confidence, branch_length)

paprica_bac <- full_join(place_bac, pap_bac)

# Archaea
place_arc <- place_arc %>% mutate(ASV = gsub("[0-9]+\\|(*)+", "\1", Pquery),
         ASV = gsub("\001", "", ASV))

pap_arc <- pap_arc %>% 
  select(global_edge_num='...1', n16S, genome_size, phi, npaths_actual, nec_actual, confidence, branch_length)

paprica_arc <- full_join(place_arc, pap_arc)

# Merge
pap_all <- bind_rows(paprica_bac, paprica_arc) %>% 
  inner_join(tax) %>% 
  select(ASV, global_edge_num, n16S, genome_size, phi, npaths_actual, nec_actual, confidence, branch_length, Domain:Species)
```

### Overall confidence of predictions

```{r}
mean(pap_all$confidence, na.rm=TRUE)
```

In the bacterial data, there are three taxa missing in the "...edge_data.csv" file. I'm not sure why, probably an obscure glitch in PAPRICA's pipeline. Submitted an issue [here](https://github.com/bowmanjeffs/paprica/issues/91). I'm going to average the n16S and genome_size across taxa from the same phyla as an approximation.

```{r}
# Missing data
pap_all %>% 
  filter(Phylum == "Acidobacteriota" | Phylum == "Chloroflexi")

# Average across phyla
missing_replace <- pap_all %>% 
  group_by(Phylum) %>% 
  summarize(n16s = mean(n16S, na.rm=TRUE),
            genome_size = mean(genome_size, na.rm=TRUE)) %>% 
  filter(Phylum=="Acidobacteriota" | Phylum=="Chloroflexi")
missing_replace

acido_n16S <- as.numeric(missing_replace[1,2])
acido_genome <- as.numeric(missing_replace[1,3])
chloro_n16S <- as.numeric(missing_replace[2,2])
chloro_genome <- as.numeric(missing_replace[2,3])

# Add back to data
pap_replace <- pap_all %>% 
  mutate(n16S = if_else(Phylum=="Acidobacteriota" & is.na(n16S), acido_n16S, if_else(Phylum=="Chloroflexi" & is.na(n16S), chloro_n16S, n16S)),
         genome_size = if_else(Phylum=="Acidobacteriota" & is.na(genome_size), acido_genome, if_else(Phylum=="Chloroflexi" & is.na(genome_size),
                                                                                                     chloro_genome, genome_size)))
```

Combine with growth and death estimates:

```{r}
growth_pap <- left_join(growth, pap_replace, by="ASV") %>% 
  select(-global_edge_num)
death_pap <- left_join(death, pap_replace, by="ASV") %>% 
  select(-global_edge_num)
```

Save:

```{r, eval=FALSE}
saveRDS(growth_pap, "../data_intermediate/SFA2_growth_estimates_pap2.rds")
saveRDS(death_pap, "../data_intermediate/SFA2_death_estimates_pap2.rds")
```

# Pathway predictions

Reformat:

```{r}
# Bacterial
path_bac_long <- path_bac %>%
  rename(pathway = `...1`) %>% 
  pivot_longer(-pathway, names_to = "global_edge_num", values_to = "value")

# Archaeal
path_arc_long <- path_arc %>%
  rename(pathway = `...1`) %>% 
  pivot_longer(-pathway, names_to = "global_edge_num", values_to = "value")

# Combine pathway data
path_all <- bind_rows(path_bac_long, path_arc_long)
```

Add ASV names:

```{r}
pap_asvs <- pap_replace %>% select(ASV, global_edge_num)
pap_paths <- inner_join(pap_asvs, path_all)
```

Combine with growth and death estimates:

```{r}
growth_paths <- left_join(growth, pap_paths, by="ASV") %>% 
  select(-c(k:change_abund, global_edge_num))

death_paths <- left_join(death, pap_paths, by="ASV") %>% 
  select(-c(k:change_abund, global_edge_num))
```

Save:

```{r, eval=FALSE}
saveRDS(growth_paths, "../data_intermediate/SFA2_growth_estimates_pathways.rds")
saveRDS(death_paths, "../data_intermediate/SFA2_death_estimates_pathways.rds")
```



