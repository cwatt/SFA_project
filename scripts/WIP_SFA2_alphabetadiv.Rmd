---
title: "SFA2 - alpha and beta diversity"
author: "Cassandra Wattenburger"
date: "11/15/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(results = "show")
knitr::opts_chunk$set(message = FALSE)
```

```{r}
# Clear working directory, load in packages, generate package info
rm(list=ls())

library("tidyverse")
library("vegan")
library("ape")
library("phyloseq")
library("reticulate")

sessionInfo()
```

# Import data

Phyloseq object produced in 02_SFA2_preprocess_redos.Rmd. This data has been:
* sparsity filtered
* had mitochondria, chloroplasts, prokarya removed
* Original samples that were resequenced replaced

```{r}
physeq <- readRDS("../data_intermediate/SFA2_physeq_counts.rds")
physeq
```

# All time points

### Assess read depth

```{r}
# Extract count and metadata from processed phyloseq object
count_all <- data.frame(otu_table(physeq))
meta_all <- data.frame(sample_data(physeq)) %>%
  select(-SampleID) %>%
  rownames_to_column(var="SampleID")

# Calculate read depth per sample
read_depth <- count_all %>%
  rownames_to_column(var="ASV") %>%
  gather(SampleID, count, -ASV) %>%
  spread(ASV, count) %>%
  mutate(total_reads = rowSums(.[-1])) %>%
  select(SampleID, total_reads) %>%
  inner_join(meta_all) %>% 
  mutate(Attempt = as_factor(Attempt)) %>% 
  as_tibble()

# Min and max read depth
max(read_depth$total_reads)
min(read_depth$total_reads)

# Visualize
read_depth %>%
  mutate(Replicate = as_factor(Replicate)) %>%
  filter(Type != "PCR control") %>%
  ggplot(aes(x=Sample, y=total_reads, fill=Replicate)) +
  geom_col() +
  geom_hline(yintercept = 6000, linetype=2) +
  labs(x="Sample", y="Reads") +
  theme_test()

max(read_depth$total_reads)
min(read_depth$total_reads)

# Number of samples below 6000 counts
dim(filter(read_depth, Type != "PCR control" & total_reads < 1000))
filter(read_depth, Type != "PCR control" & total_reads < 1000) %>% arrange(total_reads)
```

I'll rarefy to 1000 and lose 38 samples.

### Rarefy

```{r}
physeq_rare <- rarefy_even_depth(physeq, sample.size=1000, rngseed=42)

physeq_rare <- subset_samples(physeq_rare, DOC %in% c("high", "low"))
physeq_rare
```

### Reformatting metadata and tree

```{r}
# Reformat metadata
meta <- data.frame(sample_data(physeq_rare)) %>% 
  as_tibble() %>% 
  mutate(Inoculant = as_factor(Inoculant))

# Reformat tree
tree_new <- multi2di(phy_tree(physeq_rare))

# Phyloseq
physeq_rare <- phyloseq(otu_table(physeq_rare, taxa_are_rows = TRUE), sample_data(meta),
                          tax_table(physeq_rare), phy_tree(tree_new))
```

### Alpha diversity

```{r}
# Extract data from phyloseq
count_rare <- data.frame(otu_table(physeq_rare)) %>% 
  rownames_to_column(var="ASV") %>% 
  gather(SampleID, count, -ASV)

tax_rare <- data.frame(tax_table(physeq_rare)) %>% 
  rownames_to_column(var="ASV")

meta_rare <- data.frame(sample_data(physeq_rare)) %>% 
  select(-SampleID) %>% 
  rownames_to_column(var="SampleID")

# Combine
count_tax_meta <- inner_join(count_rare, tax_rare) %>% 
  inner_join(meta_rare, by="SampleID") %>% 
  select(c(SampleID, Sample, Type:DOC, Day, Domain:Species, ASV, count)) %>% 
  mutate(Inoculant = as_factor(Inoculant)) %>% 
  mutate(across(Domain:Species, ~as.character(.x), {.col}))
```

Calculate richness:

```{r}
richness <- count_tax_meta %>% 
  filter(count > 0) %>% 
  filter(ASV != "445e8681c3c1a735760e6c394f5f4d0a") %>%  # remove spike-in
  group_by(Sample, Inoculant, DOC, Day) %>% 
  summarize(richness = n()) %>% 
  ungroup()
```

Calculate evenness (J):

J = H/log(S)

Where H is Shannon-Weaver index and S is richness.

```{r}
# Reformat counts to be compatible with vegan
count_tax_meta_wide <- count_tax_meta %>% 
  select(ASV, Sample, count) %>% 
  pivot_wider(names_from="ASV", values_from="count") %>% 
  column_to_rownames(var="Sample")

# Calculate
shannon <- diversity(count_tax_meta_wide, "shannon")
rich <- specnumber(count_tax_meta_wide)
even <- shannon/log(rich)

# Add evennness values to data
even <- data.frame(even) %>% 
  rownames_to_column(var="Sample") %>% 
  rename(evenness=even) %>% 
  mutate(Sample = as.numeric(Sample))

alpha_df <- richness %>% 
  inner_join(even)

# Summarized data
alpha_overall <- alpha_df %>% 
  group_by(DOC, Inoculant) %>% 
  summarize(rich_sd = sd(richness), rich_mean = mean(richness),
            even_sd = sd(evenness), even_mean = mean(evenness)) %>% 
  ungroup() %>% 
  mutate(rich_cv = rich_sd/rich_mean, even_cv = even_sd/even_mean)
```

Plot:

```{r}
# Richness
alpha_df %>% 
  ggplot(aes(x=DOC, y=richness)) +
  geom_boxplot() +
  labs(x="DOC \"phentoype\"", y="ASV richness") +
  facet_wrap(~Day) +
  theme_test() +
  theme(title = element_text(size=18),
        axis.title = element_text(size=16),
        axis.text = element_text(size=14))

alpha_df %>% 
  ggplot(aes(x=DOC, y=richness, color=Inoculant)) +
  geom_boxplot() +
  labs(x="DOC \"phentoype\"", y="ASV richness") +
  facet_wrap(~Day) +
  theme_test() +
  theme(title = element_text(size=18),
        axis.title = element_text(size=16),
        axis.text = element_text(size=14))

alpha_overall %>% 
  ggplot(aes(x=DOC, y=rich_mean)) +
  geom_point() +
  theme_test()

alpha_overall %>% 
  ggplot(aes(x=DOC, y=rich_cv)) +
  geom_point() +
  theme_test()

# Evenness
alpha_df %>% 
  ggplot(aes(x=DOC, y=evenness)) +
  geom_boxplot() +
  facet_wrap(~Day) +
  labs(x="DOC \"phentoype\"", y="Evenness") +
  theme_test() +
  theme(title = element_text(size=18),
        axis.title = element_text(size=16),
        axis.text = element_text(size=14))

alpha_df %>% 
  ggplot(aes(x=DOC, y=evenness, color=Inoculant)) +
  geom_boxplot() +
  facet_wrap(~Day) +
  labs(x="DOC \"phentoype\"", y="Evenness final tp") +
  theme_test() +
  theme(title = element_text(size=18),
        axis.title = element_text(size=16),
        axis.text = element_text(size=14))

alpha_overall %>% 
  ggplot(aes(x=DOC, y=even_mean)) +
  geom_point() +
  theme_test()

alpha_overall %>% 
  ggplot(aes(x=DOC, y=even_cv)) +
  geom_point() +
  theme_test()
```

Statistics:

```{r}
# Evenness overall
even_lm <- lm(log(even_mean) ~ DOC, data=alpha_overall)
hist(residuals(even_lm)) # log transform helps normality
plot(predict(even_lm), residuals(even_lm)) # Heteroskedastic

# Welch's t-test
t.test(log(even_mean) ~ DOC, data=alpha_overall)
```

```{r}
# Evenness CV
cveven_lm <- lm(even_cv ~ DOC, data=alpha_overall)
hist(residuals(cveven_lm))
plot(predict(cveven_lm), residuals(cveven_lm))
summary(cveven_lm)
```


### Beta diversity

```{r}
# Weighted Unifrac
wunifrac_dist <- distance(physeq_rare, method="wunifrac")
ord_wunifrac <- ordinate(physeq_rare, distance=wunifrac_dist, method="PCoA")

plot_ordination(physeq_rare, ord_wunifrac, color="DOC") +
  stat_ellipse(type="t") +
  facet_wrap(~Day) +
  theme_test() +
  theme(title = element_text(size=18),
        axis.title = element_text(size=16),
        axis.text = element_text(size=14))

# Ctrl+Shift+C to comment multiple lines
# # Plot each day individually for animation
# for (day in unique(sample_data(physeq_rare)$Day)) {
#   graph <- plot_ordination(subset_samples(physeq_rare, Day==day), ord_wunifrac, color="Inoculant") +
#     facet_wrap(~DOC) +
#     labs(title=paste0("Day ", day)) +
#     theme_test() +
#     theme(title = element_text(size=18),
#         axis.title = element_text(size=16),
#         axis.text = element_text(size=14))
#   print(graph)
# }


# Unweighted unifrac
unifrac_dist <- distance(physeq_rare, method="unifrac")
ord_unifrac <- ordinate(physeq_rare, distance=unifrac_dist, method="PCoA")

plot_ordination(physeq_rare, ord_unifrac, color="DOC") +
  stat_ellipse(type="t") +
  facet_wrap(~Day) +
  theme_test() +
  theme(title = element_text(size=18),
        axis.title = element_text(size=16),
        axis.text = element_text(size=14))
```

### Stability

Using distance matrices to evaluate how dynamic over time the communities were.

Prediction: Distances within Inoculants will be higher for less "stable" communities, low will be less "stable", particularly towards ends of experiment.

```{r}
# Calculate distances
wunifrac_dist <- distance(physeq_rare, "wunifrac")

# Reformat distance object
wunifrac_m <- as.matrix(wunifrac_dist)
diag(wunifrac_m) <- NA # remove self comparisons
wunifrac_m[upper.tri(wunifrac_m)] <-NA # remove redundant comparisons

wunifrac_df <- wunifrac_m %>% 
  as.data.frame() %>% 
  rownames_to_column(var="sample1") %>%
  pivot_longer(!sample1, names_to="sample2", values_to="wunifrac") %>% 
  na.omit()

# Add metadata
meta_slim <- meta_rare %>% 
  select(SampleID, DOC, Inoculant, Day)

wunifrac_meta <- wunifrac_df %>% 
  full_join(meta_slim, by=c("sample1"="SampleID")) %>% 
  rename(DOC1 = DOC, Innoc1 = Inoculant, Day1=Day) %>% 
  full_join(meta_slim, by=c("sample2"="SampleID")) %>% 
  rename(DOC2 = DOC, Innoc2 = Inoculant, Day2=Day) %>% 
  select(sample1, sample2, DOC1, DOC2, Innoc1, Innoc2, Day1, Day2, wunifrac) %>% 
  filter(Day1==Day2)

# Plot
wunifrac_meta %>% 
  mutate(target = if_else(Innoc1==Innoc2, "yes", "no")) %>%
  filter(target=="yes") %>% 
  ggplot(aes(x=DOC1, y=wunifrac, group=Innoc1, color=DOC1)) +
  geom_boxplot() +
  facet_wrap(~Day1) +
  theme_test()

wunifrac_meta %>% 
  mutate(target = if_else(Innoc1==Innoc2, "yes", "no")) %>%
  filter(target=="yes") %>% 
  ggplot(aes(x=DOC1, y=wunifrac, color=DOC1)) +
  geom_boxplot() +
  facet_wrap(~Day1) +
  theme_test()

wunifrac_meta %>% 
  mutate(target = if_else(Innoc1==Innoc2, "yes", "no")) %>%
  filter(target=="yes") %>% 
  ggplot(aes(x=DOC1, y=wunifrac, group=Innoc1)) +
  geom_boxplot() +
  theme_test()
```

The variation seems greater than the difference between high and low treatments. Not seeing support for prediction.

# Growth vs headspace

Isolate final time point:

```{r}
physeq_end <- subset_samples(physeq, Day==30)
```

### Assess read depth

```{r}
# Extract count and metadata from processed phyloseq object
count_end <- data.frame(otu_table(physeq_end))
meta_end <- data.frame(sample_data(physeq_end)) %>%
  select(-SampleID) %>%
  rownames_to_column(var="SampleID") %>% 
  mutate(Inoculant == as.character(Inoculant))

# Calculate read depth per sample
read_depth <- count_end %>%
  rownames_to_column(var="ASV") %>%
  gather(SampleID, count, -ASV) %>%
  spread(ASV, count) %>%
  mutate(total_reads = rowSums(.[-1])) %>%
  select(SampleID, total_reads) %>%
  inner_join(meta_end) %>% 
  mutate(Attempt = as_factor(Attempt)) %>% 
  as_tibble()

# Min and max read depth
max(read_depth$total_reads)
min(read_depth$total_reads)

# Visualize
read_depth %>%
  mutate(Replicate = as_factor(Replicate)) %>%
  filter(Type != "PCR control") %>%
  ggplot(aes(x=Sample, y=total_reads, fill=Replicate)) +
  geom_col() +
  labs(x="Sample", y="Reads") +
  theme_test()

max(read_depth$total_reads)
min(read_depth$total_reads)

# Number of samples below 6000 counts
dim(filter(read_depth, Type != "PCR control" & total_reads <= 1034))
filter(read_depth, Type != "PCR control" & total_reads <= 1034) %>% arrange(total_reads)
```

### Rarefy

Rarefy to smallest sample depth, 1034.

```{r}
physeq_rare_end <- rarefy_even_depth(physeq_end, sample.size=1034, rngseed=42)
physeq_rare_hilow <- subset_samples(physeq_rare_end, DOC %in% c("high", "low"))
physeq_rare_hilow
```

### Beta diversity

```{r}
set.seed(22)

# Weighted Unifrac
wunifrac_dist <- distance(physeq_rare_hilow, method="wunifrac")
ord_wunifrac <- ordinate(physeq_rare_hilow, distance=wunifrac_dist, method="NMDS")

plot_ordination(physeq_rare_hilow, ord_wunifrac, color="Type") +
  stat_ellipse(type="t") +
  facet_wrap(~DOC) +
  theme_test() +
  theme(title = element_text(size=18),
        axis.title = element_text(size=16),
        axis.text = element_text(size=14))

# High only
physeq_end_high <- subset_samples(physeq_rare_hilow, DOC=="high")
high_dist <- distance(physeq_end_high, method="wunifrac")
high_ord <- ordinate(physeq_end_high, distance=high_dist, method="NMDS")

plot_ordination(physeq_end_high, high_ord, color="Type") +
  stat_ellipse(type="t") +
  labs(title="High DOC") +
  theme_test() +
  theme(title = element_text(size=18),
        axis.title = element_text(size=16),
        axis.text = element_text(size=14))
  
# Low only
physeq_end_low <- subset_samples(physeq_rare_hilow, DOC=="low")
low_dist <- distance(physeq_end_low, method="wunifrac")
low_ord <- ordinate(physeq_end_low, distance=low_dist, method="NMDS")

plot_ordination(physeq_end_low, low_ord, color="Type") +
  stat_ellipse(type="t") +
  labs(title="Low DOC") +
  theme_test() +
  theme(title = element_text(size=18),
        axis.title = element_text(size=16),
        axis.text = element_text(size=14))
```

Statistics:

```{r}
# High DOC
high_df <- data.frame(sample_data(physeq_end_high))
high_adonis <- adonis(high_dist~Type, data=high_df, permutations=999)
high_adonis

# Low DOC
low_df <- data.frame(sample_data(physeq_end_low))
low_adonis <- adonis(low_dist~Type, data=low_df, permutations=999)
low_adonis
```

### Relative abundances

High and low:

```{r}
# Convert counts to relative abundances
physeq_end_relabund <- transform_sample_counts(physeq_rare_end, function(x) x/sum(x))
#physeq_relabund_hilow <- subset_samples(physeq_end_relabund, DOC != "control")

# Export from phyloseq
meta_relabund <- data.frame(sample_data(physeq_end_relabund)) %>% 
  rownames_to_column(var="merge") %>% 
  select(merge, Sample, Type, Inoculant, DOC, Replicate)

count_relabund <- as.matrix(otu_table(physeq_end_relabund)) %>% 
  t() %>% 
  as.data.frame() %>%
  rownames_to_column(var="merge") %>% 
  inner_join(meta_relabund) %>% 
  pivot_longer(c(everything(), -c(merge, Sample, Type, Inoculant, DOC, Replicate)),
               names_to="ASV", values_to="relabund")

tax_relabund <- as.data.frame(tax_table(physeq_end_relabund)) %>% 
  rownames_to_column(var="ASV")
  
relabund <- count_relabund %>% 
  group_by(DOC, Type, Inoculant, ASV) %>% # average across replicates
  summarize(relabund = mean(relabund)) %>% 
  ungroup() %>% 
  inner_join(tax_relabund)
```

Plot:

```{r}
# High DOC
relabund %>% 
  filter(DOC=="high") %>% 
  ggplot(aes(x=Inoculant, y=relabund, fill=reorder(Phylum, -relabund))) +
  geom_col() +
  facet_wrap(~Type) +
  labs(title="High DOC") +
  theme_test()

# Low DOC
relabund %>% 
  filter(DOC=="low") %>% 
  ggplot(aes(x=Inoculant, y=relabund, fill=reorder(Phylum, -relabund))) +
  geom_col() +
  facet_wrap(~Type) +
  labs(title="Low DOC") +
  theme_test()

# Control
relabund %>% 
  filter(DOC=="control") %>% 
  ggplot(aes(x=Inoculant, y=relabund, fill=reorder(Phylum, -relabund))) +
  geom_col() +
  labs(title="Control") +
  theme_test()
```

### Number of cross-contam ASVs

How many cross-contaminants are in each treatment?

NOTE: I want the number of control ASVs in each sample of the high and low treatments

```{r}
ctrl_df <- count_relabund %>% 
  filter(DOC=="control") %>% 
  select(DOC, Sample, Inoculant, ASV, relabund) %>% 
  mutate(across(relabund, ~ if_else(.x > 0, 1, 0))) %>%  # convert to presence/absence
  filter(relabund > 0) %>% 
  select(DOC, Sample, Inoculant, ASV)

# Sample totals
ctrl_sam_totals <- ctrl_df %>% 
  group_by(DOC, Sample) %>% 
  summarize(total = n()) %>% 
  ungroup()

# High overlap
high_df <- count_relabund %>% 
  filter(DOC=="high" & Type=="Headspace") %>% 
  mutate(across(relabund, ~ if_else(.x > 0, 1, 0))) %>%  # convert to presence/absence
  filter(relabund > 0) %>% 
  select(DOC, Sample, Inoculant, ASV) %>% 
  semi_join(ctrl_df, by="ASV") # keep only potential contaminants

# Sample totals 
high_sam_totals <- high_df %>% 
  group_by(DOC, Sample) %>% 
  summarize(total = n()) %>% 
  ungroup()

# Low overlap
low_df <- count_relabund %>% 
  filter(DOC=="low" & Type=="Headspace") %>% 
  mutate(across(relabund, ~ if_else(.x > 0, 1, 0))) %>%  # convert to presence/absence
  filter(relabund > 0) %>% 
  select(DOC, Sample, Inoculant, ASV) %>% 
  semi_join(ctrl_df, by="ASV") # keep only potential contaminants

# Sample totals 
low_sam_totals <- low_df %>% 
  group_by(DOC, Sample) %>% 
  summarize(total = n()) %>% 
  ungroup()
```

Plot:

```{r}
# Combine
sam_totals <- bind_rows(ctrl_sam_totals, high_sam_totals) %>% 
  bind_rows(low_sam_totals)

sam_totals %>% 
  ggplot(aes(x=DOC, y=total)) +
  geom_jitter(alpha=0.5) +
  geom_boxplot() +
  labs(title="Potential cross-contaminants on day 30", y="total ASVs overlapping in controls") +
  theme_test()
```

Statistics:

```{r}
totals_lm <- lm(total ~ DOC, data=filter(sam_totals, DOC != "control"))
hist(resid(totals_lm))
plot(predict(totals_lm), resid(totals_lm))
summary(totals_lm)
```

Significantly less total cross-contaminants in low DOC treatment.

### Abundance of potential cross-contams

Using un-rarefied internal-standard normalized counts.

Prepare data:

```{r}
# Import normalized count data and metadata
count_norm <- readRDS("../data_intermediate/SFA2_count_normalized.rds")

meta <- read_tsv("../data_amplicon/SFA2_full/SFA2_full_metadata.tsv") %>% 
  filter(Type=="Headspace" | DOC=="control") %>% 
  select(SampleID, Sample, Type, DOC, Inoculant, Day) %>% 
  mutate(SampleID = as.character(SampleID),
         SampleID = gsub("^", "sa", SampleID)) # convert to match SampleID in count_norm

# Join
norm <- inner_join(meta, count_norm) %>% 
  pivot_longer(-c(SampleID, Sample, Type, DOC, Inoculant, Day), names_to = "ASV", values_to="norm_abund")
```

Isolate potential cross-contaminants from controls:

```{r}
# Create list of ASVs present in controls
norm_ctrl_asvs <- norm %>% 
  filter(DOC=="control" & norm_abund > 0) %>%
  .$ASV %>% 
  unique(.)
```

Calculate total "biomass" of cross-contaminants in high and low:

```{r}
norm_contam <- norm %>% 
  filter((DOC=="low" | DOC=="high") & ASV %in% norm_ctrl_asvs & norm_abund > 0)

norm_contam_total <- norm_contam %>% 
  group_by(Sample, DOC, Inoculant, Day) %>% 
  summarize(total_abund = sum(norm_abund))
```

Plot:

```{r}
norm_contam_total %>%  
  ggplot(aes(x=DOC, y=total_abund, color=Inoculant)) +
  geom_jitter() +
  geom_boxplot() +
  labs(title="Potential contaminants at day 30", y="total norm. abund.") +
  theme_test()
```

Statistics:

```{r}
contam_abund_lm <- lm(log(total_abund) ~ DOC, norm_contam_total)
hist(resid(contam_abund_lm)) # log transform helps normality
plot(predict(contam_abund_lm), resid(contam_abund_lm)) # log transform helps heteroskedasticity
summary(contam_abund_lm)
```

Not a significant difference in total biomass at the end time point.

Even though the number of cross-contaminants may have been lower in low DOC phenotype, the biomass was comparable, so they grew more compared to in high? Could explain DOC outcome?










