---
title: "SFA1.5 - DOC and CO2 analysis"
author: "Cassi Wattenburger"
date: "3/16/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(results = "show")
```

**Goal of this script:** Confirm that high and low DOC producing communities identified in SFA1 are reproducibile.

```{r}
rm(list=ls())

library(plyr)
library(tidyverse)
require(broom)
library(reshape2)
library(qqplotr)
library(car)
library(lmerTest)
```


# DOC results

```{r}
# Import data
doc = read.csv("../data_DOC/SFA1.5/SFA1.5_DOCsummary.csv")

# Import metadata
meta = read.csv("../data_DOC/SFA1.5/SFA1.5_DOC_metadata.csv")

# Add metadata
doc.meta = merge(meta, doc, by.y="Sample.ID", by.x="ucosm", all=TRUE)
doc.meta = doc.meta[,-c(5,7)]

# Sample means
doc.mean = ddply(doc.meta, .(Sample,DOC), summarize, sample.mean = mean(mean), sample.stdv = sd(mean))
```

```{r, results="show"}
# Visualize
ggplot(doc.meta, aes(x=as.factor(Sample), y=mean, color=DOC)) +
  geom_boxplot(aes(group=Sample)) +
  geom_point() +
  theme_test() +
  labs(x="Sample", y="DOC conc.")

ggplot(doc.meta, aes(x=DOC, y=mean, color=DOC)) +
  geom_boxplot(aes(group=DOC)) +
  geom_point() +
  theme_test() +
  labs(x="Sample", y="DOC conc. (replicates)")

ggplot(doc.mean, aes(x=DOC, y=sample.mean, color=DOC)) +
  geom_boxplot(aes(group=DOC)) +
  geom_point() +
  theme_test() +
  labs(x="Sample", y="DOC conc. (sample avgs)") +
  geom_smooth(method="lm")

# for SFSA progress report:
doc.plot <- doc.mean %>% 
  filter(DOC != "negative") %>%
  ggplot(aes(x=DOC, y=sample.mean)) +
  geom_boxplot() +
  labs(x="DOC phenotype", y="Mean DOC conc. (ppm)") +
  annotate("text", x=2.1, y=1300, label="P-value < 0.0001") +
  theme_test() +
  theme(text = element_text(size=15))
doc.plot

ggsave(doc.plot, file="../figures/SFA1.5_DOC.png", units="mm", width=100, height=100)
```

**Statistics**

Linear mixed effects model to allow innoculants to vary independently (same used for SFA2)

```{r}
doc.lmer <- lmer(mean ~ DOC + (1|Sample), data=doc.meta)
hist(residuals(doc.lmer))
plot(residuals(doc.lmer), predict(doc.lmer))
summary(doc.lmer)
```


Check normality and equality of variances.

```{r, results="show"}
# Use qqplots to check normality
ggplot(doc.mean, aes(sample = sample.mean, color = DOC, fill = DOC)) +
    stat_qq_band(alpha=0.5) +
    stat_qq_line() +
    stat_qq_point() +
    facet_wrap(~ DOC) +
    labs(x = "Theoretical Quantiles", y = "Sample Quantiles")

# Use boxplots and Levene's test to evaluate equality of variances
leveneTest(sample.mean ~ DOC, data=doc.mean)
```

Data appears normal and has equal variances. Use simple linear regression

```{r}
# Simple linear model
doc.lm = lm(sample.mean ~ DOC, data=doc.mean[which(doc.meta$DOC=="high" | doc.meta$DOC=="low"),])
hist(resid(doc.lm)) # check normality of residuals
plot(predict(doc.lm), resid(doc.lm)) # check that variances or equal
summary(doc.lm)

doc.test = t.test(sample.mean ~ DOC, data=doc.mean[which(doc.meta$DOC=="high" | doc.meta$DOC=="low"),], var.equal=TRUE)
doc.test$p.value
```

T-test result same as linear regression result.


### Variability between phases 1 and 1.5

```{r, results="show"}
# SFA 1 data
load("../r.objects/SFA1_DOC.data.RData")

# Summarize replicates
data.melt=melt(DOC.data[,c(2,3,6)], id.vars=c("s.type","Soil.sample"))
data.smry=ddply(data.melt, c("Soil.sample","s.type"), summarize, avg=mean(value), stdv=sd(value))

# Isolate samples from phase 1
sfa1.doc = data.smry[data.smry$Soil.sample %in% as.character(doc.mean$Sample),]
sfa1.doc = sfa1.doc[,c(1,3:4)]
colnames(sfa1.doc) = c("Sample", "mean","stdv")
sfa1.doc = cbind(sfa1.doc, phase=rep("SFA1", nrow(sfa1.doc)))

# Reformat phase 1.5 data
sfa1.5.doc = doc.mean[,c(1,3:4)]
colnames(sfa1.5.doc) = c("Sample","mean","stdv")
sfa1.5.doc = cbind(sfa1.5.doc, phase=rep("SFA1.5", nrow(sfa1.5.doc)))

# Merge phases
both.doc = rbind(sfa1.doc, sfa1.5.doc)
highlow = doc.mean[,c(1:2)] # add DOC rank
both.doc = merge(both.doc, highlow)

avg.hi = mean(both.doc[both.doc$DOC=="high",]$mean)
avg.lo = mean(both.doc[both.doc$DOC=="low",]$mean)

# Visualize
ggplot(both.doc, aes(x=Sample, y=mean, shape=phase, color=DOC)) +
  geom_point() +
  geom_errorbar(aes(ymin=mean-stdv, ymax=mean+stdv), width=0.5) +
  geom_hline(yintercept=avg.hi, color="#F8766D", linetype=2) +
  geom_hline(yintercept=avg.lo, color="#7CAE00", linetype=2) +
  scale_y_continuous(limits=c(0,4000)) +
  theme_test() +
  labs(y="DOC conc.")
```

These are suprisingly reproducible. Negative control had a contamination issue in SFA1, but contamination doesn't seem to have had an effect on the DOC outcome in innoculated samples

How reproducible is the DOC result?

Regressions between SFA 1 and 1.5:

```{r}
# Mean DOC
both.doc.noctrl = both.doc[!both.doc$Sample==51,]
both.doc2 = as.data.frame(cbind(sample=both.doc.noctrl[both.doc.noctrl$phase=="SFA1",]$Sample, sfa1=both.doc.noctrl[both.doc.noctrl$phase=="SFA1",]$mean, sfa1.5=both.doc.noctrl[both.doc.noctrl$phase=="SFA1.5",]$mean))
both.doc2 = cbind(both.doc2, DOC=both.doc.noctrl[both.doc.noctrl$phase=="SFA1",]$DOC) # not sure why I couldn't put this in above

# Visualize
ggplot(both.doc2, aes(x=sfa1, y=sfa1.5)) +
  geom_point(aes(shape=DOC)) +
  geom_smooth(method="lm", linetype=2) +
  geom_abline(intercept=0, slope=1, linetype=2) +
  scale_x_continuous(limits=c(0,1600)) +
  scale_y_continuous(limits=c(0,1600)) +
  theme_test() +
  theme(legend.position = c(0.1, 0.8)) +
  labs(title="Mean DOC conc.", x="experiment 1", y="experiment 2")

# Standard deviation DOC
both.doc3 = as.data.frame(cbind(sample=both.doc.noctrl[both.doc.noctrl$phase=="SFA1",]$Sample, sfa1=both.doc.noctrl[both.doc.noctrl$phase=="SFA1",]$stdv, sfa1.5=both.doc.noctrl[both.doc.noctrl$phase=="SFA1.5",]$stdv))
both.doc3 = cbind(both.doc3, DOC=both.doc.noctrl[both.doc.noctrl$phase=="SFA1",]$DOC)

# Visualize
ggplot(both.doc3, aes(x=sfa1, y=sfa1.5)) +
  geom_point(aes(shape=DOC)) +
  geom_smooth(method="lm", linetype=2) +
  geom_abline(intercept=0, slope=1, linetype=2) +
  scale_x_continuous(limits=c(0,500)) +
  scale_y_continuous(limits=c(0,500)) +
  theme_test() +
  theme(legend.position = c(0.1, 0.8)) +
  labs(title="Standard dev. DOC conc.", x="experiment 1", y="experiment 2")

```

**Statistics**

```{r}
test.avg = lm(sfa1 ~ sfa1.5, both.doc2)
print("Mean DOC conc. SFA1 vs SFA1.5:")
summary(test.avg)

print("Stdev DOC conc. SFA1 vs SFA1.5:")
test.stdev = lm(sfa1 ~ sfa1.5, both.doc3)
summary(test.stdev)
```

Mean of DOC is much more reproducible than variation of DOC.

Which samples shifted least between experiments in terms of DOC result?

```{r, results="show"}
# Subtract mean of SFA1 from SFA1.5
diff.doc = both.doc %>% group_by(phase) %>% mutate(diff = mean - lag(mean, default=first(mean)))
diff.doc = diff.doc[c(2,4,6,8,10,12,14,16,18,20,22,24,26),c(1,5:6)]
diff.doc$diff = abs(diff.doc$diff)
diff.ord = arrange(diff.doc, diff)
diff.ord
```

Samples 19, 47, 2 vary the least between experiments of the high DOC producing communities. Samples 10, 12, 41 for low.

```{r}
# Least variable samples
chosen.doc = doc.mean[doc.mean$Sample %in% c(19,47,2,10,12,41),]

# Visualize
ggplot(chosen.doc, aes(x=as.factor(Sample), y=sample.mean, color=DOC)) +
  geom_point() +
  geom_errorbar(aes(ymin=sample.mean-sample.stdv, ymax=sample.mean+sample.stdv), width=0.5) +
  theme_test() +
  labs(y="DOC conc.", x="Sample")
```

I don't like how much those deviations overlap.

**Statistics**

```{r}
chosenind.doc = filter(doc.meta, Sample %in% c(19,47,2,10,12,41))
docchosen.lm = lm(mean ~ DOC, data=chosenind.doc[which(chosenind.doc$DOC=="high" | chosenind.doc$DOC=="low"),])
hist(resid(docchosen.lm)) # assess normality of fit
plot(predict(docchosen.lm), resid(docchosen.lm)) # assess equal variances
summary(docchosen.lm)
```

I think the analysis is likely robust to the departure from normality.


### Correlations between DOC production and wash protien conc. or volume used

```{r, results="show"}
prot.meta = read.csv("~/SFAgrowthrate/protein_extractions/SFA1_washprotein_metadata.csv")
doc.prot = merge(doc.mean, prot.meta)

ggplot(doc.prot, aes(x=sample.mean, Protein)) +
  geom_point() +
  geom_smooth(method="lm") +
  theme_test() +
  labs(x="DOC conc.", "Protein conc.")

ggplot(doc.prot, aes(x=sample.mean, Volume)) +
  geom_point() +
  geom_smooth(method="lm") +
  theme_test() +
  labs(x="DOC conc.", "Wash volume")
```

Still no correlation between DOC produciton and protein concentration or volume of innoculant used.
