---
title: "Cryptic growth"
author: "Cassandra Wattenburger"
date: "9/15/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

```{r}
# Clear working directory, load in packages, generate package info
rm(list=ls())

library("phyloseq")
library("vegan")
library("tidyverse")
library("lmerTest")

sessionInfo()
```

# Import data

```{r}
# Import growth/death estimates and normalized abundance data
growth <- readRDS("../data_intermediate/SFA2_growth_estimates_pap.rds")
death <- readRDS("../data_intermediate/SFA2_death_estimates_pap.rds")
grnorm_abund <- readRDS("../data_intermediate/SFA2_norm_grestimated.rds")
denorm_abund <- readRDS("../data_intermediate/SFA2_norm_deestimated.rds")

# Combine and calculate corrected normalized abundanc
growth_abund <- full_join(growth, grnorm_abund) %>% 
  mutate(norm_abund_corr = norm_abund_avg/n16S)  %>% # Correct 16S copy number
  select(Inoculant, ASV, Day, k, start_day, end_day, norm_abund_corr)

death_abund <- full_join(death, denorm_abund) %>% 
  mutate(norm_abund_corr = norm_abund_avg/n16S)  %>% # Correct 16S copy number
  select(Inoculant, ASV, Day, k, start_day, end_day, norm_abund_corr)
```

# Weighted mean growth rates

Calculate weighted mean specific growth rate per time point:

* Based on normalized abundance (16S corrected)

```{r}
# Calculate weighted k
weighted_gr <- data.frame()

for (d in unique(growth_abund$Day)) {
  for (i in unique(growth_abund$Inoculant)) {
  data_subset <- filter(growth_abund, Day==d & Inoculant==i)
  weighted_mean <- weighted.mean(data_subset$k, data_subset$norm_abund_corr)
  this_row <- bind_cols(Inoculant=i, Day=d, weighted_k=weighted_mean)
  weighted_gr <- bind_rows(weighted_gr, this_row)
  }
}

# Visualize
weighted_gr %>% 
  ggplot(aes(x=Day, y=weighted_k)) +
  geom_point() +
  geom_line() +
  facet_wrap(~Inoculant) +
  labs(title="Weighted mean growth rates over time") +
  theme_test()
```

# Number of growing taxa

```{r}
# Calculate number growing taxa per inoculant per day
num_grow <- growth_abund %>% 
  group_by(Inoculant, Day) %>% 
  summarize(num_taxa = n()) %>% 
  ungroup()

# Visualize
num_grow %>% 
  ggplot(aes(x=Day, y=num_taxa)) +
  geom_point() +
  geom_line() +
  facet_wrap(~Inoculant) +
  labs(title="Number of growing taxa per inoculant") +
  theme_test()

num_grow %>% 
  ggplot(aes(x=Day, y=num_taxa)) +
  geom_point() +
  labs(title="Number of growing taxa") +
  theme_test()
```

Balance of growth and death in different phases of community growth:

Prediction: Growth abundance gains > death abundance losses during exponential, growth abundance gains = death abundance losses in stationary.

Gains:

```{r}
# Label datasets by community growth phase
growth_abund <- growth_abund %>% 
  mutate(phase = if_else(Day >= 9, "stationary", "exponential"))

# Label estimates by phase growth or death observed
growth_abund <- growth_abund %>% 
  mutate(growth_phase = if_else(start_day < 9, "exponential", "stationary"))

# Calculate gains in abundance
gain_abund <- data.frame()

for (i in unique(growth_abund$Inoculant)) {
  for (a in unique(growth_abund[growth_abund$Inoculant==i,]$ASV)) {
    for (p in unique(growth_abund[growth_abund$Inoculant==i & growth_abund$ASV==a,]$phase)) {
    data_sub <- filter(growth_abund, Inoculant==i & ASV==a & phase==p) %>% # isolate data
      arrange(Day)
    if (is.na(unique(data_sub$death_phase))) { # check for NA
      next
      }
    if (unique(data_sub$growth_phase)==p) {
      last <- nrow(data_sub)
      change_abund <- data_sub[last,]$norm_abund_corr - data_sub[1,]$norm_abund_corr
      this_row <- bind_cols(Inoculant=i, ASV=a, phase=p, gain=change_abund)
      gain_abund <- bind_rows(gain_abund, this_row)
    }
    else {
      next
    }
    }
  }
}

# Remove decreasing changes (didn't grow during that period)
gain_abund <- filter(gain_abund, gain > 0)

# Calculate total gains per phase
gain_abund_phase <- gain_abund %>% 
  group_by(Inoculant, phase) %>% 
  summarize(total_gain = sum(gain)) %>% 
  ungroup()

# Visualize
gain_abund_phase %>% 
  ggplot(aes(x=phase, y=total_gain, shape=Inoculant)) +
  geom_point() +
  theme_test()
```

Losses:

```{r}
# Label datasets by community death phase
death_abund <- death_abund %>% 
  mutate(phase = if_else(Day >= 9, "stationary", "exponential"))

# Label estimates by phase death or death observed
death_abund <- death_abund %>% 
  mutate(death_phase = if_else(start_day < 9, "exponential", "stationary"))

# Calculate losses in abundance
loss_abund <- data.frame()

for (i in unique(death_abund$Inoculant)) {
  for (a in unique(death_abund[death_abund$Inoculant==i,]$ASV)) {
    for (p in unique(death_abund[death_abund$Inoculant==i & death_abund$ASV==a,]$phase)) {
    data_sub <- filter(death_abund, Inoculant==i & ASV==a & phase==p) %>% # isolate data
      arrange(Day)
    if (is.na(unique(data_sub$death_phase))) { # check for NA
      next
      }
    else if (unique(data_sub$death_phase)==p) {
      last <- nrow(data_sub)
      change_abund <- data_sub[last,]$norm_abund_corr - data_sub[1,]$norm_abund_corr
      this_row <- bind_cols(Inoculant=i, ASV=a, phase=p, loss=change_abund)
      loss_abund <- bind_rows(loss_abund, this_row)
    }
    else {
      next
    }
    }
  }
}

# Remove increasing changes (didn't die during that period)
loss_abund <- filter(loss_abund, loss < 0)

# Calculate total losses per phase
loss_abund_phase <- loss_abund %>% 
  group_by(Inoculant, phase) %>% 
  summarize(total_loss = sum(loss)) %>% 
  ungroup()

# Visualize
loss_abund_phase %>% 
  ggplot(aes(x=phase, y=total_loss, shape=Inoculant)) +
  geom_point() +
  theme_test()
```

```{r}
# Combine
abund_gainloss <- full_join(gain_abund_phase, loss_abund_phase) %>% 
  pivot_longer(cols=c(total_gain, total_loss), names_to = "gain_loss", values_to="value")

# Visualize
abund_gainloss %>% 
  ggplot(aes(x=phase, y=value, color=gain_loss, shape=Inoculant)) +
  geom_point() +
  theme_test()

# Visualize
abund_gainloss %>% 
  ggplot(aes(x=phase, y=value, color=gain_loss)) +
  geom_jitter() +
  facet_wrap(~Inoculant) +
  theme_test()
```

Data is too patchy, missing too many values necessary to do comparison. Inoculant 2 behaves as expected, but inoculant 12 does not. The rest are missing values.

