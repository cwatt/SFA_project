---
title: "Untitled"
author: "Cassandra Wattenburger"
date: "3/7/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(results = "show")
knitr::opts_chunk$set(message = FALSE)
```

```{r}
# Clear working directory, load in packages, generate package info
rm(list=ls())

library("tidyverse")
library("picante")
library("phyloseq")

sessionInfo()
```

Resources used:
* Picante introduction: http://picante.r-forge.r-project.org/picante-intro.pdf

# Import data

* clustered growth data
* phylogenetic tree

```{r}
# Growth estimates/traits
growth <- readRDS("../data_intermediate/SFA2_growthclusters.Rmd") %>% 
  filter(cluster != 1) %>% # remove cluster 1 because it consists of a single outlier
  mutate(change_abund = change_abund/n16S, # correct abundance values by 16S copy number
         start_abund = start_abund/n16S,
         end_abund = end_abund/n16S,
         cluster = as.character(cluster)) # change clusters to character 

# Tree
tree <- read_tree("../data_amplicon/SFA2_full/tree/SFA2_full.tree-final.nwk")
```

# Prep community data

```{r}
gr_comm <- growth %>% 
  select(ASV, Inoculant, cluster) %>% 
  mutate(presence = 1) %>% # presence/absence
  pivot_wider(names_from="ASV", values_from="presence") %>% 
  mutate(across(-c("Inoculant", "cluster"), ~ if_else(is.na(.x), 0, .x))) %>% 
  rownames_to_column(var="Sample")

# Save metadata information
meta <- gr_comm %>% select(Sample, Inoculant, cluster)
```

# Calculate mean pairwise distances

### Individual inoculant x clusters

```{r}
mpd_ind <- data.frame()
for (i in unique(gr_comm$Inoculant)) {
  for (c in 2:4) {
    # Subset variables of interest
    data_sub <- filter(gr_comm, Inoculant==i & cluster==c) %>% 
      select(-c(Inoculant, cluster)) %>% 
      column_to_rownames(var="Sample") %>% 
      as.matrix()
    # Prune tree
    tree_prune <- prune.sample(data_sub, tree)
    # Calculate MPD
    mpd_sub <- mpd(data_sub, cophenetic(tree_prune))
    # Save result
    this_row <- bind_cols(Inoculant=i, cluster=c, mpd=mpd_sub)
    mpd_ind <- bind_rows(mpd_ind, this_row)
  }
}
```

### Whole communities (inoculant)

```{r}
mpd_whole <- data.frame()
# Collapse into presence/absence for whole community of each inoculant
for (i in unique(gr_comm$Inoculant)) {
  # Subset and condense community
  data_sub <- filter(gr_comm, Inoculant==i) %>% 
    select(-c(Sample, Inoculant, cluster)) %>% 
    colSums()
  data_sub <- bind_rows(data_sub) %>% 
    as.matrix()
  # Prune tree
  tree_prune <- prune.sample(data_sub, tree)
  # Calculate MPD
  mpd_sub <- mpd(data_sub, cophenetic(tree_prune))
  # Save result
  this_row <- bind_cols(Inoculant=i, mpd=mpd_sub)
  mpd_whole <- bind_rows(mpd_whole, this_row)
  
}
```

# Compare MPD

```{r}
mpd_whole <- mutate(mpd_whole, cluster=0) %>% 
  select(Inoculant, cluster, mpd)
mpd_all <- bind_rows(mpd_whole, mpd_ind) %>% 
  mutate(Inoculant = as.factor(Inoculant),
         cluster = as.factor(cluster))
```

Plot:

```{r}
mpd_all %>% 
  ggplot(aes(x=cluster, y=mpd)) +
  geom_point() +
  geom_boxplot(alpha=0.5) +
  theme_test()
```

Statistics:

Whole communities vs cluster 2:

```{r}
# Linear model
mpd_lm <- lm(mpd ~ cluster, data=mpd_all)
hist(resid(mpd_lm))
plot(predict(mpd_lm), resid(mpd_lm)) # heteroskedastic, log doesn't help

# Welch t-test
oneway.test(mpd ~ cluster, data=mpd_all, var.equal=FALSE)
```

No evidence of difference in mean pairwise distances between clusters or main community.
