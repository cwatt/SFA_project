---
title: "Untitled"
author: "Cassandra Wattenburger"
date: "3/24/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(results = "show")
knitr::opts_chunk$set(message = FALSE)
```

```{r}
# Clear working directory, load in packages, generate package info
rm(list=ls())

library("tidyverse")
library("trelliscopejs")

sessionInfo()
```

# Import data

* Normalized count data
* Taxonomy table
* Metadata

```{r}
# Count data
norm <- readRDS("../data_intermediate/SFA2_count_normalized.rds") %>% 
  pivot_longer(-SampleID, names_to="ASV", values_to="norm_abund") %>% 
  mutate(SampleID = as.double(gsub("sa", "", SampleID)))

# Taxonomy
tax <- readRDS("../data_intermediate/SFA2_taxonomy.rds") %>% 
  rownames_to_column(var="ASV")

# Metadata
meta <- read_tsv("../data_amplicon/SFA2_full/SFA2_metadata_corrected.tsv")

# Merge
norm_prep <- inner_join(norm, tax, by="ASV") %>% 
  inner_join(meta, by="SampleID") %>% 
  select(c(SampleID, Sample, Type:Replicate, Domain:Species, ASV, norm_abund)) %>% 
  mutate(Inoculant = as_factor(Inoculant),
         Replicate = as_factor(Replicate)) %>% 
  mutate(across(Domain:Species, ~as.character(.x), {.col}))

dim(norm_prep)
```

# Prepare data for estimation

Remove samples that did not contain internal standard

* These are now Inf because previous script tried to divide by 0

```{r}
norm_prep <- norm_prep[!is.infinite(norm_prep$norm_abund),]
dim(norm_prep)
```

Remove non-present taxa:

```{r}
norm_prep <- filter(norm_prep, norm_abund != 0) 
dim(norm_prep)
```

Natural log transform:

```{r}
norm_prep <- norm_prep %>% 
  mutate(ln_norm_abund_avg = log(norm_abund))
dim(norm_prep)
```

Create unique label for each ASV and time series:

```{r}
norm_prep <- norm_prep %>%
  mutate(label = paste0(Inoculant, "_", Replicate, "_", ASV))
dim(norm_prep)
```

Visualize timeseries:

* Will open in browser tab
* SLOW

```{r}

```








# PREV CODE BELOW

Average across technical replicates:

* For better coverage of time series
* All samples are destructively sampled and independent of one another, including replicates

```{r}
norm_prep <- norm_prep %>% 
  group_by(Type, Inoculant, DOC, Day, Domain, Phylum, Class, Order, Family, Genus, Species, ASV) %>% 
  summarize(norm_abund_avg = mean(norm_abund, na.rm = TRUE)) %>% 
  ungroup()

dim(norm_prep)
```

Remove taxa that didn't occur in at least four time points:

```{r}
# Identify ASVs that appeared less than 4 times in time series
occurences <- norm_prep %>% 
  group_by(ASV, Type, Inoculant) %>% 
  summarize(occurs = n()) %>% 
  filter(occurs > 3) %>% 
  ungroup()

# Filter
norm_prep <- inner_join(norm_prep, occurences, by=c("ASV", "Inoculant", "Type")) %>% 
  select(everything(), -occurs)

dim(norm_prep)
```

Natural log transform:

```{r}
norm_prep <- norm_prep %>% 
  mutate(ln_norm_abund_avg = log(norm_abund_avg))

dim(norm_prep)
```

Create unique label for each ASV and time series:

```{r}
norm_prep <- norm_prep %>%
  mutate(label = paste0(DOC, Inoculant, "_", ASV))

dim(norm_prep)
```

