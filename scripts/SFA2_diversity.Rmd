---
title: "Community composition during exponential and stationary phases"
author: "Cassandra Wattenburger"
date: "9/19/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

```{r}
# Clear working directory, load in packages, generate package info
rm(list=ls())

library("phyloseq")
library("vegan")
library("tidyverse")
library("lmerTest")
library("cowplot")

sessionInfo()
```

# Import and reformat data

* metadata
* rarefied phyloseq

```{r}
# Rarefied phyloseq
physeq <- readRDS("../data_intermediate/SFA2_physeq_rare.rds")
```

Label exponential and stationary phases:

```{r}
meta <- data.frame(sample_data(physeq))
meta_expstat <- mutate(meta, phase = if_else(Day <= 9, "exponential", "stationary"))
physeq_expstat <- phyloseq(otu_table(physeq), tax_table(physeq), physeq@phy_tree, sample_data(meta_expstat))
```

# Alpha diversity

* Each tp, each inoculant
* richness, shannon, evenness

```{r}
# Extract data from phyloseq
count_expstat <- data.frame(otu_table(physeq_expstat)) %>% 
  rownames_to_column(var="ASV") %>% 
  gather(SampleID, count, -ASV)

tax_expstat <- data.frame(tax_table(physeq_expstat))

# Combine
count_tax_meta <- inner_join(count_expstat, tax_expstat) %>% 
  inner_join(meta_expstat, by="SampleID") %>% 
  mutate(Inoculant = as_factor(Inoculant)) %>% 
  mutate(across(Domain:Species, ~as.character(.x), {.col})) %>% 
  filter(ASV != "445e8681c3c1a735760e6c394f5f4d0a") # remove spike-in
```

Calculate richness, Shannon's, evenness (J):

J = H/log(S)

Where H is Shannon-Weaver index and S is richness.

```{r}
# Reformat counts to be compatible with vegan
count_tax_meta_wide <- count_tax_meta %>% 
  select(ASV, SampleID, count) %>% 
  pivot_wider(names_from="ASV", values_from="count") %>% 
  column_to_rownames(var="SampleID")

# Calculate
shannon <- diversity(count_tax_meta_wide, "shannon")
richness <- specnumber(count_tax_meta_wide)
evenness <- shannon/log(richness)

# Add evennness values to data
even_df <- data.frame(evenness) %>% 
  rownames_to_column(var="SampleID")

alpha_df <- data.frame(richness) %>%
  rownames_to_column(var="SampleID") %>% 
  inner_join(even_df)

# Add Shannon's diversity index
alpha_df <- data.frame(shannon) %>% 
  rownames_to_column(var="SampleID") %>% 
  inner_join(alpha_df)

# Add metadata
alpha_df <- inner_join(alpha_df, meta_expstat) %>% 
  mutate(phase = as_factor(phase),
         phase = fct_relevel(phase, levels=c("pre", "post")))

# Sumarize pre and post level off
alpha_prepost <- alpha_df %>% 
  group_by(Inoculant, phase) %>% 
  summarize(richness = mean(richness, na.rm=TRUE),
            evenness = mean(evenness, na.rm=TRUE),
            shannon = mean(shannon, na.rm=TRUE))

# Summarize across replicates each day
alpha_day <- alpha_df %>% 
  group_by(Inoculant, Day, phase) %>% 
  summarize(richness = mean(richness, na.rm=TRUE),
            evenness = mean(evenness, na.rm=TRUE),
            shannon = mean(shannon, na.rm=TRUE))
```

Visualize:

```{r}
# richness
alpha_prepost %>% 
  ggplot(aes(x=phase, y=richness, color=Inoculant)) +
  geom_point() + 
  geom_line(aes(group=Inoculant)) +
  theme_test()

# Evenness
alpha_prepost %>% 
  ggplot(aes(x=phase, y=evenness, color=Inoculant)) +
  geom_point() + 
  geom_line(aes(group=Inoculant)) +
  theme_test()
```

##### Statistics

Linear mixed model with random intercepts for Inoculant (equivalent to paired t-test)

Richness:

```{r}
rich_lmer <- lmer(log(richness) ~ phase + (1|Inoculant), alpha_prepost)
hist(resid(rich_lmer))
plot(predict(rich_lmer), resid(rich_lmer))
anova(rich_lmer)
```

Evenness:

```{r}
even_lmer <- lmer(evenness ~ phase + (1|Inoculant), alpha_prepost)
hist(resid(even_lmer))
plot(predict(even_lmer), resid(even_lmer))
anova(even_lmer)
```

All data:

```{r}
# richness
alpha_day %>% 
  ggplot(aes(x=Day, y=richness, color=Inoculant)) +
  geom_point() + 
  geom_line(aes(group=Inoculant)) +
  geom_vline(xintercept = 9, linetype=2) +
  theme_test()

# Evenness
alpha_day %>% 
  ggplot(aes(x=Day, y=evenness, color=Inoculant)) +
  geom_point() + 
  geom_line(aes(group=Inoculant)) +
  geom_vline(xintercept = 9, linetype=2) +
  theme_test()
```

# Beta Diversity

```{r}
# Set seed for permutational analyses
set.seed(2)
```

## Overall (copy/paste)

NMDS ordination:

```{r}
# Graph formatting to color time points
meta_format <- data.frame(sample_data(physeq)) %>% 
  mutate(leveloff = if_else(Day >=9, "pre", "post"),
         firstlast = if_else(Day==0, "start", if_else(Day==30, "end", "between")))
physeq_format <- phyloseq(physeq@otu_table, physeq@tax_table, physeq@phy_tree, sample_data(meta_format))

# Ordinate 
# Using pcoa because no convergence with nmds
ord_pcoa <- ordinate(physeq_format, method="PCoA", distance=wuni_dist)

# Visualize
plot_ordination(physeq_format, ord_pcoa, color="Inoculant") +
  facet_wrap(~Day) +
  theme_test()

plot_ordination(physeq_format, ord_pcoa, color="firstlast") +
  facet_wrap(~Inoculant) +
  theme_test()
```

PermANOVA:

```{r}
# Overall 
adonis(wuni_dist~Inoculant*Day, data=meta, permutations=999)

# TP 0
meta_day0 <- meta %>% filter(Day==0)
physeq_day0 <- subset_samples(physeq, Day==0)
wuni_day0 <- distance(physeq_day0, method="wunifrac")
adonis(wuni_day0~Inoculant, data=meta_day0, permutations=999)

# TP 30
meta_day30 <- meta %>% filter(Day==30)
physeq_day30 <- subset_samples(physeq, Day==30)
wuni_day30 <- distance(physeq_day30, method="wunifrac")
adonis(wuni_day30~Inoculant, data=meta_day30, permutations=999)
```

```{r}
# Calculate weighted unifrac
wuni_expstat <- distance(physeq_expstat, method="wunifrac")

# Ordination
pcoa_expstat <- ordinate(physeq_expstat, method="PCoA")
plot_ordination(physeq_expstat, pcoa_expstat, color="phase") +
  facet_wrap(~Inoculant) +
  stat_ellipse(type="t") +
  theme_test()
```

### Day 0

```{r}
# Isolate day 0
physeq_day0 <- subset_samples(physeq_expstat, Day==0)

# Calculate weighted unifrac
wuni_day0 <- distance(physeq_day0, method="wunifrac")

# Ordination
pcoa_day0 <- ordinate(physeq_day0, method="PCoA")
plot_ordination(physeq_day0, pcoa_day0, color="Inoculant") +
  stat_ellipse(type="t") +
  theme_test()
```

Permanova:

```{r}
meta_day0 <- data.frame(sample_data(physeq_day0))
adonis(wuni_day0 ~ Inoculant, data=meta_day0, permutations=9999)                        
```

### Day 30

```{r}
# Isolate day 30
physeq_day30 <- subset_samples(physeq_expstat, Day==30)

# Calculate weighted unifrac
wuni_day30 <- distance(physeq_day30, method="wunifrac")

# Ordination
pcoa_day30 <- ordinate(physeq_day30, method="PCoA")
plot_ordination(physeq_day30, pcoa_day30, color="Inoculant") +
  stat_ellipse(type="t") +
  theme_test()
```

Permanova:

```{r}
meta_day30 <- data.frame(sample_data(physeq_day30))
adonis(wuni_day30 ~ Inoculant, data=meta_day30, permutations=9999)                        
```

### Day 0 vs Day 30

Can we differentiate?

```{r}
# Isolate first and final day of inubation
physeq_day030 <- subset_samples(physeq_expstat, Day==0 | Day==30)

# Calculate weighted unifrac
wuni_day030 <- distance(physeq_day030, method="wunifrac")

# PCoA ordination
pcoa_day030 <- ordinate(physeq_day030, method="PCoA")
plot_ordination(physeq_day030, pcoa_day030, color="Inoculant", shape="phase") +
  theme_test()
```

Permanova:

```{r}
meta_day030 <- data.frame(sample_data(physeq_day030))
adonis(wuni_day030 ~ Inoculant+Day+Inoculant*Day, data=meta_day030, strata=meta_day030$Inoculant, permutations = 9999)
```

### Day 10 vs day 30

Is there a change? Would indicate a dynamic community despite steady biomass.

```{r}
# Isolate beginning and last time point measured of stationary phase
physeq_stat1030 <- subset_samples(physeq_expstat, Day==10 | Day==30)

# Calculate weighted unifrac
wuni_stat1030 <- distance(physeq_stat1030, method="wunifrac")

# PCoA ordination
pcoa_stat1030 <- ordinate(physeq_stat1030, method="PCoA")
plot_ordination(physeq_stat1030, pcoa_stat1030, color="Day") +
  theme_test()
```

Statistics:

```{r}
meta_stat1030 <- data.frame(sample_data(physeq_stat1030))
adonis(wuni_stat1030 ~ Day, data=meta_stat1030, strata=meta_stat1030$Inoculant, permutations = 9999)
```

### Day 0 vs. total respiration

Did the initial community structure impact CO2 respiration? Focusing on axis 2 because of difference between inoculant 10 in both beta diversity and total respiration.

Import respiration data:

```{r}
# CO2
resp <- readRDS("../data_intermediate/SFA2_respiration.rds")

# Calculate total CO2, average per inoculant
resp_total <- resp %>% 
  group_by(Inoculant, Day) %>% 
  summarize(avg_mgco2 = mean(mgCO2)) %>% 
  ungroup() %>% 
  group_by(Inoculant) %>% 
  summarize(total_mgco2 = sum(avg_mgco2)) %>% 
  ungroup() %>% 
  filter(Inoculant != 0)
```

Isolate and average axis 2 of day 0 PCoA:

```{r}
samids_day0 <- meta_day0$SampleID

pcoa_day0_ax2 <- pcoa_day0$vectors %>% 
  as.data.frame() %>% 
  select(Axis.2) %>% 
  rownames_to_column(var="SampleID") %>%
  inner_join(meta_day0) %>% 
  group_by(Inoculant) %>% # average inoculant replicates
  summarize(mean_axis2 = mean(Axis.2))
```

Combine total respiration and axis 2:

```{r}
resp_axis2 <- inner_join(resp_total, pcoa_day0_ax2)
```

Visualize:

```{r}
resp_axis2 %>% 
  ggplot(aes(x=mean_axis2, y=total_mgco2)) +
  geom_point() +
  geom_text(aes(label=Inoculant), hjust=1.2, vjust=1.2) +
  theme_test()
```

## Effect of time on each innoculant (copy/paste)

```{r}
# Inoculant 10
meta_inoc10 <- meta %>% filter(Inoculant==10)
physeq_inoc10 <- subset_samples(physeq, Inoculant==10)
wuni_inoc10 <- distance(physeq_inoc10, method="wunifrac")
ad10 <- adonis(wuni_inoc10~Day, data=meta_inoc10, permutations=999)
p10 <- ad10$aov.tab$`Pr(>F)`[1]

# Inoculant 41
meta_inoc41 <- meta %>% filter(Inoculant==41)
physeq_inoc41 <- subset_samples(physeq, Inoculant==41)
wuni_inoc41 <- distance(physeq_inoc41, method="wunifrac")
ad41 <- adonis(wuni_inoc41~Day, data=meta_inoc41, permutations=999)
p41 <- ad41$aov.tab$`Pr(>F)`[1]

# Inoculant 12
meta_inoc12 <- meta %>% filter(Inoculant==12)
physeq_inoc12 <- subset_samples(physeq, Inoculant==12)
wuni_inoc12 <- distance(physeq_inoc12, method="wunifrac")
adonis(wuni_inoc12~Day, data=meta_inoc12, permutations=999)
ad12 <- adonis(wuni_inoc12~Day, data=meta_inoc12, permutations=999)
p12 <- ad12$aov.tab$`Pr(>F)`[1]

# Inoculant 2
meta_inoc2 <- meta %>% filter(Inoculant==2)
physeq_inoc2 <- subset_samples(physeq, Inoculant==2)
wuni_inoc2 <- distance(physeq_inoc2, method="wunifrac")
adonis(wuni_inoc2~Day, data=meta_inoc2, permutations=999)
ad2 <- adonis(wuni_inoc2~Day, data=meta_inoc2, permutations=999)
p2 <- ad2$aov.tab$`Pr(>F)`[1]

# Inoculant 19
meta_inoc19 <- meta %>% filter(Inoculant==19)
physeq_inoc19 <- subset_samples(physeq, Inoculant==19)
wuni_inoc19 <- distance(physeq_inoc19, method="wunifrac")
adonis(wuni_inoc19~Day, data=meta_inoc19, permutations=999)
ad19 <- adonis(wuni_inoc19~Day, data=meta_inoc19, permutations=999)
p19 <- ad19$aov.tab$`Pr(>F)`[1]

# Inoculant 47
meta_inoc47 <- meta %>% filter(Inoculant==47)
physeq_inoc47 <- subset_samples(physeq, Inoculant==47)
wuni_inoc47 <- distance(physeq_inoc47, method="wunifrac")
adonis(wuni_inoc47~Day, data=meta_inoc47, permutations=999)
ad47 <- adonis(wuni_inoc47~Day, data=meta_inoc47, permutations=999)
p47 <- ad47$aov.tab$`Pr(>F)`[1]

# P adjust
p.adjust(c(p10, p2, p41, p47, p12, p19), method="fdr", n=6)

```

### Beta diversity variance

Import previously generated weighted unifrac distances:

* self-comparisons already removed (slow)

```{r}
wuni_dist <- readRDS("../data_intermediate/SFA2_wunidist_slim.rds")
```

Calculate coeff. of variation for each timepoint:

```{r}
# Coefficient of variation across replicates for each time point
wuni_cv_df <- data.frame()
for (i in unique(meta_expstat$Inoculant)) {
  for (d in unique(meta_expstat[meta_expstat$Inoculant==i,]$Day)) {
    sams <- filter(meta, Inoculant==i & Day==d) 
    sams <- sams$SampleID
    wuni_sub <- filter(wuni_dist, Sample1 %in% sams & Sample2 %in% sams) # isolate reps
    wuni_cv <- (sd(wuni_sub$wuni_dist)/mean(wuni_sub$wuni_dist))*100 # calc coeff of var
    this_row <- bind_cols(Inoculant=i, Day=d, wuni_cv=wuni_cv)
    wuni_cv_df <- bind_rows(wuni_cv_df, this_row)
  }
}
wuni_cv_df <- na.omit(wuni_cv_df) %>% 
  inner_join(meta_expstat) %>%
  mutate(phase = fct_relevel(phase, c("pre", "post")))

# Average pre and post days
wuni_cv_prepost <- wuni_cv_df %>% 
  group_by(Inoculant, phase) %>%
  summarise(wuni_cv = mean(wuni_cv))
```

Visualize:

```{r}
# All time points
wuni_cv_df %>% 
  ggplot(aes(x=Day, y=wuni_cv, color=Inoculant)) + 
  geom_point() +
  facet_wrap(~Inoculant) +
  geom_line(aes(group=Inoculant)) +
  theme_test()

# Phases
wuni_cv_prepost %>% 
  ggplot(aes(x=phase, y=wuni_cv, color=Inoculant)) + 
  geom_point() +
  geom_line(aes(group=Inoculant)) +
  theme_test()
```

# Figures

Alpha diversity:

```{r}
# richness
plot1 <- alpha_prepost %>% 
  ggplot(aes(x=phase, y=richness)) +
  geom_point() + 
  geom_line(aes(group=Inoculant)) +
  theme_test() +
  theme(axis.text=element_text(size=10),
      axis.title=element_blank())
plot1

# Evenness
plot2 <- alpha_prepost %>% 
  ggplot(aes(x=phase, y=evenness)) +
  geom_point() + 
  geom_line(aes(group=Inoculant)) +
  theme_test() +
  theme(axis.text=element_text(size=10),
      axis.title=element_blank())
plot2
```

Combine:

```{r}
plot_comb12 <- plot_grid(plot1, plot2, nrow=2)
plot_comb12
```

```{r, evla=FALSE}
ggsave("../figures/supp_alpha.svg", height=120, width=90, units="mm", device="svg")
```

Beta diversity:

```{r}
plot3 <- plot_ordination(physeq_day030, pcoa_day030, color="Inoculant", shape="phase") +
  theme_test()
plot3
```

```{r, eval=FALSE}
ggsave("../figures/supp_beta.svg", height=90, width=120, units="mm", device="svg")
```



