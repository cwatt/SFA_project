---
title: "Early and late decomposition"
author: "Cassandra Wattenburger"
date: "4/13/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

```{r}
# Clear working directory, load in packages, generate package info
rm(list=ls())

library("phyloseq")
library("vegan")
library("tidyverse")
library("lmerTest")

sessionInfo()
```

# Notes

# Import data

* metadata
* growth estimates
* normalized abundances
* rarefied phyloseq

```{r}
# Metadata
meta <- readRDS("../data_intermediate/SFA2_metadata.rds")

# Growth estimates
growth <- readRDS("../data_intermediate/SFA2_growth_estimates_pap.rds")

# Death estimates
death <- readRDS("../data_intermediate/SFA2_death_estimates_pap.rds")

# Normalized abundance data
norm <- readRDS("../data_intermediate/SFA2_normalized.rds")

# Rarefied phyloseq
physeq <- readRDS("../data_intermediate/SFA2_physeq_rare.rds")
```

# Idenitfy pre and post level off

Defining as when the total normalized abundance of each inoculant evens out, indicating balanced growth and death.

### Total normalized abundances

Whole communities:

```{r}
# Add metadata and reformat
meta <- meta %>%
  select(SampleID, Sample, Inoculant, Day, Replicate)

norm_meta <- norm %>%
  full_join(meta)

# Calculate total normalized abundance through time
norm_total <- norm_meta %>% 
  group_by(Inoculant, Day, ASV) %>% 
  summarize(norm_abund_avg = mean(norm_abund, na.rm=TRUE)) %>% # average across reps
  ungroup() %>%
  group_by(Inoculant, Day) %>%
  summarize(whole = sum(norm_abund_avg, na.rm=TRUE)) %>% # calc total abund
  ungroup()

# Visualize
norm_total %>% 
  filter(Inoculant %in% c(10, 12,19, 2, 41,47)) %>% 
  ggplot(aes(x=Day, y=log(whole), color=Inoculant)) +
  geom_point() +
  geom_line() +
  labs(title="Total community normalized abundance") +
  theme_test()
```

Growers only:

```{r}
# Make a label
growth_labels <- growth %>% 
  mutate(label = paste0(Inoculant, ASV)) %>%
  select(label)

# Calculate total normalized abundance through time
norm_total_gr <- norm_meta %>% 
  mutate(label = paste0(Inoculant, ASV)) %>% 
  inner_join(growth_labels) %>% # isolate growing taxa only
  group_by(Inoculant, Day, ASV) %>% # average across replicates
  summarize(norm_abund_avg = mean(norm_abund, na.rm=TRUE)) %>% 
  ungroup() %>%
  group_by(Inoculant, Day) %>% # total normalized abundance
  summarize(growth = sum(norm_abund_avg, na.rm=TRUE)) %>%
  ungroup()

# Visualize
norm_total_gr %>% 
  ggplot(aes(x=Day, y=log(growth), color=Inoculant)) +
  geom_point() +
  geom_line() + 
  labs(title="Growing taxa total normalized abundance") +
  theme_test()
```

Together:

```{r}
# Combine whole community and growing community normalized abundance totals
norm_total_all <- norm_total %>% 
  inner_join(norm_total_gr) %>% 
  pivot_longer(-c(Inoculant, Day), names_to="type", values_to="norm_abund")

# Visualize
norm_total_all %>% 
  ggplot(aes(x=Day, y=log(norm_abund), alpha=type)) + 
  geom_point() +
  geom_line() +
  facet_wrap(~Inoculant) +
  theme_test()
```

Most abundance is made up of taxa with growth estimates after day 3 or 4, indicating we did a pretty good job of capturing the growers/major players in the bottles.

Average total abundance across inoculants:

```{r}
norm_total_all %>% 
  group_by(Day, type) %>%
  summarize(norm_abund = mean(norm_abund, na.rm=TRUE)) %>% 
  ungroup() %>% 
  #filter(type=="growth") %>% 
  mutate(type = fct_relevel(type, "whole", "growth")) %>% 
  ggplot(aes(x=Day, y=log(norm_abund))) +
  geom_point(aes(shape=type), size=3) +
  geom_line(aes(linetype=type)) +
  geom_vline(xintercept = 9, linetype=2) +
  labs(y="Total relational abundance (ln)") +
  theme_test() +
  theme(axis.title = element_text(size=20),
        axis.text = element_text(size=20))
```

Day 9 seems to be where the total abundances start to "even out". We'll define this until the end of the incubation as the plateau community.

```{r, eval=FALSE, echo=FALSE}
# For poster/presentation
plot1 <- norm_total_all %>% 
  group_by(Day, type) %>%
  summarize(norm_abund = mean(norm_abund, na.rm=TRUE)) %>% 
  ungroup() %>% 
  filter(type=="growth") %>% 
  ggplot(aes(x=Day, y=log(norm_abund))) +
  geom_point(size=3) +
  geom_line() +
  geom_vline(xintercept = 9, linetype=2) +
  labs(y="", x="") +
  theme_test() +
  theme(axis.text = element_text(size=20))

plot1

ggsave("../figures/ISME18_batchcurve.png", plot1, width=6, height=5, units = "in")
```



### Isolate pre and post 

* count data
* growth estimates by start day

```{r}
# Phyloseq object
meta_lvloff <- mutate(meta, leveloff = if_else(Day <= 9, "exponential", "stationary"))
physeq_lvloff <- phyloseq(otu_table(physeq), tax_table(physeq), physeq@phy_tree, sample_data(meta_lvloff))

# Growth start day
growth_prepost <- growth %>% 
  mutate(startend = if_else(start_day <= 9 & end_day <= 9, "exp-exp",
                            if_else(start_day <= 9 & end_day > 9, "exp-stat", "stat-stat")),
         startend = fct_relevel(startend, c("exp-exp", "exp-stat", "stat-stat")))

# Death start day
death_prepost <- death %>% 
  mutate(startend = if_else(start_day <= 9 & end_day <= 9, "exp-exp",
                            if_else(start_day <= 9 & end_day > 9, "exp-stat", "stat-stat")),
         startend = fct_relevel(startend, c("exp-exp", "exp-stat", "stat-stat")))
```

Growth summary:

```{r}
growth_prepost_summary <-  growth_prepost %>% 
  group_by(Inoculant, startend) %>% 
  summarize(num = n())

growth_prepost_summary %>% 
  group_by(startend) %>% 
  summarize(num_mean = mean(num), num_sd = sd(num))
```

Death summary:

```{r}
death_prepost_summary <-  death_prepost %>% 
  group_by(Inoculant, startend) %>% 
  summarize(num = n())

death_prepost_summary %>% 
  group_by(startend) %>% 
  summarize(num_mean = mean(num), num_sd = sd(num))
```

# Growth

### Who grew

```{r}
# Totals
growth_prepost_total <- growth_prepost %>% 
  group_by(Inoculant, startend) %>% 
  summarize(total=n()) %>% 
  ungroup()

growth_prepost_prop <- growth_prepost %>% 
  group_by(Inoculant, startend, Phylum) %>% 
  summarize(phy_total = n()) %>% 
  ungroup() %>% 
  full_join(growth_prepost_total) %>% 
  mutate(proportion = phy_total/total)

# Visualize
growth_prepost_prop %>% 
  ggplot(aes(x=proportion, y=Phylum, color=startend)) +
  geom_point() +
  facet_wrap(~startend) +
  labs(x="Proportion of growth estimates") +
  theme_test() +
  theme(panel.grid.major.y = element_line(colour="gray"),
        axis.title = element_text(size = 15),
        axis.text = element_text(size = 12),
        strip.text.x = element_text(size = 15))
```

### ASV overlap b/w inoculants

```{r}
# ASV overlap
growth_asv_overlap <- growth_prepost %>% 
  select(Inoculant, ASV, Phylum, Class, Order, Family, Genus) %>% 
  group_by(ASV, Phylum, Class, Order, Family, Genus) %>% 
  summarize(overlap = n()) %>% 
  ungroup()

# ASVs found growing in all 6 inoculants
filter(growth_asv_overlap, overlap==6)

# Genus overlap
growth_genus_overlap <- growth_prepost %>% 
  select(Inoculant, Phylum, Class, Order, Family, Genus) %>% 
  group_by(Phylum, Class, Order, Family, Genus) %>%
  unique() %>% 
  summarize(overlap = n()) %>% 
  ungroup()

# ASVs found growing in all 6 inoculants
filter(growth_genus_overlap, overlap==6)
```

Only 3 ASVs in common among all inoculants.


### Growth traits

* growth rates
* change in abundance

Visualize:

```{r}
# k
growth_prepost %>% 
  ggplot(aes(x=startend, y=k, color=startend)) +
  geom_boxplot() +
  geom_jitter(size=2) +
  theme_test() +
  labs(y="Growth rate (day-1)", x="Period of growth") +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 15))

# change in abundance
growth_prepost %>% 
  ggplot(aes(x=startend, y=log(change_abund), color=startend)) +
  geom_boxplot() +
  geom_jitter(size=2) +
  theme_test() +
  labs(y="Relational abundance change (ln)", x="Period of growth") +
  theme(axis.text = element_text(size = 10),
        axis.title = element_text(size = 12))
```

```{r}
# For poster/presentation

# growth k
grk_plot <- growth_prepost %>% 
  mutate(bin = case_when(startend=="exp-exp" ~ "Bin 1",
                         startend=="exp-stat" ~ "Bin 2",
                         startend=="stat-stat" ~ "Bin 3")) %>% 
  ggplot(aes(x=bin, y=k)) +
  geom_violin(color="#335A30") +
  geom_jitter(size=2, color="#335A30") +
  theme_test() +
  labs(y="", x="") +
  theme(axis.text = element_text(size = 20))

grk_plot

ggsave("../figures/ISME18_growthk.png", grk_plot, width=11, height=6, units="in")

# growth change abundance
grabund_plot <- growth_prepost %>% 
  mutate(bin = case_when(startend=="exp-exp" ~ "Bin 1",
                         startend=="exp-stat" ~ "Bin 2",
                         startend=="stat-stat" ~ "Bin 3")) %>% 
  ggplot(aes(x=bin, y=log(change_abund))) +
  geom_violin(color="#335A30") +
  geom_jitter(size=2, color="#335A30") +
  theme_test() +
  labs(y="", x="") +
  theme(axis.text = element_text(size = 20))

grabund_plot

ggsave("../figures/ISME18_grabund.png", grabund_plot, width=11, height=6, units="in")
```


Linear mixed effects models with random slopes and intercepts for inoculant

```{r}
# k
k_lmer <- lmer(k ~ startend + (1 + Inoculant | Inoculant), growth_prepost)
hist(resid(k_lmer))
plot(predict(k_lmer), resid(k_lmer))
anova(k_lmer)

# change abund
chg_lmer <- lmer(log(change_abund) ~ startend + (1 + Inoculant | Inoculant), growth_prepost)
hist(resid(chg_lmer))
plot(predict(chg_lmer), resid(chg_lmer))
anova(chg_lmer)

# k no steadysteady
growth_prepost_nosteady <- filter(growth_prepost, startend!="steady-steady")
k_lmer2 <- lmer(k ~ startend + (1 + Inoculant | Inoculant), growth_prepost_nosteady)
hist(resid(k_lmer2))
plot(predict(k_lmer2), resid(k_lmer2))
anova(k_lmer2)

# change abund no steadysteady
chg_lmer2 <- lmer(log(change_abund) ~ startend + (1 + Inoculant | Inoculant), growth_prepost_nosteady)
hist(resid(chg_lmer2))
plot(predict(chg_lmer2), resid(chg_lmer2))
anova(chg_lmer2)
```

### Growth correlations 

Teasing apart relationship between category and growth traits, is it due to length of growth?

Growth rate vs change abundance:

```{r}
growth_prepost %>% 
  mutate(length = end_day-start_day,
         change_abund_length = change_abund/length) %>% 
  ggplot(aes(y=log(change_abund), x=k, color=startend)) + 
  geom_point(size=2) +
  geom_smooth(method="lm", linetype=2, alpha=0.1) +
  labs(x="Growth rate (day-1)", y="Relational abundance change (ln)") +
  theme_test() +  
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 15))
```

Length of growth vs growth rates:

```{r}
growth_prepost <- growth_prepost %>% 
  mutate(length=end_day-start_day) 

growth_prepost %>% 
  ggplot(aes(x=length, y=k)) + 
  geom_point() +
  geom_smooth(method="lm", linetype=2) +
  theme_test()
```

Statistics:

* Pearson correlation

```{r}
cor.test(growth_prepost$k, growth_prepost$length, method="pearson")
```

Length of growth vs change in abundance:

```{r}
growth_prepost %>% 
  ggplot(aes(x=length, y=log(change_abund))) + 
  geom_point() +
  geom_smooth(method="lm", linetype=2) +
  theme_test()
```

Statistics:

* Pearson correlation

```{r}
cor.test(log(growth_prepost$change_abund), growth_prepost$length, method="pearson")
```

Lag vs growth rate:

```{r}
growth_prepost %>% 
  ggplot(aes(x=start_day, y=log(k))) + 
  geom_point() +
  geom_smooth(method="lm", linetype=2) +
  theme_test()
```

Lag vs change in abundance:

```{r}
growth_prepost %>% 
  ggplot(aes(x=start_day, y=log(change_abund))) + 
  geom_point() +
  geom_smooth(method="lm", linetype=2) +
  theme_test()
```

Statistics:

* Pearson correlation

```{r}
cor.test(log(growth_prepost$change_abund), growth_prepost$start_day, method="spearm")
```

### Length of growth

```{r}
growth_prepost %>% 
  ggplot(aes(x=startend, y=log(length), color=startend)) +
  geom_jitter() +
  theme_test()
```

Statistics: 

Linear mixed effects models with random slopes and intercepts for inoculant

```{r}
length_lmer <- lmer(log(length) ~ startend + (1 + Inoculant | Inoculant), growth_prepost)
hist(resid(length_lmer))
plot(predict(length_lmer), resid(length_lmer))
anova(length_lmer)
```

### 16S

```{r}
growth_prepost %>% 
  ggplot(aes(x=startend, y=log(n16S), color=startend)) +
  geom_jitter() +
  labs(y="ln n16S", x="Period of growth")
  theme_test() +
  theme(axis.text = element_text(size = 10),
        axis.title = element_text(size = 12))
```

16S x growth rates

```{r}
growth_prepost %>% 
  ggplot(aes(x=n16S, y=k)) +
  geom_point() +
  geom_smooth(method="lm") +
  labs(x="Predicted 16S copy number", y="Growth rate (day-1)") +
  theme_test() +
  theme(axis.text = element_text(size = 10),
        axis.title = element_text(size = 12))
```

16S x change abundance

```{r}
growth_prepost %>% 
  ggplot(aes(x=n16S, y=log(change_abund))) +
  geom_point() +
  geom_smooth(method="lm") +
  labs(x="Predicted 16S copy number", y="ln Change relational abundance") +
  theme_test() +
  theme(axis.text = element_text(size = 10),
        axis.title = element_text(size = 12))
```

Statistics:

Linear mixed effects

```{r}
n16S_lmer <- lmer(log(n16S) ~ startend + (1 + Inoculant | Inoculant), growth_prepost)
hist(resid(n16S_lmer))
plot(predict(n16S_lmer), resid(n16S_lmer))
anova(n16S_lmer)
```

Correlations

```{r}
cor.test(growth_prepost$n16S, log(growth_prepost$change_abund), method="pearson")
cor.test(growth_prepost$n16S, growth_prepost$k, method="pearson")
```

# Death

### Who died

```{r}
# Totals
death_prepost_total <- death_prepost %>% 
  group_by(Inoculant, startend) %>% 
  summarize(total=n()) %>% 
  ungroup()

death_prepost_prop <- death_prepost %>% 
  group_by(Inoculant, startend, Phylum) %>% 
  summarize(phy_total = n()) %>% 
  ungroup() %>% 
  full_join(death_prepost_total) %>% 
  mutate(proportion = phy_total/total)

# Visualize
death_prepost_prop %>% 
  ggplot(aes(x=proportion, y=Phylum, color=startend)) +
  geom_point() +
  facet_wrap(~startend) +
  labs(x="Proportion of death estimates") +
  theme_test() +
  theme(panel.grid.major.y = element_line(colour="gray"),
        axis.title = element_text(size = 15),
        axis.text = element_text(size = 12),
        strip.text.x = element_text(size = 15))
```

### ASV overlap b/w inoculants

```{r}
# ASV overlap
death_asv_overlap <- death_prepost %>% 
  select(Inoculant, ASV, Phylum, Class, Order, Family, Genus) %>% 
  group_by(ASV, Phylum, Class, Order, Family, Genus) %>% 
  summarize(overlap = n()) %>% 
  ungroup()

# ASVs found growing in all 6 inoculants
filter(death_asv_overlap, overlap==6)

# Genus overlap
death_genus_overlap <- death_prepost %>% 
  select(Inoculant, Phylum, Class, Order, Family, Genus) %>% 
  group_by(Phylum, Class, Order, Family, Genus) %>%
  unique() %>% 
  summarize(overlap = n()) %>% 
  ungroup()

# ASVs found growing in all 6 inoculants
filter(death_genus_overlap, overlap==6)
```

### Death traits

Visualize:

```{r}
# k
death_prepost %>% 
  ggplot(aes(x=startend, y=k, color=startend)) +
  geom_jitter() +
  theme_test() +
  labs(y="Death rate (day-1)", x="Period of death") +
  theme(axis.text = element_text(size = 10),
        axis.title = element_text(size = 12))

# change in abundance
death_prepost %>% 
  ggplot(aes(x=startend, y=log(abs(change_abund)), color=startend)) +
  geom_boxplot() +
  geom_jitter(size=2) +
  theme_test() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 15)) +
  labs(y="Relational abundance change (ln abs. value)", x="Period of death")
```

```{r, eval=FALSE}
# For poster/presentation

# death k
dek_plot <- death_prepost %>% 
  mutate(bin = case_when(startend=="exp-exp" ~ "Bin 1",
                         startend=="exp-stat" ~ "Bin 2",
                         startend=="stat-stat" ~ "Bin 3")) %>% 
  ggplot(aes(x=bin, y=k)) +
  geom_violin(color="#94221F") +
  geom_jitter(size=2, color="#94221F") +
  theme_test() +
  labs(y="", x="") +
  theme(axis.text = element_text(size = 20))

dek_plot

ggsave("../figures/ISME18_deathk.png", dek_plot, width=11, height=6, units="in")

# death change abundance
deabund_plot <- death_prepost %>% 
  mutate(bin = case_when(startend=="exp-exp" ~ "Bin 1",
                         startend=="exp-stat" ~ "Bin 2",
                         startend=="stat-stat" ~ "Bin 3")) %>% 
  ggplot(aes(x=bin, y=log(abs(change_abund)))) +
  geom_violin(color="#94221F") +
  geom_jitter(size=2, color="#94221F") +
  theme_test() +
  labs(y="", x="") +
  theme(axis.text = element_text(size = 20))

deabund_plot

ggsave("../figures/ISME18_deabund.png", deabund_plot, width=11, height=6, units="in")
```


### Death statistics 

Linear mixed effects models with random slopes and intercepts for inoculant

```{r}
# k
kdeath_lmer <- lmer(log(abs(k)) ~ startend + (1 + Inoculant | Inoculant), death_prepost)
hist(resid(kdeath_lmer))
plot(predict(kdeath_lmer), resid(kdeath_lmer))
anova(kdeath_lmer)

# change abund
chgdeath_lmer <- lmer(log(abs(change_abund)) ~ startend + (1 + Inoculant | Inoculant), death_prepost)
hist(resid(chgdeath_lmer))
plot(predict(chgdeath_lmer), resid(chgdeath_lmer))
anova(chgdeath_lmer)
```

# Community comparisons

### Alpha diversity

* at each tp, each inoc
* richness, shannon, evenness

```{r}
# Extract data from phyloseq
count_lvloff <- data.frame(otu_table(physeq_lvloff)) %>% 
  rownames_to_column(var="ASV") %>% 
  gather(SampleID, count, -ASV)

tax_lvloff <- data.frame(tax_table(physeq_lvloff))

# Combine
count_tax_meta <- inner_join(count_lvloff, tax_lvloff) %>% 
  inner_join(meta_lvloff, by="SampleID") %>% 
  mutate(Inoculant = as_factor(Inoculant)) %>% 
  mutate(across(Domain:Species, ~as.character(.x), {.col})) %>% 
  filter(ASV != "445e8681c3c1a735760e6c394f5f4d0a") # remove spike-in
```

Calculate richness, Shannon's, evenness (J):

J = H/log(S)

Where H is Shannon-Weaver index and S is richness.

```{r}
# Reformat counts to be compatible with vegan
count_tax_meta_wide <- count_tax_meta %>% 
  select(ASV, SampleID, count) %>% 
  pivot_wider(names_from="ASV", values_from="count") %>% 
  column_to_rownames(var="SampleID")

# Calculate
shannon <- diversity(count_tax_meta_wide, "shannon")
richness <- specnumber(count_tax_meta_wide)
evenness <- shannon/log(richness)

# Add evennness values to data
even_df <- data.frame(evenness) %>% 
  rownames_to_column(var="SampleID")

alpha_df <- data.frame(richness) %>%
  rownames_to_column(var="SampleID") %>% 
  inner_join(even_df)

# Add Shannon's diversity index
alpha_df <- data.frame(shannon) %>% 
  rownames_to_column(var="SampleID") %>% 
  inner_join(alpha_df)

# Add metadata
alpha_df <- inner_join(alpha_df, meta_lvloff) %>% 
  mutate(leveloff = as_factor(leveloff),
         leveloff = fct_relevel(leveloff, levels=c("pre", "post")))

# Sumarize pre and post level off
alpha_prepost <- alpha_df %>% 
  group_by(Inoculant, leveloff) %>% 
  summarize(richness = mean(richness, na.rm=TRUE),
            evenness = mean(evenness, na.rm=TRUE),
            shannon = mean(shannon, na.rm=TRUE))

# Summarize across replicates each day
alpha_day <- alpha_df %>% 
  group_by(Inoculant, Day, leveloff) %>% 
  summarize(richness = mean(richness, na.rm=TRUE),
            evenness = mean(evenness, na.rm=TRUE),
            shannon = mean(shannon, na.rm=TRUE))
```

Visualize:

Summary

```{r}
# richness
alpha_prepost %>% 
  ggplot(aes(x=leveloff, y=richness, color=Inoculant)) +
  geom_point() + 
  geom_line(aes(group=Inoculant)) +
  theme_test()

# Evenness
alpha_prepost %>% 
  ggplot(aes(x=leveloff, y=evenness, color=Inoculant)) +
  geom_point() + 
  geom_line(aes(group=Inoculant)) +
  theme_test()
```

##### Statistics

Linear mixed model with random intercepts for Inoculant (equivalent to paired t-test)

Richness:

# BOOKMARK

```{r}
rich_lmer <- lmer(log(richness) ~ leveloff + (1|Inoculant), alpha_prepost)
hist(resid(rich_lmer))
plot(predict(rich_lmer), resid(rich_lmer))
anova(rich_lmer)
```

Evenness:

```{r}
even_lmer <- lmer(evenness ~ leveloff + (1|Inoculant), alpha_prepost)
hist(resid(even_lmer))
plot(predict(even_lmer), resid(even_lmer))
anova(even_lmer)
```

All data:

```{r}
# richness
alpha_day %>% 
  ggplot(aes(x=Day, y=richness, color=Inoculant)) +
  geom_point() + 
  geom_line(aes(group=Inoculant)) +
  geom_vline(xintercept = 9, linetype=2) +
  theme_test()

# Evenness
alpha_day %>% 
  ggplot(aes(x=Day, y=evenness, color=Inoculant)) +
  geom_point() + 
  geom_line(aes(group=Inoculant)) +
  geom_vline(xintercept = 9, linetype=2) +
  theme_test()
```

### Beta diversity variance

Import previously generated weighted unifrac distances:

* self-comparisons already removed (slow)

```{r}
wuni_dist <- readRDS("../data_intermediate/SFA2_wunidist_slim.rds")
```

Calculate coeff. of variation for each timepoint:

```{r}
# Coefficient of variation across replicates for each time point
wuni_cv_df <- data.frame()
for (i in unique(meta_lvloff$Inoculant)) {
  for (d in unique(meta_lvloff[meta_lvloff$Inoculant==i,]$Day)) {
    sams <- filter(meta, Inoculant==i & Day==d) 
    sams <- sams$SampleID
    wuni_sub <- filter(wuni_dist, Sample1 %in% sams & Sample2 %in% sams) # isolate reps
    wuni_cv <- (sd(wuni_sub$wuni_dist)/mean(wuni_sub$wuni_dist))*100 # calc coeff of var
    this_row <- bind_cols(Inoculant=i, Day=d, wuni_cv=wuni_cv)
    wuni_cv_df <- bind_rows(wuni_cv_df, this_row)
  }
}
wuni_cv_df <- na.omit(wuni_cv_df) %>% 
  inner_join(meta_lvloff) %>%
  mutate(leveloff = fct_relevel(leveloff, c("pre", "post")))

# Average pre and post days
wuni_cv_prepost <- wuni_cv_df %>% 
  group_by(Inoculant, leveloff) %>%
  summarise(wuni_cv = mean(wuni_cv))
```

Visualize:

```{r}
# Pre and post average
wuni_cv_prepost %>% 
  ggplot(aes(x=leveloff, y=wuni_cv, color=Inoculant)) + 
  geom_point() +
  geom_line(aes(group=Inoculant)) +
  theme_test()
```

##### Statistics

```{r}
wunicv_lmer <- lmer(wuni_cv ~ Inoculant + (1|Inoculant), wuni_cv_prepost)
hist(resid(wunicv_lmer))
plot(predict(wunicv_lmer), resid(wunicv_lmer))
anova(wunicv_lmer)
```






OUTLINE

* define pre and post level-off in phyloseq object, in growth estimates via start day
* assess richness, evenness
* compare growth rates/other characteristics
* compare variability of beta diversity across time