---
title: "Climax community"
author: "Cassandra Wattenburger"
date: "4/13/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

```{r}
# Clear working directory, load in packages, generate package info
rm(list=ls())

library("tidyverse")
library("lmerTest")

sessionInfo()
```

# Notes

# Import data

* metadata
* growth estimates
* normalized abundances
* rarefied phyloseq

```{r}
# Metadata
meta <- readRDS("../data_intermediate/SFA2_metadata.rds")

# Growth estimates
growth <- readRDS("../data_intermediate/SFA2_growth_estimates_pap.rds")

# Death estimates
death <- readRDS("../data_intermediate/SFA2_death_estimates_pap.rds")

# Normalized abundance data
norm <- readRDS("../data_intermediate/SFA2_normalized.rds")

# Rarefied phyloseq
physeq <- readRDS("../data_intermediate/SFA2_physeq_rare.rds")
```

# Idenitfy pre and post level off

Defining as when the total normalized abundance of each inoculant evens out, indicating balanced growth and death.

### Total normalized abundances

Whole communities:

```{r}
# Add metadata and reformat
meta <- meta %>%
  select(SampleID, Sample, Inoculant, Day, Replicate)

norm_meta <- norm %>%
  full_join(meta)

# Calculate total normalized abundance through time
norm_total <- norm_meta %>% 
  group_by(Inoculant, Day, ASV) %>% 
  summarize(norm_abund_avg = mean(norm_abund, na.rm=TRUE)) %>% # average across reps
  ungroup() %>%
  group_by(Inoculant, Day) %>%
  summarize(whole = sum(norm_abund_avg, na.rm=TRUE)) %>% # calc total abund
  ungroup()

# Visualize
norm_total %>% 
  filter(Inoculant %in% c(10, 12,19, 2, 41,47)) %>% 
  ggplot(aes(x=Day, y=log(whole), color=Inoculant)) +
  geom_point() +
  geom_line() +
  labs(title="Total community normalized abundance") +
  theme_test()
```

Growers only:

```{r}
# Make a label
growth_labels <- growth %>% 
  mutate(label = paste0(Inoculant, ASV)) %>%
  select(label)

# Calculate total normalized abundance through time
norm_total_gr <- norm_meta %>% 
  mutate(label = paste0(Inoculant, ASV)) %>% 
  inner_join(growth_labels) %>% # isolate growing taxa only
  group_by(Inoculant, Day, ASV) %>% # average across replicates
  summarize(norm_abund_avg = mean(norm_abund, na.rm=TRUE)) %>% 
  ungroup() %>%
  group_by(Inoculant, Day) %>% # total normalized abundance
  summarize(growth = sum(norm_abund_avg, na.rm=TRUE)) %>%
  ungroup()

# Visualize
norm_total_gr %>% 
  ggplot(aes(x=Day, y=log(growth), color=Inoculant)) +
  geom_point() +
  geom_line() + 
  labs(title="Growing taxa total normalized abundance") +
  theme_test()
```

Together:

```{r}
# Combine whole community and growing community normalized abundance totals
norm_total_all <- norm_total %>% 
  inner_join(norm_total_gr) %>% 
  pivot_longer(-c(Inoculant, Day), names_to="type", values_to="norm_abund")

# Visualize
norm_total_all %>% 
  ggplot(aes(x=Day, y=log(norm_abund), alpha=type)) + 
  geom_point() +
  geom_line() +
  facet_wrap(~Inoculant) +
  theme_test()
```

Most abundance is made up of taxa with growth estimates after day 3 or 4, indicating we did a pretty good job of capturing the growers/major players in the bottles.

Average total abundance across inoculants:

```{r}
norm_total_all %>% 
  group_by(Day, type) %>%
  summarize(norm_abund = mean(norm_abund, na.rm=TRUE)) %>% 
  ungroup() %>% 
  ggplot(aes(x=Day, y=log(norm_abund))) +
  geom_point(aes(shape=type)) +
  geom_line(aes(linetype=type)) +
  geom_vline(xintercept = 9, linetype=2) +
  theme_test()
```

Day 9 seems to be where the total abundances start to "even out". We'll define this until the end of the incubation as the plateau community.

### Isolate pre and post 

* count data
* growth estimates by start day

```{r}
# Phyloseq object
meta_lvloff <- mutate(meta, leveloff = if_else(Day <= 9, "pre", "post"))
physeq_lvloff <- phyloseq(otu_table(physeq), tax_table(physeq), physeq@phy_tree, sample_data(meta_lvloff))

# Growth start day
growth_prepost <- growth %>% 
  mutate(startend = if_else(start_day <= 9 & end_day <= 9, "prepre",
                            if_else(start_day <= 9 & end_day > 9, "prepost", "postpost")),
         startend = fct_relevel(startend, c("prepre", "prepost", "postpost")))

# Death start day
death_prepost <- death %>% 
  mutate(startend = if_else(start_day <= 9 & end_day <= 9, "prepre",
                            if_else(start_day <= 9 & end_day > 9, "prepost", "postpost")),
         startend = fct_relevel(startend, c("prepre", "prepost", "postpost")))
```

Growth summary:

```{r}
growth_prepost_summary <-  growth_prepost %>% 
  group_by(Inoculant, startend) %>% 
  summarize(num = n())

growth_prepost_summary %>% 
  group_by(startend) %>% 
  summarize(num_mean = mean(num), num_sd = sd(num))
```

Death summary:

```{r}
death_prepost_summary <-  death_prepost %>% 
  group_by(Inoculant, startend) %>% 
  summarize(num = n())

death_prepost_summary %>% 
  group_by(startend) %>% 
  summarize(num_mean = mean(num), num_sd = sd(num))
```

# Growth

### Growth traits

* growth rates
* change in abundance

Visualize:

```{r}
# k
growth_prepost %>% 
  ggplot(aes(x=startend, y=k, color=startend)) +
  geom_jitter() +
  theme_test()

# change in abundance
growth_prepost %>% 
  ggplot(aes(x=startend, y=log(change_abund), color=startend)) +
  geom_jitter() +
  theme_test()
```

Linear mixed effects models with random slopes and intercepts for inoculant

```{r}
# k
k_lmer <- lmer(k ~ startend + (1 + Inoculant | Inoculant), growth_prepost)
hist(resid(k_lmer))
plot(predict(k_lmer), resid(k_lmer))
anova(k_lmer)

# change abund
chg_lmer <- lmer(log(change_abund) ~ startend + (1 + Inoculant | Inoculant), growth_prepost)
hist(resid(chg_lmer))
plot(predict(chg_lmer), resid(chg_lmer))
anova(chg_lmer)
```

### Growth correlations 

Teasing apart relationship between category and growth traits, is it due to length of growth?

Length of growth vs growth rates:

```{r}
growth_prepost <- growth_prepost %>% 
  mutate(length=end_day-start_day) 

growth_prepost %>% 
  ggplot(aes(x=length, y=k)) + 
  geom_point() +
  geom_smooth(method="lm", linetype=2) +
  theme_test()
```

Statistics:

* Pearson correlation

```{r}
cor.test(growth_prepost$k, growth_prepost$length, method="pearson")
```

Length of growth vs change in abundance:

```{r}
growth_prepost %>% 
  ggplot(aes(x=length, y=log(change_abund))) + 
  geom_point() +
  geom_smooth(method="lm", linetype=2) +
  theme_test()
```

Statistics:

* Pearson correlation

```{r}
cor.test(log(growth_prepost$change_abund), growth_prepost$length, method="pearson")
```

Lag vs growth rate:

```{r}
growth_prepost %>% 
  ggplot(aes(x=start_day, y=log(k))) + 
  geom_point() +
  geom_smooth(method="lm", linetype=2) +
  theme_test()
```

Lag vs change in abundance:

```{r}
growth_prepost %>% 
  ggplot(aes(x=start_day, y=log(change_abund))) + 
  geom_point() +
  geom_smooth(method="lm", linetype=2) +
  theme_test()
```

Statistics:

* Pearson correlation

```{r}
cor.test(log(growth_prepost$change_abund), growth_prepost$start_day, method="spearm")
```

### Length of growth

```{r}
growth_prepost %>% 
  ggplot(aes(x=startend, y=log(length), color=startend)) +
  geom_jitter() +
  theme_test()
```

Statistics: 

Linear mixed effects models with random slopes and intercepts for inoculant

```{r}
length_lmer <- lmer(log(length) ~ startend + (1 + Inoculant | Inoculant), growth_prepost)
hist(resid(length_lmer))
plot(predict(length_lmer), resid(length_lmer))
anova(length_lmer)
```

### 16S

```{r}
growth_prepost %>% 
  ggplot(aes(x=startend, y=log(n16S), color=startend)) +
  geom_jitter() +
  theme_test()
```

Statistics:

Linear mixed effects

```{r}
n16S_lmer <- lmer(log(n16S) ~ startend + (1 + Inoculant | Inoculant), growth_prepost)
hist(resid(n16S_lmer))
plot(predict(n16S_lmer), resid(n16S_lmer))
anova(n16S_lmer)
```


Statistics:

```{r}

```


# Death

Death visualize:

```{r}
# k
death_prepost %>% 
  ggplot(aes(x=startend, y=k, color=startend)) +
  geom_jitter() +
  theme_test()

# change in abundance
death_prepost %>% 
  ggplot(aes(x=startend, y=log(abs(change_abund)), color=startend)) +
  geom_jitter() +
  theme_test()
```

### Death statistics 

Linear mixed effects models with random slopes and intercepts for inoculant

```{r}
# k
kdeath_lmer <- lmer(log(abs(k)) ~ startend + (1 + Inoculant | Inoculant), death_prepost)
hist(resid(kdeath_lmer))
plot(predict(kdeath_lmer), resid(kdeath_lmer))
anova(kdeath_lmer)

# change abund
chgdeath_lmer <- lmer(log(abs(change_abund)) ~ startend + (1 + Inoculant | Inoculant), death_prepost)
hist(resid(chgdeath_lmer))
plot(predict(chgdeath_lmer), resid(chgdeath_lmer))
anova(chgdeath_lmer)
```


# Community comparisons

### Alpha diversity

* at each tp, each inoc
* richness, shannon, evenness

```{r}
# Extract data from phyloseq
count_lvloff <- data.frame(otu_table(physeq_lvloff)) %>% 
  rownames_to_column(var="ASV") %>% 
  gather(SampleID, count, -ASV)

tax_lvloff <- data.frame(tax_table(physeq_lvloff))

# Combine
count_tax_meta <- inner_join(count_lvloff, tax_lvloff) %>% 
  inner_join(meta_lvloff, by="SampleID") %>% 
  mutate(Inoculant = as_factor(Inoculant)) %>% 
  mutate(across(Domain:Species, ~as.character(.x), {.col})) %>% 
  filter(ASV != "445e8681c3c1a735760e6c394f5f4d0a") # remove spike-in
```

Calculate richness, Shannon's, evenness (J):

J = H/log(S)

Where H is Shannon-Weaver index and S is richness.

```{r}
# Reformat counts to be compatible with vegan
count_tax_meta_wide <- count_tax_meta %>% 
  select(ASV, SampleID, count) %>% 
  pivot_wider(names_from="ASV", values_from="count") %>% 
  column_to_rownames(var="SampleID")

# Calculate
shannon <- diversity(count_tax_meta_wide, "shannon")
richness <- specnumber(count_tax_meta_wide)
evenness <- shannon/log(richness)

# Add evennness values to data
even_df <- data.frame(evenness) %>% 
  rownames_to_column(var="SampleID")

alpha_df <- data.frame(richness) %>%
  rownames_to_column(var="SampleID") %>% 
  inner_join(even_df)

# Add Shannon's diversity index
alpha_df <- data.frame(shannon) %>% 
  rownames_to_column(var="SampleID") %>% 
  inner_join(alpha_df)

# Add metadata
alpha_df <- inner_join(alpha_df, meta_lvloff) %>% 
  mutate(leveloff = as_factor(leveloff),
         leveloff = fct_relevel(leveloff, levels=c("pre", "post")))

# Sumarize pre and post level off
alpha_prepost <- alpha_df %>% 
  group_by(Inoculant, leveloff) %>% 
  summarize(richness = mean(richness, na.rm=TRUE),
            evenness = mean(evenness, na.rm=TRUE),
            shannon = mean(shannon, na.rm=TRUE))

# Summarize across replicates each day
alpha_day <- alpha_df %>% 
  group_by(Inoculant, Day, leveloff) %>% 
  summarize(richness = mean(richness, na.rm=TRUE),
            evenness = mean(evenness, na.rm=TRUE),
            shannon = mean(shannon, na.rm=TRUE))
```

Visualize:

Summary

```{r}
# richness
alpha_prepost %>% 
  ggplot(aes(x=leveloff, y=richness, color=Inoculant)) +
  geom_point() + 
  geom_line(aes(group=Inoculant)) +
  theme_test()

# Evenness
alpha_prepost %>% 
  ggplot(aes(x=leveloff, y=evenness, color=Inoculant)) +
  geom_point() + 
  geom_line(aes(group=Inoculant)) +
  theme_test()
```

##### Statistics

Linear mixed model with random intercepts for Inoculant (equivalent to paired t-test)

Richness:

# BOOKMARK

```{r}
rich_lmer <- lmer(log(richness) ~ leveloff + (1|Inoculant), alpha_prepost)
hist(resid(rich_lmer))
plot(predict(rich_lmer), resid(rich_lmer))
anova(rich_lmer)
```

Evenness:

```{r}
even_lmer <- lmer(evenness ~ leveloff + (1|Inoculant), alpha_prepost)
hist(resid(even_lmer))
plot(predict(even_lmer), resid(even_lmer))
anova(even_lmer)
```

All data:

```{r}
# richness
alpha_day %>% 
  ggplot(aes(x=Day, y=richness, color=Inoculant)) +
  geom_point() + 
  geom_line(aes(group=Inoculant)) +
  geom_vline(xintercept = 9, linetype=2) +
  theme_test()

# Evenness
alpha_day %>% 
  ggplot(aes(x=Day, y=evenness, color=Inoculant)) +
  geom_point() + 
  geom_line(aes(group=Inoculant)) +
  geom_vline(xintercept = 9, linetype=2) +
  theme_test()
```

### Beta diversity variance

Import previously generated weighted unifrac distances:

* self-comparisons already removed (slow)

```{r}
wuni_dist <- readRDS("../data_intermediate/SFA2_wunidist_slim.rds")
```

Calculate coeff. of variation for each timepoint:

```{r}
# Coefficient of variation across replicates for each time point
wuni_cv_df <- data.frame()
for (i in unique(meta_lvloff$Inoculant)) {
  for (d in unique(meta_lvloff[meta_lvloff$Inoculant==i,]$Day)) {
    sams <- filter(meta, Inoculant==i & Day==d) 
    sams <- sams$SampleID
    wuni_sub <- filter(wuni_dist, Sample1 %in% sams & Sample2 %in% sams) # isolate reps
    wuni_cv <- (sd(wuni_sub$wuni_dist)/mean(wuni_sub$wuni_dist))*100 # calc coeff of var
    this_row <- bind_cols(Inoculant=i, Day=d, wuni_cv=wuni_cv)
    wuni_cv_df <- bind_rows(wuni_cv_df, this_row)
  }
}
wuni_cv_df <- na.omit(wuni_cv_df) %>% 
  inner_join(meta_lvloff) %>%
  mutate(leveloff = fct_relevel(leveloff, c("pre", "post")))

# Average pre and post days
wuni_cv_prepost <- wuni_cv_df %>% 
  group_by(Inoculant, leveloff) %>%
  summarise(wuni_cv = mean(wuni_cv))
```

Visualize:

```{r}
# Pre and post average
wuni_cv_prepost %>% 
  ggplot(aes(x=leveloff, y=wuni_cv, color=Inoculant)) + 
  geom_point() +
  geom_line(aes(group=Inoculant)) +
  theme_test()
```

##### Statistics

```{r}
wunicv_lmer <- lmer(wuni_cv ~ Inoculant + (1|Inoculant), wuni_cv_prepost)
hist(resid(wunicv_lmer))
plot(predict(wunicv_lmer), resid(wunicv_lmer))
anova(wunicv_lmer)
```






OUTLINE

* define pre and post level-off in phyloseq object, in growth estimates via start day
* assess richness, evenness
* compare growth rates/other characteristics
* compare variability of beta diversity across time